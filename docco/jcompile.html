<!DOCTYPE html>

<html>
<head>
  <title>jcompile.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="asm-llvm.html">
                asm-llvm.js
              </a>
            
              
              <a class="source" href="bcompile.html">
                bcompile.js
              </a>
            
              
              <a class="source" href="binterp.html">
                binterp.js
              </a>
            
              
              <a class="source" href="browsercanvas.html">
                browsercanvas.js
              </a>
            
              
              <a class="source" href="bytecode-table.html">
                bytecode-table.js
              </a>
            
              
              <a class="source" href="canvastest.html">
                canvastest.js
              </a>
            
              
              <a class="source" href="ccanvas.html">
                ccanvas.js
              </a>
            
              
              <a class="source" href="crender-styles.html">
                crender-styles.js
              </a>
            
              
              <a class="source" href="crender.html">
                crender.js
              </a>
            
              
              <a class="source" href="ctiles.html">
                ctiles.js
              </a>
            
              
              <a class="source" href="events.html">
                events.js
              </a>
            
              
              <a class="source" href="eventtests.html">
                eventtests.js
              </a>
            
              
              <a class="source" href="extensions.html">
                extensions.js
              </a>
            
              
              <a class="source" href="global-es5.html">
                global-es5.js
              </a>
            
              
              <a class="source" href="global.html">
                global.js
              </a>
            
              
              <a class="source" href="html-escape.html">
                html-escape.js
              </a>
            
              
              <a class="source" href="jcompile.html">
                jcompile.js
              </a>
            
              
              <a class="source" href="json2.html">
                json2.js
              </a>
            
              
              <a class="source" href="nodemain.html">
                nodemain.js
              </a>
            
              
              <a class="source" href="parse.html">
                parse.js
              </a>
            
              
              <a class="source" href="render.html">
                render.js
              </a>
            
              
              <a class="source" href="render2.html">
                render2.js
              </a>
            
              
              <a class="source" href="require.html">
                require.js
              </a>
            
              
              <a class="source" href="stdlib.html">
                stdlib.js
              </a>
            
              
              <a class="source" href="str-escape.html">
                str-escape.js
              </a>
            
              
              <a class="source" href="tdop.html">
                tdop.js
              </a>
            
              
              <a class="source" href="tests.html">
                tests.js
              </a>
            
              
              <a class="source" href="text.html">
                text.js
              </a>
            
              
              <a class="source" href="tiles.html">
                tiles.js
              </a>
            
              
              <a class="source" href="tokenize.html">
                tokenize.js
              </a>
            
              
              <a class="source" href="top-level.html">
                top-level.js
              </a>
            
              
              <a class="source" href="ts.html">
                ts.js
              </a>
            
              
              <a class="source" href="write-lua-bytecode.html">
                write-lua-bytecode.js
              </a>
            
              
              <a class="source" href="write-lua-ops.html">
                write-lua-ops.js
              </a>
            
              
              <a class="source" href="write-php-bytecode.html">
                write-php-bytecode.js
              </a>
            
              
              <a class="source" href="write-php-ops.html">
                write-php-ops.js
              </a>
            
              
              <a class="source" href="write-rust-bytecode.html">
                write-rust-bytecode.js
              </a>
            
              
              <a class="source" href="write-rust-ops.html">
                write-rust-ops.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="jcompilejs">jcompile.js</h1>
<p>Pretty-printer for parsed Simplified JavaScript,
written in Simplified JavaScript.</p>
<p>This is also a &quot;compiler&quot; for our parse tree to a form which can be
&#39;eval&#39;ed and run natively in the browser JavaScript engine.  At the
moment we&#39;re not doing any transforms, so it&#39;s not a very interesting
compiler.</p>
<p>C. Scott Ananian
2010-07-02ish</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>define([<span class="hljs-string">"text!jcompile.js"</span>,<span class="hljs-string">"str-escape"</span>], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make_jcompile</span>(<span class="hljs-params">jcompile_source,str_escape</span>) </span>{
    <span class="hljs-keyword">var</span> jcompile, jcompile_stmt, jcompile_stmts;
    <span class="hljs-keyword">var</span> indentation, prec_stack = [ <span class="hljs-number">0</span> ];

    <span class="hljs-keyword">var</span> assert = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">b, obj</span>) </span>{
        <span class="hljs-keyword">if</span> (!b) { <span class="hljs-built_in">console</span>.assert(b, <span class="hljs-string">"Assertion failure"</span>, obj); }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>helper function for delimiter-joined lists</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> gather = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">lst, delim, f</span>) </span>{
        <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, result = [];
        <span class="hljs-keyword">while</span> ( i &lt; lst.length ) {
            result.push(f(lst[i]));
            i += <span class="hljs-number">1</span>;
        }
        <span class="hljs-keyword">return</span> result.join(delim);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>indentation level</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> nl = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> n = indentation, result = <span class="hljs-string">"\n"</span>;
        <span class="hljs-keyword">while</span> (n &gt; <span class="hljs-number">0</span>) {
            result += <span class="hljs-string">"  "</span>;
            n -= <span class="hljs-number">1</span>;
        }
        <span class="hljs-keyword">return</span> result;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>set the precedence to &#39;prec&#39; when evaluating f</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> with_prec = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">prec, f, obj</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> result;
            prec_stack.push(prec);
            result = f.apply(obj || <span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
            prec_stack.pop();
            <span class="hljs-keyword">return</span> result;
        };
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>set the precedence, and parenthesize the result if appropriate.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> with_prec_paren = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">prec, f, obj</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> prev_prec = prec_stack[prec_stack.length - <span class="hljs-number">1</span>];
            <span class="hljs-keyword">var</span> result = with_prec(prec, f).apply(obj || <span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
            <span class="hljs-keyword">if</span> (prev_prec &gt; prec) { result = <span class="hljs-string">"("</span> + result + <span class="hljs-string">")"</span>; }
            <span class="hljs-keyword">return</span> result;
        };
    };

    <span class="hljs-keyword">var</span> dispatch = {};
    dispatch.name = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.value+<span class="hljs-string">"/*"</span>+<span class="hljs-keyword">this</span>.scope.level+<span class="hljs-string">"*/"</span>;
    };
    dispatch.literal = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.value === <span class="hljs-literal">undefined</span>) { <span class="hljs-keyword">return</span> <span class="hljs-string">"undefined"</span>; }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.value === <span class="hljs-literal">null</span>) { <span class="hljs-keyword">return</span> <span class="hljs-string">"null"</span>; }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">this</span>.value)===<span class="hljs-string">'object'</span>) {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.value.length === <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span> <span class="hljs-string">"Array"</span>; }
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Object"</span>;
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">this</span>.value)===<span class="hljs-string">'string'</span>) { <span class="hljs-keyword">return</span> str_escape(<span class="hljs-keyword">this</span>.value); }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.value.toString();
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>UNARY ASTs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch.unary = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        assert(dispatch.unary[<span class="hljs-keyword">this</span>.value], <span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> dispatch.unary[<span class="hljs-keyword">this</span>.value].apply(<span class="hljs-keyword">this</span>);
    };
    <span class="hljs-keyword">var</span> unary = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">op, prec, f</span>) </span>{
        dispatch.unary[op] = f || with_prec_paren(prec, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.value + jcompile(<span class="hljs-keyword">this</span>.first);
            });
    };
    unary(<span class="hljs-string">'!'</span>, <span class="hljs-number">70</span>);
    unary(<span class="hljs-string">'-'</span>, <span class="hljs-number">70</span>);
    unary(<span class="hljs-string">'typeof'</span>, <span class="hljs-number">70</span>, with_prec_paren(<span class="hljs-number">70</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> <span class="hljs-string">"typeof("</span>+with_prec(<span class="hljs-number">0</span>, jcompile)(<span class="hljs-keyword">this</span>.first)+<span class="hljs-string">")"</span>;
            }));
    unary(<span class="hljs-string">'['</span>, <span class="hljs-number">90</span><span class="hljs-comment">/*???*/</span>, with_prec_paren(<span class="hljs-number">90</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>new array creation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">return</span> <span class="hljs-string">"["</span> + gather(<span class="hljs-keyword">this</span>.first, <span class="hljs-string">", "</span>, with_prec(<span class="hljs-number">0</span>, jcompile)) +
                    <span class="hljs-string">"]"</span>;
            }));
    unary(<span class="hljs-string">'{'</span>, <span class="hljs-number">90</span><span class="hljs-comment">/*???*/</span>, with_prec_paren(<span class="hljs-number">90</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>new object creation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> result = <span class="hljs-string">"{"</span>;
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.first.length &gt; <span class="hljs-number">0</span>) {
                    indentation += <span class="hljs-number">1</span>;
                    result += nl();
                    result += gather(<span class="hljs-keyword">this</span>.first, <span class="hljs-string">","</span>+nl(), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>XXX suppress quotes around item.key when
    unnecessary</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-keyword">return</span> str_escape(item.key) + <span class="hljs-string">": "</span> +
                                with_prec(<span class="hljs-number">0</span>, jcompile)(item);
                        });
                    indentation -= <span class="hljs-number">1</span>;
                    result += nl();
                }
                result +=<span class="hljs-string">"}"</span>;
                <span class="hljs-keyword">return</span> result;
            }));</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Binary ASTs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch.binary = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        assert(dispatch.binary[<span class="hljs-keyword">this</span>.value], <span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> dispatch.binary[<span class="hljs-keyword">this</span>.value].apply(<span class="hljs-keyword">this</span>);
    };
    <span class="hljs-keyword">var</span> binary = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">op, prec, f, is_right</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>with_prec_paren will add parentheses if necessary</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        dispatch.binary[op] = f || with_prec_paren(prec, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">var</span> result = jcompile(<span class="hljs-keyword">this</span>.first)+<span class="hljs-string">' '</span>+<span class="hljs-keyword">this</span>.value+<span class="hljs-string">' '</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>handle left associativity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                result += with_prec(is_right ? (prec<span class="hljs-number">-1</span>) : (prec+<span class="hljs-number">1</span>),
                                    jcompile)(<span class="hljs-keyword">this</span>.second);
                <span class="hljs-keyword">return</span> result;
            });
    };
    <span class="hljs-keyword">var</span> binaryr = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">op, prec</span>) </span>{ binary(op, prec, <span class="hljs-literal">null</span>, <span class="hljs-number">1</span><span class="hljs-comment">/*is right*/</span>); };
    binaryr(<span class="hljs-string">'='</span>, <span class="hljs-number">10</span>);
    binaryr(<span class="hljs-string">'+='</span>, <span class="hljs-number">10</span>);
    binaryr(<span class="hljs-string">'-='</span>, <span class="hljs-number">10</span>);
    binaryr(<span class="hljs-string">'*='</span>, <span class="hljs-number">10</span>);
    binaryr(<span class="hljs-string">'/='</span>, <span class="hljs-number">10</span>);
    binaryr(<span class="hljs-string">'||'</span>, <span class="hljs-number">30</span>);
    binaryr(<span class="hljs-string">'&amp;&amp;'</span>, <span class="hljs-number">35</span>);
    binaryr(<span class="hljs-string">'==='</span>,<span class="hljs-number">40</span>);
    binaryr(<span class="hljs-string">'!=='</span>,<span class="hljs-number">40</span>);
    binaryr(<span class="hljs-string">'&lt;'</span>, <span class="hljs-number">45</span>);
    binaryr(<span class="hljs-string">'&lt;='</span>,<span class="hljs-number">45</span>);
    binaryr(<span class="hljs-string">'&gt;'</span>, <span class="hljs-number">45</span>);
    binaryr(<span class="hljs-string">'&gt;='</span>,<span class="hljs-number">45</span>);
    binary(<span class="hljs-string">'+'</span>, <span class="hljs-number">50</span>);
    binary(<span class="hljs-string">'-'</span>, <span class="hljs-number">50</span>);
    binary(<span class="hljs-string">'*'</span>, <span class="hljs-number">60</span>);
    binary(<span class="hljs-string">'/'</span>, <span class="hljs-number">60</span>);
    binary(<span class="hljs-string">"."</span>, <span class="hljs-number">80</span>, with_prec_paren(<span class="hljs-number">80</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            assert(<span class="hljs-keyword">this</span>.second.arity===<span class="hljs-string">'literal'</span>, <span class="hljs-keyword">this</span>.second);
            <span class="hljs-keyword">return</span> jcompile(<span class="hljs-keyword">this</span>.first)+<span class="hljs-string">"."</span>+<span class="hljs-keyword">this</span>.second.value;
            }));
    binary(<span class="hljs-string">'['</span>, <span class="hljs-number">80</span>, with_prec_paren(<span class="hljs-number">80</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> jcompile(<span class="hljs-keyword">this</span>.first) + <span class="hljs-string">"["</span> +
                    with_prec(<span class="hljs-number">0</span>, jcompile)(<span class="hljs-keyword">this</span>.second) + <span class="hljs-string">"]"</span>;
            }));
    binary(<span class="hljs-string">'('</span>, <span class="hljs-number">75</span>, with_prec_paren(<span class="hljs-number">75</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>simple method invocation (doesn&#39;t set &#39;this&#39;)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> first = jcompile(<span class="hljs-keyword">this</span>.first);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>catch weird case where standard javascript fails to parse an
immediate application of a function expression.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.first.arity===<span class="hljs-string">'function'</span>) {
                first = <span class="hljs-string">"("</span> + first + <span class="hljs-string">")"</span>;
            }
            <span class="hljs-keyword">return</span> first + <span class="hljs-string">"("</span> +
                gather(<span class="hljs-keyword">this</span>.second, <span class="hljs-string">", "</span>, with_prec(<span class="hljs-number">0</span>, jcompile)) + <span class="hljs-string">")"</span>;
            }));</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Ternary ASTs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch.ternary = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        assert(dispatch.ternary[<span class="hljs-keyword">this</span>.value], <span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> dispatch.ternary[<span class="hljs-keyword">this</span>.value].apply(<span class="hljs-keyword">this</span>);
    };
    <span class="hljs-keyword">var</span> ternary = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">op, prec, f</span>) </span>{
        dispatch.ternary[op] = with_prec_paren(prec, f);
    };
    ternary(<span class="hljs-string">"?"</span>, <span class="hljs-number">20</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> jcompile(<span class="hljs-keyword">this</span>.first) + <span class="hljs-string">" ? "</span> +
                jcompile(<span class="hljs-keyword">this</span>.second) + <span class="hljs-string">" : "</span> +
                jcompile(<span class="hljs-keyword">this</span>.third);
        });
    ternary(<span class="hljs-string">"("</span>, <span class="hljs-number">80</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>precedence is 80, same as . and &#39;(&#39;)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> result = jcompile(<span class="hljs-keyword">this</span>.first);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.second.arity===<span class="hljs-string">'literal'</span> &amp;&amp;
            <span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">this</span>.second.value)===<span class="hljs-string">'string'</span>) {
            result += <span class="hljs-string">'.'</span> + <span class="hljs-keyword">this</span>.second.value;
        } <span class="hljs-keyword">else</span> {
            result += <span class="hljs-string">'['</span> + jcompile(<span class="hljs-keyword">this</span>.second) + <span class="hljs-string">']'</span>;
        }
        result +=
            <span class="hljs-string">"("</span> + gather(<span class="hljs-keyword">this</span>.third, <span class="hljs-string">", "</span>, with_prec(<span class="hljs-number">0</span>, jcompile)) + <span class="hljs-string">")"</span>;
        <span class="hljs-keyword">return</span> result;
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Statements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch.statement = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        assert(dispatch.statement[<span class="hljs-keyword">this</span>.value], <span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> dispatch.statement[<span class="hljs-keyword">this</span>.value].apply(<span class="hljs-keyword">this</span>);
    };
    <span class="hljs-keyword">var</span> stmt = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value, f</span>) </span>{
        dispatch.statement[value] = f;
    };
    stmt(<span class="hljs-string">"block"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> result = <span class="hljs-string">"{"</span>;
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.first.length &gt; <span class="hljs-number">0</span>) {
                indentation += <span class="hljs-number">1</span>;
                result += nl() + jcompile_stmts(<span class="hljs-keyword">this</span>.first);
                indentation -= <span class="hljs-number">1</span>;
            }
            result += nl() + <span class="hljs-string">"}"</span>;
            <span class="hljs-keyword">return</span> result;
            });
    stmt(<span class="hljs-string">"var"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-string">"var "</span>+jcompile(<span class="hljs-keyword">this</span>.first)+<span class="hljs-string">";"</span>;
        });
    stmt(<span class="hljs-string">"if"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> result = <span class="hljs-string">"if ("</span>+jcompile(<span class="hljs-keyword">this</span>.first)+<span class="hljs-string">") "</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>this.second.value === block</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            result += jcompile(<span class="hljs-keyword">this</span>.second);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.third) {
                result += <span class="hljs-string">" else "</span>;
                result += jcompile(<span class="hljs-keyword">this</span>.third);
            }
            <span class="hljs-keyword">return</span> result;
        });
    stmt(<span class="hljs-string">"return"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-string">"return"</span>+(<span class="hljs-keyword">this</span>.first ? (<span class="hljs-string">" "</span>+jcompile(<span class="hljs-keyword">this</span>.first)) : <span class="hljs-string">""</span>)+<span class="hljs-string">";"</span>;
        });
    stmt(<span class="hljs-string">"break"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-string">"break;"</span>;
        });
    stmt(<span class="hljs-string">"while"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-string">"while ("</span>+jcompile(<span class="hljs-keyword">this</span>.first)+<span class="hljs-string">") "</span>+jcompile(<span class="hljs-keyword">this</span>.second);
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Odd cases</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch[<span class="hljs-string">'this'</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"this"</span>; }; <span class="hljs-comment">// literal</span>
    dispatch[<span class="hljs-string">'function'</span>] = with_prec(<span class="hljs-number">0</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> result = <span class="hljs-string">"function"</span>;
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.name) { result += <span class="hljs-string">" "</span> + <span class="hljs-keyword">this</span>.name; }
            result += <span class="hljs-string">" ("</span> + gather(<span class="hljs-keyword">this</span>.first, <span class="hljs-string">", "</span>, jcompile) + <span class="hljs-string">") {"</span>;
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.second.length &gt; <span class="hljs-number">0</span>) {
                indentation += <span class="hljs-number">1</span>;
                result += nl() + jcompile_stmts(<span class="hljs-keyword">this</span>.second); <span class="hljs-comment">// function body</span>
                indentation -= <span class="hljs-number">1</span>;
            }
            result += nl() + <span class="hljs-string">"}"</span>;
            <span class="hljs-keyword">return</span> result;
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Helpers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    jcompile = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tree</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>make &#39;this&#39; the parse tree in the dispatched function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        assert(dispatch[tree.arity], tree);
        <span class="hljs-keyword">return</span> dispatch[tree.arity].apply(tree);
    };
    jcompile_stmt = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tree</span>) </span>{
        <span class="hljs-keyword">return</span> jcompile(tree)+(tree.arity===<span class="hljs-string">'statement'</span> ? <span class="hljs-string">""</span> : <span class="hljs-string">";"</span>);
    };
    jcompile_stmts = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tree_list</span>) </span>{
        <span class="hljs-keyword">return</span> gather(tree_list, nl(), jcompile_stmt);
    };

    <span class="hljs-keyword">var</span> j = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">parse_tree</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>parse_tree should be an array of statements.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        indentation = <span class="hljs-number">0</span>;
        prec_stack = [ <span class="hljs-number">0</span> ];
        <span class="hljs-keyword">return</span> jcompile_stmts(parse_tree);
    };
    j.__module_name__ = <span class="hljs-string">"jcompile"</span>;
    j.__module_init__ = make_jcompile;
    j.__module_deps__ = [<span class="hljs-string">'str-escape'</span>];
    j.__module_source__ = jcompile_source;
    <span class="hljs-keyword">return</span> j;
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
