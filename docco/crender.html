<!DOCTYPE html>

<html>
<head>
  <title>crender.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="asm-llvm.html">
                asm-llvm.js
              </a>
            
              
              <a class="source" href="bcompile.html">
                bcompile.js
              </a>
            
              
              <a class="source" href="binterp.html">
                binterp.js
              </a>
            
              
              <a class="source" href="browsercanvas.html">
                browsercanvas.js
              </a>
            
              
              <a class="source" href="bytecode-table.html">
                bytecode-table.js
              </a>
            
              
              <a class="source" href="canvastest.html">
                canvastest.js
              </a>
            
              
              <a class="source" href="ccanvas.html">
                ccanvas.js
              </a>
            
              
              <a class="source" href="crender-styles.html">
                crender-styles.js
              </a>
            
              
              <a class="source" href="crender.html">
                crender.js
              </a>
            
              
              <a class="source" href="ctiles.html">
                ctiles.js
              </a>
            
              
              <a class="source" href="events.html">
                events.js
              </a>
            
              
              <a class="source" href="eventtests.html">
                eventtests.js
              </a>
            
              
              <a class="source" href="extensions.html">
                extensions.js
              </a>
            
              
              <a class="source" href="global-es5.html">
                global-es5.js
              </a>
            
              
              <a class="source" href="global.html">
                global.js
              </a>
            
              
              <a class="source" href="html-escape.html">
                html-escape.js
              </a>
            
              
              <a class="source" href="jcompile.html">
                jcompile.js
              </a>
            
              
              <a class="source" href="json2.html">
                json2.js
              </a>
            
              
              <a class="source" href="nodemain.html">
                nodemain.js
              </a>
            
              
              <a class="source" href="parse.html">
                parse.js
              </a>
            
              
              <a class="source" href="render.html">
                render.js
              </a>
            
              
              <a class="source" href="render2.html">
                render2.js
              </a>
            
              
              <a class="source" href="require.html">
                require.js
              </a>
            
              
              <a class="source" href="stdlib.html">
                stdlib.js
              </a>
            
              
              <a class="source" href="str-escape.html">
                str-escape.js
              </a>
            
              
              <a class="source" href="tdop.html">
                tdop.js
              </a>
            
              
              <a class="source" href="tests.html">
                tests.js
              </a>
            
              
              <a class="source" href="text.html">
                text.js
              </a>
            
              
              <a class="source" href="tiles.html">
                tiles.js
              </a>
            
              
              <a class="source" href="tokenize.html">
                tokenize.js
              </a>
            
              
              <a class="source" href="top-level.html">
                top-level.js
              </a>
            
              
              <a class="source" href="ts.html">
                ts.js
              </a>
            
              
              <a class="source" href="write-lua-bytecode.html">
                write-lua-bytecode.js
              </a>
            
              
              <a class="source" href="write-lua-ops.html">
                write-lua-ops.js
              </a>
            
              
              <a class="source" href="write-php-bytecode.html">
                write-php-bytecode.js
              </a>
            
              
              <a class="source" href="write-php-ops.html">
                write-php-ops.js
              </a>
            
              
              <a class="source" href="write-rust-bytecode.html">
                write-rust-bytecode.js
              </a>
            
              
              <a class="source" href="write-rust-ops.html">
                write-rust-ops.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="crenderjs">crender.js</h1>
<p>Create widget tree for parsed Simplified JavaScript.
Written in Simplified JavaScript.</p>
<p>C. Scott Ananian
2011-05-13</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>define([<span class="hljs-string">"text!crender.js"</span>, <span class="hljs-string">"str-escape"</span>, <span class="hljs-string">"gfx/Point"</span>, <span class="hljs-string">"gfx/Color"</span>], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make_crender</span>(<span class="hljs-params">crender_source, str_escape, Point, Color</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>stub for i18n</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> _ = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">txt</span>) </span>{ <span class="hljs-keyword">return</span> txt; };</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>basic graphics datatypes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> pt = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x, y</span>) </span>{ <span class="hljs-keyword">return</span> Point.New(x, y); };</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Bounding boxes are slightly fancy multiline rectangles.
They contain a starting indent and a trailing widow, like so:</p>
<p>   INDENTxxxx
 xxxxxxxxxxxx
 xxxxxxxxxxxx
 xxWIDOW</p>
<p>We also provide width() and height() properties that refer to the
overall dimensions, ignoring the indents.</p>
<p>The multiline rect is specified as follows:
   tl: top left coordinate of the overall bounding box
   br: bottom right coordinate of the overall bounding box
   indent: coordinate of the bottom left of the I in INDENT
   widow: coordinate of the top right of the W in WIDOW</p>
<p>By convention, we place the origin at the top-left of the I in INDENT,
so widgets typically return a bounding box with tl.y === 0, tl.x &lt;=0,
and indent.x === 0.
Note that indent.x &lt; tl.x is possible and valid.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> MultiLineBBox = {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>multiline should generally be equivalent to
    this.indent.equals(this.bl) &amp;&amp; this.widow.equals(this.tr);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _multiline: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">multiline</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._multiline || <span class="hljs-literal">false</span>; },
        <span class="hljs-attr">tl</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._tl; },
        <span class="hljs-attr">tr</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> pt(<span class="hljs-keyword">this</span>._br.x, <span class="hljs-keyword">this</span>._tl.y); },
        <span class="hljs-attr">bl</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> pt(<span class="hljs-keyword">this</span>._tl.x, <span class="hljs-keyword">this</span>._br.y); },
        <span class="hljs-attr">br</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._br; },
        <span class="hljs-attr">indent</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._indent || <span class="hljs-keyword">this</span>.bl(); },
        <span class="hljs-attr">widow</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._widow || <span class="hljs-keyword">this</span>.tr(); },
        <span class="hljs-attr">width</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._br.x - <span class="hljs-keyword">this</span>._tl.x; },
        <span class="hljs-attr">height</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._br.y - <span class="hljs-keyword">this</span>._tl.y; },
        <span class="hljs-attr">top</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._tl.y; },
        <span class="hljs-attr">bottom</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._br.y; },
        <span class="hljs-attr">left</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._tl.x; },
        <span class="hljs-attr">right</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._br.x; },

        <span class="hljs-attr">widowHeight</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.bottom() - <span class="hljs-keyword">this</span>.widow().y; },

        <span class="hljs-attr">create</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tl, br, indent, widow, multiline</span>) </span>{
            <span class="hljs-keyword">var</span> bb = <span class="hljs-built_in">Object</span>.create(MultiLineBBox);
            bb._tl = tl;
            bb._br = br;
            <span class="hljs-keyword">if</span> (indent) { bb._indent = indent; }
            <span class="hljs-keyword">if</span> (widow) { bb._widow = widow; }
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(multiline)===<span class="hljs-string">"boolean"</span>) { bb._multiline = multiline; }
            <span class="hljs-keyword">return</span> bb;
        },
        <span class="hljs-attr">toString</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-string">"["</span>+<span class="hljs-keyword">this</span>.tl()+<span class="hljs-string">"-"</span>+<span class="hljs-keyword">this</span>.br()+<span class="hljs-string">" i:"</span>+<span class="hljs-keyword">this</span>.indent()+<span class="hljs-string">", "</span>+
                <span class="hljs-string">"w:"</span>+<span class="hljs-keyword">this</span>.widow()+<span class="hljs-string">", m:"</span>+<span class="hljs-keyword">this</span>.multiline()+<span class="hljs-string">"]"</span>;
        },
        <span class="hljs-attr">translate</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pt</span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.create(<span class="hljs-keyword">this</span>._tl.add(pt),
                               <span class="hljs-keyword">this</span>._br.add(pt),
                               <span class="hljs-keyword">this</span>._indent &amp;&amp; <span class="hljs-keyword">this</span>._indent.add(pt),
                               <span class="hljs-keyword">this</span>._widow &amp;&amp; <span class="hljs-keyword">this</span>._widow.add(pt),
                               <span class="hljs-keyword">this</span>._multiline);
        },
        <span class="hljs-attr">ensureHeight</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> nbb = <span class="hljs-keyword">this</span>;
            <span class="hljs-keyword">var</span> nHeight = <span class="hljs-built_in">Math</span>.max.apply(<span class="hljs-built_in">Math</span>, <span class="hljs-built_in">arguments</span>);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.height() &lt; nHeight) {
                nbb = <span class="hljs-built_in">Object</span>.create(<span class="hljs-keyword">this</span>);
                nbb._br = pt(<span class="hljs-keyword">this</span>._br.x, <span class="hljs-keyword">this</span>._tl.y + nHeight);
            }
            <span class="hljs-keyword">return</span> nbb;
        },
        <span class="hljs-attr">contains</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x, y</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>allow passing a pt object as first arg</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(x)===<span class="hljs-string">"object"</span>) { y=x.y; x=x.x; }
            <span class="hljs-keyword">if</span> (y &lt; <span class="hljs-keyword">this</span>._tl.y) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (y &lt; <span class="hljs-keyword">this</span>.indent.y()) {
                <span class="hljs-keyword">return</span> (x &gt;= <span class="hljs-keyword">this</span>.indent().x) &amp;&amp; (x &lt; <span class="hljs-keyword">this</span>._br.x);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (y &lt; <span class="hljs-keyword">this</span>.widow().y) {
                <span class="hljs-keyword">return</span> (x &gt;= <span class="hljs-keyword">this</span>._tl.x) &amp;&amp; (x &lt; <span class="hljs-keyword">this</span>._br.x);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (y &lt; <span class="hljs-keyword">this</span>._br.y) {
                <span class="hljs-keyword">return</span> (x &gt;= <span class="hljs-keyword">this</span>._tl.x) &amp;&amp; (x &lt; <span class="hljs-keyword">this</span>.widow().x);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>pad a box</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        pad: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">padding, shift_origin</span>) </span>{
            <span class="hljs-keyword">var</span> tl = pt(<span class="hljs-keyword">this</span>.left() - (padding.left || <span class="hljs-number">0</span>),
                        <span class="hljs-keyword">this</span>.top() - (padding.top || <span class="hljs-number">0</span>));
            <span class="hljs-keyword">var</span> br = pt(<span class="hljs-keyword">this</span>.right() + (padding.right || <span class="hljs-number">0</span>),
                        <span class="hljs-keyword">this</span>.bottom() + (padding.bottom || <span class="hljs-number">0</span>));
            <span class="hljs-keyword">var</span> indent = <span class="hljs-keyword">this</span>._indent &amp;&amp;
                (pt(<span class="hljs-keyword">this</span>.indent().x - (padding.indentx || <span class="hljs-number">0</span>),
                    <span class="hljs-keyword">this</span>.indent().y - (padding.indenty || <span class="hljs-number">0</span>)));
            <span class="hljs-keyword">var</span> widow = <span class="hljs-keyword">this</span>._widow &amp;&amp;
                (pt(<span class="hljs-keyword">this</span>.widow().x + (padding.widowx || <span class="hljs-number">0</span>),
                    <span class="hljs-keyword">this</span>.widow().y + (padding.widowy || <span class="hljs-number">0</span>)));
            <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">this</span>.create(tl, br, indent, widow, <span class="hljs-keyword">this</span>._multiline);
            <span class="hljs-keyword">if</span> (shift_origin) {
                result = result.translate(result.tl().negate());
            }
            <span class="hljs-keyword">return</span> result;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>add a linebreak after a box and return the result</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        linebreak: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">margin, lineHeight</span>) </span>{
            <span class="hljs-keyword">var</span> height = <span class="hljs-built_in">Math</span>.max(lineHeight||<span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.widowHeight());
            <span class="hljs-keyword">var</span> left = margin - <span class="hljs-keyword">this</span>.widow().x;
            <span class="hljs-keyword">var</span> lb;
            <span class="hljs-keyword">if</span> (left &lt; <span class="hljs-number">0</span>) {
                lb = <span class="hljs-keyword">this</span>.create(pt(left, <span class="hljs-number">0</span>), pt(<span class="hljs-number">0</span>, height),
                                 pt(<span class="hljs-number">0</span>, height), pt(left, height), <span class="hljs-literal">true</span>);
            } <span class="hljs-keyword">else</span> {
                lb = <span class="hljs-keyword">this</span>.create(pt(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), pt(left, height),
                                 pt(left, height), pt(<span class="hljs-number">0</span>, height), <span class="hljs-literal">true</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.chainHoriz(lb);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>chain two bounding boxes together, top-aligning them.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        chainHoriz: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">bb</span>) </span>{
            <span class="hljs-keyword">var</span> bb2 = bb.translate(<span class="hljs-keyword">this</span>.widow());
            <span class="hljs-keyword">var</span> tl = pt(<span class="hljs-built_in">Math</span>.min(<span class="hljs-keyword">this</span>.left(), bb2.left()),
                        <span class="hljs-built_in">Math</span>.min(<span class="hljs-keyword">this</span>.top(), bb2.top()));
            <span class="hljs-keyword">var</span> br = pt(<span class="hljs-built_in">Math</span>.max(<span class="hljs-keyword">this</span>.right(), bb2.right()),
                        <span class="hljs-built_in">Math</span>.max(<span class="hljs-keyword">this</span>.bottom(), bb2.bottom()));
            <span class="hljs-keyword">var</span> ml = <span class="hljs-keyword">this</span>.multiline() || bb2.multiline();
            <span class="hljs-keyword">if</span> (!ml) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.create(tl, br);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>handle multiline case</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> indent = <span class="hljs-keyword">this</span>.indent();
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.multiline()) {
                indent = pt(indent.x, <span class="hljs-built_in">Math</span>.max(indent.y, bb2.indent().y));</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>is this creating a box with a negative indent?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.left() &lt; bb2.left()) {
                    tl = bb2.tl();
                }
            }
            <span class="hljs-keyword">var</span> widow = bb2.widow(); <span class="hljs-comment">// falls back to tr()</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.create(tl, br, indent, widow, ml);
        }
    };
    <span class="hljs-keyword">var</span> bbox = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">tl, br</span>) </span>{
        <span class="hljs-keyword">return</span> MultiLineBBox.create(tl, br);
    };
    <span class="hljs-keyword">var</span> mlbbox = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tl, br, indent, widow</span>) </span>{
        <span class="hljs-keyword">return</span> MultiLineBBox.create(tl, br, indent, widow, <span class="hljs-literal">true</span>);
    };
    <span class="hljs-keyword">var</span> rect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">w, h</span>) </span>{
        <span class="hljs-keyword">return</span> bbox(pt(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>), pt(w, h));
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>FOR DEBUGGING</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    MultiLineBBox.drawPath = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">canvas</span>) </span>{
        canvas.beginPath();
        canvas.moveTo(<span class="hljs-keyword">this</span>.indent());
        canvas.lineTo(<span class="hljs-keyword">this</span>.indent().x, <span class="hljs-keyword">this</span>.top());
        canvas.lineTo(<span class="hljs-keyword">this</span>.tr());
        canvas.lineTo(<span class="hljs-keyword">this</span>.right(), <span class="hljs-keyword">this</span>.widow().y);
        canvas.lineTo(<span class="hljs-keyword">this</span>.widow());
        canvas.lineTo(<span class="hljs-keyword">this</span>.widow().x, <span class="hljs-keyword">this</span>.bottom());
        canvas.lineTo(<span class="hljs-keyword">this</span>.bl());
        canvas.lineTo(<span class="hljs-keyword">this</span>.left(), <span class="hljs-keyword">this</span>.indent().y);
        canvas.closePath();
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>helper to save/restore contexts
also reset fill/stroke color and font height.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> context_saved = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">f</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> nargs = <span class="hljs-built_in">Array</span>.prototype.concat.apply([<span class="hljs-keyword">this</span>], <span class="hljs-built_in">arguments</span>);
            <span class="hljs-keyword">var</span> g = f.bind.apply(f, nargs);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.canvas.withContext(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>reset fill/stroke</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">this</span>.canvas.setFill(<span class="hljs-keyword">this</span>.styles.textColor);
                <span class="hljs-keyword">this</span>.canvas.setStroke(<span class="hljs-keyword">this</span>.styles.tileOutlineColor);</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>reset font height</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">this</span>.canvas.setFontHeight(<span class="hljs-keyword">this</span>.styles.textHeight);
                <span class="hljs-keyword">return</span> g();
            });
        };
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>first, let&#39;s make some widgets</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> DEFAULT_WIDGET_TEXT=<span class="hljs-string">"...???..."</span>;
    <span class="hljs-keyword">var</span> Widget = {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>layout the widget, compute sizes and bounding boxes.
cache the values, we use them a lot.
can be recalled to update canvas/styles or drawing properties.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        layout: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">canvas, styles, properties</span>) </span>{
            <span class="hljs-keyword">this</span>.canvas = canvas;
            <span class="hljs-keyword">this</span>.styles = styles;
            <span class="hljs-keyword">this</span>.bbox = <span class="hljs-keyword">this</span>.computeBBox(properties);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>bounding box includes child widgets (which may extend)
but doesn&#39;t include puzzle sockets/plugs (which also hang over)
bbox may be a MultiLineBBox</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        computeBBox: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>in default implementation, the bounding box is the same
as the size (see below)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>.size = <span class="hljs-keyword">this</span>.computeSize(properties);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.size;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>allow child widgets to override default tile background color.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        bgColor: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.styles.tileColor;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>helper to offset basic sizes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        pad: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">r, padding, shift_origin</span>) </span>{
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(r.width) !== <span class="hljs-string">"function"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>handle output from measureText, which is not a real rect()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                r = rect(r.width, r.height);
                shift_origin = <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(padding) === <span class="hljs-string">"number"</span>) {
                padding = { <span class="hljs-attr">left</span>: padding, <span class="hljs-attr">top</span>: padding,
                            <span class="hljs-attr">right</span>: padding, <span class="hljs-attr">bottom</span>: padding };
            }
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(padding) !== <span class="hljs-string">"object"</span>) {
                padding = <span class="hljs-keyword">this</span>.styles.tilePadding;
            }
            <span class="hljs-keyword">return</span> r.pad(padding, shift_origin);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>by convention we compute a &#39;size&#39; property which is the size of
the widget itself, ignoring children.  This isn&#39;t a standard
method, though;
default widget rendering</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        computeSize: context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.pad(<span class="hljs-keyword">this</span>.canvas.measureText(DEFAULT_WIDGET_TEXT));
        }),</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>by convention, given a canvas translated so that our top-left
corner is 0, 0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        draw: context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>very simple box.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>.canvas.setFill(<span class="hljs-keyword">this</span>.bgColor());
            <span class="hljs-keyword">this</span>.bbox.drawPath(<span class="hljs-keyword">this</span>.canvas);
            <span class="hljs-keyword">this</span>.canvas.fill();
            <span class="hljs-keyword">this</span>.canvas.stroke();
            <span class="hljs-keyword">this</span>.drawPaddedText(DEFAULT_WIDGET_TEXT, pt(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
                                <span class="hljs-keyword">this</span>.styles.textColor);
        }),</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>drawing aids</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        drawPaddedText: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">text, pt, color</span>) </span>{
            <span class="hljs-keyword">if</span> (color) { <span class="hljs-keyword">this</span>.canvas.setFill(color); }
            <span class="hljs-keyword">this</span>.canvas.drawText(text,
                                 pt.x + <span class="hljs-keyword">this</span>.styles.tilePadding.left,
                                 pt.y + <span class="hljs-keyword">this</span>.styles.tilePadding.top +
                                 <span class="hljs-keyword">this</span>.styles.textHeight);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>make a rounded corner.
from and to are [0-3] and represent angles in units of 90 degrees
&quot;0&quot; is in the positive x direction and angles increase CW</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        drawRoundCorner: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pt, from, isCW, radius</span>) </span>{
            <span class="hljs-keyword">var</span> f = isCW ? <span class="hljs-keyword">from</span> : (<span class="hljs-keyword">from</span>===<span class="hljs-number">0</span>) ? <span class="hljs-number">3</span> : (<span class="hljs-keyword">from</span> - <span class="hljs-number">1</span>);
            <span class="hljs-keyword">var</span> rad = radius || <span class="hljs-keyword">this</span>.styles.tileCornerRadius;
            <span class="hljs-keyword">var</span> cx = pt.x + ((f===<span class="hljs-number">0</span> || f===<span class="hljs-number">3</span>) ? -rad : rad);
            <span class="hljs-keyword">var</span> cy = pt.y + ((f===<span class="hljs-number">0</span> || f===<span class="hljs-number">1</span>) ? -rad : rad);
            <span class="hljs-keyword">var</span> to = isCW ? (<span class="hljs-keyword">from</span>+<span class="hljs-number">1</span>) : (<span class="hljs-keyword">from</span> - <span class="hljs-number">1</span>);
            <span class="hljs-keyword">this</span>.canvas.arc(cx, cy, rad, <span class="hljs-keyword">from</span>*<span class="hljs-built_in">Math</span>.PI/<span class="hljs-number">2</span>, to*<span class="hljs-built_in">Math</span>.PI/<span class="hljs-number">2</span>, !isCW);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>make name and expression plugs/sockets</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        drawCapUp: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pt, isPlug, isRight, isName</span>) </span>{
            <span class="hljs-keyword">var</span> ew = <span class="hljs-keyword">this</span>.styles.expWidth;
            <span class="hljs-keyword">var</span> eh = <span class="hljs-keyword">this</span>.styles.expHalfHeight;
            <span class="hljs-keyword">if</span> (isPlug) { isRight = !isRight; }
            <span class="hljs-keyword">if</span> (isRight) { ew = -ew; }

            <span class="hljs-keyword">this</span>.canvas.lineTo(pt.add(<span class="hljs-number">0</span>, eh*<span class="hljs-number">2</span>));
            <span class="hljs-keyword">if</span> (isName &amp;&amp; !isRight) {
                <span class="hljs-keyword">this</span>.canvas.lineTo(pt.add(<span class="hljs-number">0</span>, eh));
            }
            <span class="hljs-keyword">this</span>.canvas.lineTo(pt.add(ew, eh));
            <span class="hljs-keyword">if</span> (isName &amp;&amp; isRight) {
                <span class="hljs-keyword">this</span>.canvas.lineTo(pt.add(<span class="hljs-number">0</span>, eh));
            }
            <span class="hljs-keyword">this</span>.canvas.lineTo(pt);
        },
        <span class="hljs-attr">drawCapDown</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pt, isPlug, isRight, isName</span>) </span>{
            <span class="hljs-keyword">var</span> ew = <span class="hljs-keyword">this</span>.styles.expWidth;
            <span class="hljs-keyword">var</span> eh = <span class="hljs-keyword">this</span>.styles.expHalfHeight;
            <span class="hljs-keyword">if</span> (isPlug) { isRight = !isRight; }
            <span class="hljs-keyword">if</span> (isRight) { ew = -ew; }

            <span class="hljs-keyword">this</span>.canvas.lineTo(pt);
            <span class="hljs-keyword">if</span> (isName &amp;&amp; isRight) {
                <span class="hljs-keyword">this</span>.canvas.lineTo(pt.add(<span class="hljs-number">0</span>, eh));
            }
            <span class="hljs-keyword">this</span>.canvas.lineTo(pt.add(ew, eh));
            <span class="hljs-keyword">if</span> (isName &amp;&amp; !isRight) {
                <span class="hljs-keyword">this</span>.canvas.lineTo(pt.add(<span class="hljs-number">0</span>, eh));
            }
            <span class="hljs-keyword">this</span>.canvas.lineTo(pt.add(<span class="hljs-number">0</span>, eh*<span class="hljs-number">2</span>));
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>bounding box debugging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        debugBBox: context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">bbox</span>) </span>{
            <span class="hljs-keyword">this</span>.canvas.setStroke(Color.red);
            (bbox || <span class="hljs-keyword">this</span>.bbox).drawPath(<span class="hljs-keyword">this</span>.canvas);
            <span class="hljs-keyword">this</span>.canvas.stroke();
        })
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>helpers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> ContainerWidget = <span class="hljs-built_in">Object</span>.create(Widget);
    ContainerWidget.length = <span class="hljs-number">0</span>; <span class="hljs-comment">// an array-like object</span>
    ContainerWidget.addChild = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">child</span>) </span>{
        <span class="hljs-built_in">Array</span>.prototype.push.call(<span class="hljs-keyword">this</span>, child);
    };
    ContainerWidget.children = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-keyword">this</span>);
    };

    <span class="hljs-keyword">var</span> HorizWidget = <span class="hljs-built_in">Object</span>.create(Widget);
    HorizWidget.computeBBox = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">this</span>.size = <span class="hljs-keyword">this</span>.computeSize(properties);
        <span class="hljs-keyword">var</span> r = <span class="hljs-keyword">this</span>.size;</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>optionally leave space for connector on left</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> margin = (properties.margin || <span class="hljs-number">0</span>) + (<span class="hljs-keyword">this</span>.extraMargin || <span class="hljs-number">0</span>);
        <span class="hljs-keyword">var</span> lineHeight = (properties.lineHeight || <span class="hljs-number">0</span>) +
            (<span class="hljs-keyword">this</span>.extraLineHeight || <span class="hljs-number">0</span>);

        <span class="hljs-keyword">this</span>.children().forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>{

            <span class="hljs-keyword">var</span> child_properties = <span class="hljs-built_in">Object</span>.create(properties);
            child_properties.margin = margin - r.widow().x;

            lineHeight = <span class="hljs-built_in">Math</span>.max(lineHeight, r.widowHeight());
            child_properties.lineHeight = lineHeight;

            c.layout(<span class="hljs-keyword">this</span>.canvas, <span class="hljs-keyword">this</span>.styles, child_properties);

            r = r.chainHoriz(c.bbox);
        }, <span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> r;
    };

    <span class="hljs-keyword">var</span> VertWidget = <span class="hljs-built_in">Object</span>.create(Widget);
    VertWidget.computeBBox = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">this</span>.size = <span class="hljs-keyword">this</span>.computeSize(properties);
        <span class="hljs-keyword">var</span> r = <span class="hljs-keyword">this</span>.size;
        <span class="hljs-keyword">this</span>.childOrigin = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>sum heights of children</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.children().forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>{
            <span class="hljs-keyword">var</span> child_props = <span class="hljs-built_in">Object</span>.create(properties);
            child_props.margin = <span class="hljs-number">0</span>;
            child_props.lineHeight = <span class="hljs-number">0</span>;
            c.layout(<span class="hljs-keyword">this</span>.canvas, <span class="hljs-keyword">this</span>.styles, properties);

            <span class="hljs-keyword">var</span> p = pt(<span class="hljs-number">0</span>, r.bottom());
            <span class="hljs-keyword">this</span>.childOrigin.push(p);
            <span class="hljs-keyword">var</span> bb = c.bbox.translate(p);

            r = bbox(pt(<span class="hljs-built_in">Math</span>.min(r.left(), bb.left()),
                        <span class="hljs-built_in">Math</span>.min(r.top(), bb.top())),
                     pt(<span class="hljs-built_in">Math</span>.max(bb.right(), r.right()),
                        <span class="hljs-built_in">Math</span>.max(bb.bottom(), r.bottom())));
        }, <span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> r;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>simple c-shaped statement.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> CeeWidget = <span class="hljs-built_in">Object</span>.create(Widget);
    CeeWidget.ceeStartPt = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> pt(<span class="hljs-keyword">this</span>.styles.puzzleIndent + <span class="hljs-number">2</span>*<span class="hljs-keyword">this</span>.styles.puzzleRadius, <span class="hljs-number">0</span>);
    };
    CeeWidget.ceeEndPt = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> pt(<span class="hljs-keyword">this</span>.styles.puzzleIndent + <span class="hljs-number">2</span>*<span class="hljs-keyword">this</span>.styles.puzzleRadius,
                  <span class="hljs-keyword">this</span>.size.bottom());
    };
    CeeWidget.draw = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.canvas.setFill(<span class="hljs-keyword">this</span>.bgColor());</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>start path at ceeStartPoint</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.beginPath();
        <span class="hljs-keyword">this</span>.canvas.moveTo(<span class="hljs-keyword">this</span>.ceeStartPt());</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>make the puzzle piece socket arc</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.arc(<span class="hljs-keyword">this</span>.styles.puzzleIndent + <span class="hljs-keyword">this</span>.styles.puzzleRadius,
                        <span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.styles.puzzleRadius,
                        <span class="hljs-number">0</span>, <span class="hljs-built_in">Math</span>.PI, <span class="hljs-literal">false</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>make the corner arcs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.drawRoundCorner(pt(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), <span class="hljs-number">3</span>, <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">this</span>.drawRoundCorner(pt(<span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.size.bottom()), <span class="hljs-number">2</span>, <span class="hljs-literal">false</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>puzzle piece &#39;plug&#39; arg</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.arc(<span class="hljs-keyword">this</span>.styles.puzzleIndent + <span class="hljs-keyword">this</span>.styles.puzzleRadius,
                        <span class="hljs-keyword">this</span>.size.bottom(), <span class="hljs-keyword">this</span>.styles.puzzleRadius,
                        <span class="hljs-built_in">Math</span>.PI, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>);
        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.ceeEndPt());</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>allow subclass to alter the right-hand side.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.rightHandPath();</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>fill &amp; stroke</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.closePath();
        <span class="hljs-keyword">this</span>.canvas.fill();
        <span class="hljs-keyword">this</span>.canvas.stroke();</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>allow subclass to actually draw the contents.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.setFill(<span class="hljs-keyword">this</span>.styles.textColor);
        <span class="hljs-keyword">this</span>.drawInterior();
    });
    CeeWidget.drawInterior = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-comment">/* no op */</span> };
    CeeWidget.rightHandPath = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>basic rounded right-hand-side</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.size.right() - <span class="hljs-keyword">this</span>.styles.tileCornerRadius,
                           <span class="hljs-keyword">this</span>.size.bottom());
        <span class="hljs-keyword">this</span>.drawRoundCorner(<span class="hljs-keyword">this</span>.size.br(), <span class="hljs-number">1</span>, <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">this</span>.drawRoundCorner(<span class="hljs-keyword">this</span>.size.tr(), <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Expression tiles</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> ExpWidget = <span class="hljs-built_in">Object</span>.create(Widget);
    ExpWidget.outlineColor = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.styles.tileOutlineColor; };
    ExpWidget.draw = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.canvas.setFill(<span class="hljs-keyword">this</span>.bgColor());
        <span class="hljs-keyword">this</span>.canvas.setStroke(<span class="hljs-keyword">this</span>.outlineColor());</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>start path at 0,0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.beginPath();
        <span class="hljs-keyword">this</span>.canvas.moveTo(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);
        <span class="hljs-keyword">this</span>.leftHandPath();</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>draw line along bottom</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.bottomPath();</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>allow subclass to customize rhs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.rightHandPath();</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>allow subclass to customize the top</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.topSidePath();</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>fill &amp; stroke</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.closePath();
        <span class="hljs-keyword">this</span>.canvas.fill();
        <span class="hljs-keyword">this</span>.canvas.stroke();</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>allow subclass to actually draw the contents.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.setFill(<span class="hljs-keyword">this</span>.styles.textColor);
        <span class="hljs-keyword">this</span>.drawInterior();
    });
    ExpWidget.bottomPath = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.size.bottom());
        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.size.br());
    };
    ExpWidget.leftHandDir = <span class="hljs-number">-1</span>;
    ExpWidget.rightHandDir = <span class="hljs-number">1</span>;
    ExpWidget.isName = <span class="hljs-literal">false</span>;
    ExpWidget.leftHandPath = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.leftHandDir === <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span>; }
        <span class="hljs-keyword">this</span>.drawCapDown(pt(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>), (<span class="hljs-keyword">this</span>.leftHandDir &lt; <span class="hljs-number">0</span>), <span class="hljs-literal">false</span>, <span class="hljs-keyword">this</span>.isName);
    };
    ExpWidget.rightHandPath = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.size.br());
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.rightHandDir === <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.size.right(), <span class="hljs-number">0</span>);
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">this</span>.drawCapUp(pt(<span class="hljs-keyword">this</span>.size.right(), <span class="hljs-number">0</span>), (<span class="hljs-keyword">this</span>.rightHandDir &gt; <span class="hljs-number">0</span>), <span class="hljs-literal">true</span>,
                       <span class="hljs-keyword">this</span>.isName);
    };
    ExpWidget.topSidePath = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>straight line by default.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    };</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>yada yada yada expression</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> YADA_TEXT = <span class="hljs-string">"..."</span>;
    <span class="hljs-keyword">var</span> YadaWidget = <span class="hljs-built_in">Object</span>.create(ExpWidget);
    YadaWidget.bgColor = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.styles.yadaColor; };
    YadaWidget.outlineColor = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.styles.yadaColor; };
    YadaWidget.computeSize = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.pad(<span class="hljs-keyword">this</span>.canvas.measureText(YADA_TEXT));
    });
    YadaWidget.drawInterior = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.drawPaddedText(YADA_TEXT, pt(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), <span class="hljs-keyword">this</span>.styles.semiColor);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Horizonal combinations of widgets</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> HorizExpWidget = <span class="hljs-built_in">Object</span>.create(ExpWidget);
    HorizExpWidget.computeBBox = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.pad(HorizWidget.computeBBox.call(<span class="hljs-keyword">this</span>, properties),
                        { <span class="hljs-attr">bottom</span>: <span class="hljs-keyword">this</span>.styles.expUnderHeight });
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>lists of things, separated by symbols of some kind.
the things can be names or exps; the symbols are circled by
the widget&#39;s outline.  The symbols/names/exps can be multiline.
XXX basically each symbol should have a &#39;line break after&#39; property.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> SeparatedListWidget = <span class="hljs-built_in">Object</span>.create(Widget);</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>override this!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    SeparatedListWidget.computeItems = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{ <span class="hljs-keyword">return</span> []; };</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>items don&#39;t have to be children, but they are by default.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    SeparatedListWidget.children = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> result = [];
        <span class="hljs-keyword">this</span>.items.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
            <span class="hljs-keyword">if</span> (item.widget &amp;&amp; !item.hide) {
                result.push(item.widget);
            }
        });
        <span class="hljs-keyword">return</span> result;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>meat &amp; potatoes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    SeparatedListWidget.computeBBox = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">this</span>.items = <span class="hljs-keyword">this</span>.computeItems(properties);

        <span class="hljs-keyword">var</span> bbox = rect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        <span class="hljs-keyword">var</span> lineHeight = properties.lineHeight || <span class="hljs-number">0</span>;

        <span class="hljs-keyword">this</span>.itemPos = [];
        <span class="hljs-keyword">this</span>.itemBBox = [];
        <span class="hljs-keyword">this</span>.items.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item, index</span>) </span>{
            <span class="hljs-keyword">var</span> child_props = <span class="hljs-built_in">Object</span>.create(properties);</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>adjust margin for new start position as well as to allow for
a descender on the left.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            child_props.margin = (properties.margin||<span class="hljs-number">0</span>) - bbox.widow().x;
            child_props.margin += <span class="hljs-keyword">this</span>.styles.expUnderWidth;
            child_props.margin += (item.indent || <span class="hljs-number">0</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>lineheight has to account for underline</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            child_props.lineHeight = <span class="hljs-keyword">this</span>.styles.expUnderHeight +
                <span class="hljs-built_in">Math</span>.max(lineHeight, bbox.widowHeight());</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>add the child.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> itemBB;
            <span class="hljs-keyword">if</span> (item.widget) {
                item.widget.layout(<span class="hljs-keyword">this</span>.canvas, <span class="hljs-keyword">this</span>.styles, child_props);
                itemBB = item.widget.bbox;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(item.bbox)===<span class="hljs-string">"function"</span>) {
                    itemBB = item.bbox(child_props);
                } <span class="hljs-keyword">else</span> {
                    itemBB = item.bbox;
                }
            }
            <span class="hljs-keyword">this</span>.itemPos.push(bbox.widow());
            <span class="hljs-keyword">this</span>.itemBBox.push(itemBB.translate(bbox.widow()));
            bbox = (index===<span class="hljs-number">0</span>) ? itemBB : bbox.chainHoriz(itemBB);
            <span class="hljs-keyword">if</span> (itemBB.multiline()) {</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>reset line height once we wrap</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                lineHeight -= bbox.widow().y;
            }
        }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>misc. prettiness: don&#39;t underline if there&#39;s only one item
in the list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.items.length &lt;= <span class="hljs-number">1</span> &amp;&amp; !<span class="hljs-keyword">this</span>.underlineShortLists) {
            <span class="hljs-keyword">return</span> bbox;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>and some height to account for the underline</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        bbox = bbox.pad({<span class="hljs-attr">bottom</span>: <span class="hljs-keyword">this</span>.styles.expUnderHeight});</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>if we wrapped, we also need a leader on the left</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (bbox.multiline()) {
            bbox = bbox.pad({<span class="hljs-attr">left</span>: <span class="hljs-keyword">this</span>.styles.expUnderWidth});
            <span class="hljs-keyword">var</span> indent = bbox.indent().x - bbox.left();
            <span class="hljs-keyword">var</span> indentSign = (indent &lt; <span class="hljs-number">0</span>) ? <span class="hljs-number">-1</span> : (indent &gt; <span class="hljs-number">0</span>) ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;
            bbox = bbox.pad({<span class="hljs-attr">indenty</span>: indentSign*<span class="hljs-keyword">this</span>.styles.expUnderHeight});
        }
        <span class="hljs-keyword">return</span> bbox;
    };
    SeparatedListWidget.draw = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.drawOutline();
        <span class="hljs-keyword">this</span>.drawInterior();
        <span class="hljs-keyword">this</span>.drawChildren();
    });
    SeparatedListWidget.drawSymbol=<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item, index, props</span>) </span>{
        <span class="hljs-keyword">var</span> bb = <span class="hljs-keyword">this</span>.itemBBox[index];</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>draw up left side</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!props.leftSuppress) {
            <span class="hljs-keyword">this</span>.drawCapUp(<span class="hljs-keyword">this</span>.itemPos[index],
                           props.leftIsPlug || <span class="hljs-literal">false</span>,
                           <span class="hljs-literal">false</span><span class="hljs-comment">/*left*/</span>, props.leftIsName || <span class="hljs-literal">false</span>);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>trace top border of bbox</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (bb.multiline()) {
            <span class="hljs-keyword">this</span>.drawRoundCorner(bb.tr(), <span class="hljs-number">3</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">this</span>.drawRoundCorner(pt(bb.right(), bb.widow().y), <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>draw down right side</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!props.rightSuppress) {
            <span class="hljs-keyword">this</span>.drawCapDown(bb.widow(),
                             props.rightIsPlug || <span class="hljs-literal">false</span>,
                             <span class="hljs-literal">true</span><span class="hljs-comment">/*right*/</span>, props.rightIsName || <span class="hljs-literal">false</span>);
        }
    };
    SeparatedListWidget.drawOutline = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.itemPos.length === <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>along bottoms of each item and them up around the separator</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.setFill(<span class="hljs-keyword">this</span>.bgColor());
        <span class="hljs-keyword">this</span>.canvas.beginPath();
        <span class="hljs-keyword">this</span>.canvas.moveTo(<span class="hljs-keyword">this</span>.bbox.indent());
        <span class="hljs-keyword">this</span>.items.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item, index</span>) </span>{
            <span class="hljs-keyword">if</span> (item.isSymbol) {</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>move up and outline the symbol (extension point)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> props = { <span class="hljs-attr">leftIsName</span>: <span class="hljs-keyword">this</span>.isName, <span class="hljs-attr">leftIsPlug</span>: <span class="hljs-literal">true</span>,
                              <span class="hljs-attr">rightIsName</span>: <span class="hljs-keyword">this</span>.isName, <span class="hljs-attr">rightIsPlug</span>: <span class="hljs-literal">true</span> };
                <span class="hljs-keyword">if</span> (index &gt; <span class="hljs-number">0</span>) {
                    props.leftIsName = <span class="hljs-keyword">this</span>.items[index<span class="hljs-number">-1</span>].isName;
                    props.leftIsPlug = <span class="hljs-literal">false</span>; <span class="hljs-comment">/* socket */</span>
                    props.leftSuppress = <span class="hljs-keyword">this</span>.items[index<span class="hljs-number">-1</span>].isSymbol;
                }
                <span class="hljs-keyword">if</span> ((index+<span class="hljs-number">1</span>) &lt; <span class="hljs-keyword">this</span>.items.length) {
                    props.rightIsName = <span class="hljs-keyword">this</span>.items[index+<span class="hljs-number">1</span>].isName;
                    props.rightIsPlug = <span class="hljs-literal">false</span>; <span class="hljs-comment">/* socket */</span>
                    props.rightSuppress = <span class="hljs-keyword">this</span>.items[index+<span class="hljs-number">1</span>].isSymbol;
                }
                <span class="hljs-keyword">this</span>.drawSymbol(item, index, props);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.itemBBox[index].width() &gt; <span class="hljs-number">0</span> ||
                       <span class="hljs-keyword">this</span>.itemBBox[index].height() &gt; <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>draw the bottom border of the child.
(skip this if this is a zero-size item)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> bb = <span class="hljs-keyword">this</span>.itemBBox[index];
                <span class="hljs-keyword">this</span>.canvas.lineTo(bb.indent());
                <span class="hljs-keyword">this</span>.canvas.lineTo(bb.left(), bb.indent().y);
                <span class="hljs-keyword">this</span>.canvas.lineTo(bb.bl());
                <span class="hljs-keyword">this</span>.canvas.lineTo(bb.widow().x, bb.bottom());
            }
        }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>now draw around my bounding box.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.bbox.widow().x, <span class="hljs-keyword">this</span>.bbox.bottom());
        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.bbox.bl());
        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.bbox.left(), <span class="hljs-keyword">this</span>.bbox.indent().y);
        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.bbox.indent());

        <span class="hljs-keyword">this</span>.canvas.closePath();
        <span class="hljs-keyword">this</span>.canvas.fill();
        <span class="hljs-keyword">this</span>.canvas.stroke();
    });
    SeparatedListWidget.drawInterior = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{};
    SeparatedListWidget.drawChildren = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.items.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item, index</span>) </span>{
            <span class="hljs-keyword">if</span> (item.widget) {
                <span class="hljs-keyword">this</span>.canvas.withContext(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                    <span class="hljs-keyword">this</span>.canvas.translate(<span class="hljs-keyword">this</span>.itemPos[index]);
                    item.widget.draw();
                });
            }
        }, <span class="hljs-keyword">this</span>);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>lists (of exprs/names).
XXX should eventually provide means for line wrapping.
XXX each comma should have a &#39;line break after&#39; property,
    but toggling between &quot;each arg on its own line&quot; and &quot;all on one line&quot;
    is probably fine for now.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> CommaListWidget = <span class="hljs-built_in">Object</span>.create(SeparatedListWidget);
    CommaListWidget.length = <span class="hljs-number">0</span>;
    CommaListWidget.addChild = ContainerWidget.addChild;
    CommaListWidget.label = <span class="hljs-string">","</span>;
    CommaListWidget.children = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.length === <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-keyword">this</span>.disallowEmptyList) {
            <span class="hljs-keyword">return</span> [ YadaWidget ];
        }
        <span class="hljs-keyword">return</span> ContainerWidget.children.call(<span class="hljs-keyword">this</span>);
    };
    CommaListWidget.computeItems = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.length === <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-keyword">this</span>.disallowEmptyList) {
            <span class="hljs-keyword">return</span> [ { <span class="hljs-attr">widget</span>: YadaWidget } ];
        }
        <span class="hljs-keyword">this</span>.size = <span class="hljs-keyword">this</span>.computeSize(properties);
        <span class="hljs-keyword">var</span> result = [];
        <span class="hljs-keyword">var</span> comma = { <span class="hljs-attr">bbox</span>: <span class="hljs-keyword">this</span>.size, <span class="hljs-attr">isSymbol</span>: <span class="hljs-literal">true</span> };</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>line break!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> commaNL = <span class="hljs-built_in">Object</span>.create(comma);
        commaNL.bbox = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">props</span>) </span>{
            <span class="hljs-keyword">if</span> (props.margin &gt; -<span class="hljs-keyword">this</span>.styles.commaBreakWidth) {
                <span class="hljs-keyword">return</span> comma.bbox;
            }
            <span class="hljs-keyword">return</span> comma.bbox.linebreak(props.margin, props.lineHeight).
                pad({<span class="hljs-attr">widowx</span>: <span class="hljs-keyword">this</span>.styles.expWidth });
        }.bind(<span class="hljs-keyword">this</span>);
        <span class="hljs-built_in">Array</span>.prototype.forEach.call(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">child, idx</span>) </span>{
            <span class="hljs-keyword">if</span> (idx !== <span class="hljs-number">0</span>) {
                result.push( commaNL );
            }
            result.push( { <span class="hljs-attr">widget</span>:child, <span class="hljs-attr">isName</span>: <span class="hljs-keyword">this</span>.isName || <span class="hljs-literal">false</span> } );
        }, <span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> result;
    };

    CommaListWidget.extraPadding = { <span class="hljs-attr">left</span>: <span class="hljs-number">-3</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">-3</span> }; <span class="hljs-comment">// tighten up</span>
    CommaListWidget.computeSize = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">var</span> r = <span class="hljs-keyword">this</span>.pad(<span class="hljs-keyword">this</span>.canvas.measureText(<span class="hljs-keyword">this</span>.label));</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>pad to account for expression sockets on both sides.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        r = <span class="hljs-keyword">this</span>.pad(r, { <span class="hljs-attr">left</span>: <span class="hljs-keyword">this</span>.styles.expWidth,
                          <span class="hljs-attr">right</span>: <span class="hljs-keyword">this</span>.styles.expWidth }, <span class="hljs-literal">true</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.pad(r, <span class="hljs-keyword">this</span>.extraPadding, <span class="hljs-literal">true</span>);
    });
    CommaListWidget.drawInterior = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> offset = <span class="hljs-keyword">this</span>.styles.expWidth + (<span class="hljs-keyword">this</span>.extraPadding.left || <span class="hljs-number">0</span>);
        <span class="hljs-keyword">this</span>.items.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item, index</span>) </span>{
            <span class="hljs-keyword">if</span> (!item.widget) {
                <span class="hljs-keyword">var</span> pos = <span class="hljs-keyword">this</span>.itemPos[index];
                <span class="hljs-keyword">this</span>.drawPaddedText(<span class="hljs-keyword">this</span>.label, pos.add(offset,<span class="hljs-number">0</span>),
                                    <span class="hljs-keyword">this</span>.styles.semiColor);
            }
        }, <span class="hljs-keyword">this</span>);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>make a prefix operator widget</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> PrefixWidget = <span class="hljs-built_in">Object</span>.create(SeparatedListWidget);
    PrefixWidget.operator = <span class="hljs-string">"?"</span>;
    PrefixWidget.rightOperand = YadaWidget;
    PrefixWidget.computeItems = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">var</span> addBBox = PrefixWidget.computeSizeOf.bind(<span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> [ addBBox({ <span class="hljs-attr">isSymbol</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">operator</span>: <span class="hljs-keyword">this</span>.operator }),
                 { <span class="hljs-attr">widget</span>: <span class="hljs-keyword">this</span>.rightOperand } ];
    };
    PrefixWidget.computeSizeOf = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item, properties</span>) </span>{
        <span class="hljs-keyword">var</span> txt = item.noPad ? item.operator : (<span class="hljs-string">" "</span>+item.operator+<span class="hljs-string">" "</span>);
        <span class="hljs-keyword">var</span> r = <span class="hljs-keyword">this</span>.pad(<span class="hljs-keyword">this</span>.canvas.measureText(txt));
        r = <span class="hljs-keyword">this</span>.pad(r, { <span class="hljs-attr">right</span>: <span class="hljs-keyword">this</span>.styles.expWidth <span class="hljs-comment">/* for sockets */</span>});
        item.bbox = r;
        <span class="hljs-keyword">return</span> item;
    });
    PrefixWidget.drawInterior = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> offset = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-keyword">this</span>.styles.expWidth / <span class="hljs-number">2</span>) - <span class="hljs-number">1</span>;
        <span class="hljs-keyword">this</span>.items.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item, index</span>) </span>{
            <span class="hljs-keyword">if</span> (item.isSymbol) {
                <span class="hljs-keyword">var</span> txt = item.noPad ? item.operator : (<span class="hljs-string">" "</span>+item.operator+<span class="hljs-string">" "</span>);
                <span class="hljs-keyword">this</span>.drawPaddedText(txt,
                                    <span class="hljs-keyword">this</span>.itemPos[index].add(offset, <span class="hljs-number">0</span>));
            }
        }, <span class="hljs-keyword">this</span>);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Infix operator (from prefix widget)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> InfixWidget = <span class="hljs-built_in">Object</span>.create(PrefixWidget);
    InfixWidget.leftOperand = YadaWidget;
    InfixWidget.computeItems = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">var</span> addBBox = PrefixWidget.computeSizeOf.bind(<span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> [ { <span class="hljs-attr">widget</span>: <span class="hljs-keyword">this</span>.leftOperand },
                 addBBox({ <span class="hljs-attr">isSymbol</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">operator</span>: <span class="hljs-keyword">this</span>.operator }),
                 { <span class="hljs-attr">widget</span>: <span class="hljs-keyword">this</span>.rightOperand } ];
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>make ([ operators from the infix widget</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> WithSuffixWidget = <span class="hljs-built_in">Object</span>.create(InfixWidget);
    WithSuffixWidget.closeOperator = <span class="hljs-string">'?'</span>;
    WithSuffixWidget.computeItems = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">var</span> addBBox = PrefixWidget.computeSizeOf.bind(<span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> [ { <span class="hljs-attr">widget</span>: <span class="hljs-keyword">this</span>.leftOperand },
                 addBBox({ <span class="hljs-attr">isSymbol</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">operator</span>: <span class="hljs-keyword">this</span>.operator,
                           <span class="hljs-attr">noPad</span>: <span class="hljs-literal">true</span> }),
                 { <span class="hljs-attr">widget</span>: <span class="hljs-keyword">this</span>.rightOperand },
                 addBBox({ <span class="hljs-attr">isSymbol</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">operator</span>: <span class="hljs-keyword">this</span>.closeOperator,
                           <span class="hljs-attr">noPad</span>: <span class="hljs-literal">true</span> }) ];
    };

    <span class="hljs-keyword">var</span> ParenWidget = <span class="hljs-built_in">Object</span>.create(SeparatedListWidget);
    ParenWidget.operand = YadaWidget;
    ParenWidget.computeItems = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">var</span> addBBox = PrefixWidget.computeSizeOf.bind(<span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> [ addBBox({ <span class="hljs-attr">isSymbol</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">operator</span>: <span class="hljs-string">'('</span>, <span class="hljs-attr">noPad</span>:<span class="hljs-literal">true</span> }),
                 { <span class="hljs-attr">widget</span>: <span class="hljs-keyword">this</span>.operand },
                 addBBox({ <span class="hljs-attr">isSymbol</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">operator</span>: <span class="hljs-string">')'</span>, <span class="hljs-attr">noPad</span>:<span class="hljs-literal">true</span> }) ];
    };
    ParenWidget.drawInterior= PrefixWidget.drawInterior;

    <span class="hljs-keyword">var</span> NewArrayWidget = <span class="hljs-built_in">Object</span>.create(SeparatedListWidget);
    NewArrayWidget._operand = CommaListWidget;
    NewArrayWidget.children = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._operand.children();
    };
    NewArrayWidget.addChild = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">child</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._operand === CommaListWidget) {</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>don&#39;t mutate the prototype</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>._operand = <span class="hljs-built_in">Object</span>.create(CommaListWidget);
        }
        <span class="hljs-keyword">this</span>._operand.addChild(child);
        <span class="hljs-keyword">this</span>.length = <span class="hljs-keyword">this</span>._operand.length;
    };
    NewArrayWidget.length = <span class="hljs-number">0</span>;
    NewArrayWidget.computeItems = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">var</span> addBBox = PrefixWidget.computeSizeOf.bind(<span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> [ addBBox({ <span class="hljs-attr">isSymbol</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">operator</span>: <span class="hljs-string">'['</span> }),
                 { <span class="hljs-attr">widget</span>: <span class="hljs-keyword">this</span>._operand },
                 addBBox({ <span class="hljs-attr">isSymbol</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">operator</span>: <span class="hljs-string">']'</span> }) ];
    };
    NewArrayWidget.drawInterior= PrefixWidget.drawInterior;

    <span class="hljs-keyword">var</span> ConditionalWidget = <span class="hljs-built_in">Object</span>.create(SeparatedListWidget);
    ConditionalWidget.testOperand = YadaWidget;
    ConditionalWidget.trueOperand = YadaWidget;
    ConditionalWidget.falseOperand= YadaWidget;
    ConditionalWidget.computeItems = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">var</span> addBBox = PrefixWidget.computeSizeOf.bind(<span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> [ { <span class="hljs-attr">widget</span>: <span class="hljs-keyword">this</span>.testOperand },
                 addBBox({ <span class="hljs-attr">isSymbol</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">operator</span>: <span class="hljs-string">'?'</span> }),
                 { <span class="hljs-attr">widget</span>: <span class="hljs-keyword">this</span>.trueOperand },
                 addBBox({ <span class="hljs-attr">isSymbol</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">operator</span>: <span class="hljs-string">':'</span> }),
                 { <span class="hljs-attr">widget</span>: <span class="hljs-keyword">this</span>.falseOperand } ];
    };
    ConditionalWidget.drawInterior= PrefixWidget.drawInterior;

    <span class="hljs-keyword">var</span> DotNameWidget = <span class="hljs-built_in">Object</span>.create(InfixWidget);
    DotNameWidget.computeItems = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">var</span> addBBox = PrefixWidget.computeSizeOf.bind(<span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">var</span> dotItem = addBBox({ <span class="hljs-attr">isSymbol</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">operator</span>: <span class="hljs-string">"."</span>, <span class="hljs-attr">noPad</span>: <span class="hljs-literal">true</span> });
        <span class="hljs-keyword">var</span> rightAdapter = rect(<span class="hljs-keyword">this</span>.styles.expWidth, dotItem.bbox.height());
        <span class="hljs-keyword">return</span> [ { <span class="hljs-attr">widget</span>: <span class="hljs-keyword">this</span>.leftOperand },
                 dotItem,
                 { <span class="hljs-attr">widget</span>: <span class="hljs-keyword">this</span>.rightOperand, <span class="hljs-attr">isName</span>: <span class="hljs-literal">true</span> },
                 { <span class="hljs-attr">bbox</span>: rightAdapter, <span class="hljs-attr">isSymbol</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">operator</span>: <span class="hljs-string">""</span> } ];
    };

    <span class="hljs-keyword">var</span> DotNameInvokeWidget = <span class="hljs-built_in">Object</span>.create(DotNameWidget);
    DotNameInvokeWidget.args = CommaListWidget;
    DotNameInvokeWidget.computeItems = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">var</span> addBBox = PrefixWidget.computeSizeOf.bind(<span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">var</span> items = DotNameWidget.computeItems.call(<span class="hljs-keyword">this</span>, properties);
        items[<span class="hljs-number">3</span>] = addBBox({ <span class="hljs-attr">isSymbol</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">operator</span>: <span class="hljs-string">"("</span>, <span class="hljs-attr">noPad</span>: <span class="hljs-literal">true</span> });
        items[<span class="hljs-number">4</span>] = { <span class="hljs-attr">widget</span>: <span class="hljs-keyword">this</span>.args };
        items[<span class="hljs-number">5</span>] = addBBox({ <span class="hljs-attr">isSymbol</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">operator</span>: <span class="hljs-string">")"</span>, <span class="hljs-attr">noPad</span>: <span class="hljs-literal">true</span> });
        <span class="hljs-keyword">return</span> items;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>object creation, contains a funny sort of expression list (vertical?)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> NewObjectWidget = <span class="hljs-built_in">Object</span>.create(SeparatedListWidget);
    NewObjectWidget.length = <span class="hljs-number">0</span>;
    NewObjectWidget.addChild = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name, value</span>) </span>{
        <span class="hljs-built_in">Array</span>.prototype.push.call(<span class="hljs-keyword">this</span>, {<span class="hljs-attr">name</span>:name, <span class="hljs-attr">value</span>:value});
    };
    NewObjectWidget.forEach = <span class="hljs-built_in">Array</span>.prototype.forEach;
    NewObjectWidget.computeItems = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">var</span> addBBox = PrefixWidget.computeSizeOf.bind(<span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">var</span> r = [];
        r.push(addBBox({ <span class="hljs-attr">isSymbol</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">operator</span>: <span class="hljs-string">'{'</span> }, properties));</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>set up our colon and comma bboxes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> colon = addBBox({ <span class="hljs-attr">isSymbol</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">operator</span>: <span class="hljs-string">": "</span>, <span class="hljs-attr">noPad</span>:<span class="hljs-literal">true</span> });
        <span class="hljs-keyword">var</span> comma = addBBox({ <span class="hljs-attr">isSymbol</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">operator</span>: <span class="hljs-string">", "</span>, <span class="hljs-attr">noPad</span>:<span class="hljs-literal">true</span> });
        <span class="hljs-keyword">var</span> lastComma = addBBox({ <span class="hljs-attr">isSymbol</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">operator</span>: <span class="hljs-string">" "</span>, <span class="hljs-attr">noPad</span>:<span class="hljs-literal">true</span> });</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>now add items.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item, index</span>) </span>{
            r.push({ <span class="hljs-attr">widget</span>: item.name, <span class="hljs-attr">isName</span>: <span class="hljs-literal">true</span> });
            r.push(colon);
            r.push({ <span class="hljs-attr">widget</span>: item.value, <span class="hljs-attr">indent</span>: <span class="hljs-keyword">this</span>.styles.blockIndent });
            <span class="hljs-keyword">if</span> ((index+<span class="hljs-number">1</span>) &lt; <span class="hljs-keyword">this</span>.length) {
                r.push(comma);
            } <span class="hljs-keyword">else</span> {
                r.push(lastComma);
            }
        }, <span class="hljs-keyword">this</span>);
        r.push(addBBox({ <span class="hljs-attr">isSymbol</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">operator</span>: <span class="hljs-string">'}'</span> }, properties));</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>break after each comma?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.length &gt; <span class="hljs-number">0</span>) { <span class="hljs-comment">// XXX USE BETTER MULTILINE CRITERION</span>
            <span class="hljs-keyword">var</span> indenter = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">old_bb, indent, props</span>) </span>{
                <span class="hljs-keyword">return</span> old_bb.linebreak(props.margin, props.lineHeight).
                    pad({ <span class="hljs-attr">widowx</span>: indent });
            };
            <span class="hljs-keyword">var</span> objIndent = <span class="hljs-keyword">this</span>.styles.objIndent;
            comma.bbox = indenter.bind(<span class="hljs-keyword">this</span>, comma.bbox, objIndent);
            r[<span class="hljs-number">0</span>].bbox = indenter.bind(<span class="hljs-keyword">this</span>, r[<span class="hljs-number">0</span>].bbox, objIndent);
            lastComma.bbox = indenter.bind(<span class="hljs-keyword">this</span>, lastComma.bbox, <span class="hljs-number">0</span>);
        }
        <span class="hljs-keyword">return</span> r;
    };
    NewObjectWidget.drawInterior = PrefixWidget.drawInterior;

    <span class="hljs-keyword">var</span> LabelledExpWidget = <span class="hljs-built_in">Object</span>.create(ExpWidget);
    LabelledExpWidget.computeSize = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">this</span>.setFont();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.pad(<span class="hljs-keyword">this</span>.canvas.measureText(<span class="hljs-keyword">this</span>.getLabel()));
    });
    LabelledExpWidget.drawInterior = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.setFont();
        <span class="hljs-keyword">this</span>.drawPaddedText(<span class="hljs-keyword">this</span>.getLabel(), pt(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>));
        <span class="hljs-keyword">return</span>;
    };
    LabelledExpWidget.getLabel = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.label;
    };
    LabelledExpWidget.setFont = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.canvas.setFill(<span class="hljs-keyword">this</span>.styles[<span class="hljs-keyword">this</span>.fontStyle]);
    };
    LabelledExpWidget.fontStyle = <span class="hljs-string">'textColor'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>A name.  Fits in an expression spot.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> NameWidget = <span class="hljs-built_in">Object</span>.create(LabelledExpWidget);
    NameWidget.name = <span class="hljs-string">'???'</span>; <span class="hljs-comment">// override</span>
    NameWidget.leftHandDir = <span class="hljs-number">-1</span>;
    NameWidget.rightHandDir = <span class="hljs-number">1</span>;
    NameWidget.isName = <span class="hljs-literal">true</span>;
    NameWidget.getLabel = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name;
    };
    NameWidget.setFont = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.canvas.setFontBold(<span class="hljs-literal">true</span>);
        <span class="hljs-keyword">this</span>.canvas.setFill(<span class="hljs-keyword">this</span>.styles.nameColor);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Name literal -- kinda like a name, but different.
XXX figure out exactly how this is different
XXX one way is that it can have non-name characters, in which
case it should render in quotes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> NameLiteralWidget = <span class="hljs-built_in">Object</span>.create(NameWidget);
    NameLiteralWidget.setFont = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.canvas.setFill(<span class="hljs-keyword">this</span>.styles.textColor);
    };
    NameLiteralWidget.setName = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>XXX if name has non-name characters, put it in quotes here?
I guess the &#39;with quotes&#39; rendering should really be dynamic?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.name = name;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Literals</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> THIS_TEXT = _(<span class="hljs-string">"this"</span>);
    <span class="hljs-keyword">var</span> ThisWidget = <span class="hljs-built_in">Object</span>.create(LabelledExpWidget);
    ThisWidget.label = THIS_TEXT;
    ThisWidget.fontStyle = <span class="hljs-string">'constColor'</span>;

    <span class="hljs-keyword">var</span> UNDEFINED_TEXT = _(<span class="hljs-string">"undefined"</span>);
    <span class="hljs-keyword">var</span> UndefinedWidget = <span class="hljs-built_in">Object</span>.create(LabelledExpWidget);
    UndefinedWidget.label = UNDEFINED_TEXT;
    UndefinedWidget.fontStyle = <span class="hljs-string">'constColor'</span>;

    <span class="hljs-keyword">var</span> NULL_TEXT = _(<span class="hljs-string">"null"</span>);
    <span class="hljs-keyword">var</span> NullWidget = <span class="hljs-built_in">Object</span>.create(LabelledExpWidget);
    NullWidget.label = NULL_TEXT;
    NullWidget.fontStyle = <span class="hljs-string">'constColor'</span>;

    <span class="hljs-keyword">var</span> NumericWidget = <span class="hljs-built_in">Object</span>.create(LabelledExpWidget);

    <span class="hljs-keyword">var</span> StringWidget = <span class="hljs-built_in">Object</span>.create(LabelledExpWidget);
    StringWidget.fontStyle = <span class="hljs-string">'literalColor'</span>;

    <span class="hljs-keyword">var</span> BooleanWidget = <span class="hljs-built_in">Object</span>.create(LabelledExpWidget);
    BooleanWidget.fontStyle = <span class="hljs-string">'constColor'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>end caps for statements, while expressions, etc</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> EndCapWidget = <span class="hljs-built_in">Object</span>.create(ExpWidget);
    EndCapWidget.computeSize = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">var</span> r = <span class="hljs-keyword">this</span>.pad(<span class="hljs-keyword">this</span>.canvas.measureText(<span class="hljs-keyword">this</span>.label));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.pad(r, <span class="hljs-keyword">this</span>.extraPadding, <span class="hljs-literal">true</span><span class="hljs-comment">/*shift origin*/</span>);
    });
    EndCapWidget.drawInterior = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.drawPaddedText(<span class="hljs-keyword">this</span>.label, pt(<span class="hljs-keyword">this</span>.extraPadding.left||<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
                            <span class="hljs-keyword">this</span>.styles.semiColor);
    };
    EndCapWidget.extraPadding = { <span class="hljs-attr">left</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">0</span> };
    EndCapWidget.leftHandDir = <span class="hljs-number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>round right-hand side</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    EndCapWidget.bottomPath = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.size.bottom());
    };
    EndCapWidget.rightHandPath = CeeWidget.rightHandPath;</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>semicolon terminating an expression statement</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> SEMI_TEXT = <span class="hljs-string">";"</span>;
    <span class="hljs-keyword">var</span> SemiWidget = <span class="hljs-built_in">Object</span>.create(EndCapWidget);
    SemiWidget.label = SEMI_TEXT;
    SemiWidget.extraPadding = { <span class="hljs-attr">left</span>: <span class="hljs-number">4</span> };
    SemiWidget.bgColor = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.styles.stmtColor; };</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>while/if end cap</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> ParenBraceWidget = <span class="hljs-built_in">Object</span>.create(EndCapWidget);
    ParenBraceWidget.label = <span class="hljs-string">") {"</span>;
    ParenBraceWidget.extraPadding = { <span class="hljs-attr">left</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">right</span>: <span class="hljs-number">4</span> };
    ParenBraceWidget.bgColor = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.styles.stmtColor; };</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>expression statement tile; takes an expression on the right.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> ExpStmtWidget = <span class="hljs-built_in">Object</span>.create(CeeWidget);
    ExpStmtWidget.bgColor = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.styles.stmtColor; };
    ExpStmtWidget.rightHandDir = <span class="hljs-number">-1</span>;
    ExpStmtWidget.rightHandPath = ExpWidget.rightHandPath;
    ExpStmtWidget.expression = YadaWidget; <span class="hljs-comment">// default</span>
    ExpStmtWidget.semiProto = SemiWidget; <span class="hljs-comment">// allow subclass to customize</span>
    ExpStmtWidget.children = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>create this in the instance because we tweak its size directly</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.semi) { <span class="hljs-keyword">this</span>.semi = <span class="hljs-built_in">Object</span>.create(<span class="hljs-keyword">this</span>.semiProto); }
        <span class="hljs-keyword">return</span> [ <span class="hljs-keyword">this</span>.expression, <span class="hljs-keyword">this</span>.semi ];
    };
    ExpStmtWidget.computeSize = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.pad(rect(<span class="hljs-keyword">this</span>.styles.puzzleIndent +
                             <span class="hljs-keyword">this</span>.styles.puzzleRadius +
                             <span class="hljs-keyword">this</span>.styles.expWidth,
                             <span class="hljs-keyword">this</span>.styles.textHeight), <span class="hljs-keyword">this</span>.styles.tilePadding,
                       <span class="hljs-literal">true</span><span class="hljs-comment">/*shift origin*/</span>);
    };
    ExpStmtWidget.computeBBox = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>adjust margin to move expression continuations past our
left-hand side.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> indent = <span class="hljs-keyword">this</span>.computeSize(properties);
        <span class="hljs-keyword">var</span> nprop = <span class="hljs-built_in">Object</span>.create(properties);
        nprop.margin += indent.width();</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>compute &#39;natural&#39; size</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> bb = HorizWidget.computeBBox.call(<span class="hljs-keyword">this</span>, nprop);</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>now adjust so that our height and semicolon height match the
height of the RHS expression (including indent and widow)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.size = <span class="hljs-keyword">this</span>.size.ensureHeight(<span class="hljs-keyword">this</span>.expression.bbox.bottom());

        <span class="hljs-keyword">var</span> lastLineHeight = <span class="hljs-keyword">this</span>.size.height()-<span class="hljs-keyword">this</span>.expression.bbox.widow().y;
        <span class="hljs-keyword">this</span>.semi.bbox = <span class="hljs-keyword">this</span>.semi.size =
            <span class="hljs-keyword">this</span>.semi.size.ensureHeight(lastLineHeight);

        <span class="hljs-keyword">return</span> bb;
    };
    ExpStmtWidget.draw = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>draw me</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        ExpStmtWidget.__proto__.draw.call(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>draw my children</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> canvas = <span class="hljs-keyword">this</span>.canvas;
        canvas.translate(<span class="hljs-keyword">this</span>.size.widow());
        <span class="hljs-keyword">this</span>.children().forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>{
            c.draw();
            canvas.translate(c.bbox.widow());
        });
    });

    <span class="hljs-keyword">var</span> LabelledExpStmtWidget = <span class="hljs-built_in">Object</span>.create(ExpStmtWidget);
    LabelledExpStmtWidget.label = <span class="hljs-string">"&lt;override me&gt;"</span>;
    LabelledExpStmtWidget.computeSize = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">var</span> r = <span class="hljs-keyword">this</span>.pad(<span class="hljs-keyword">this</span>.canvas.measureText(<span class="hljs-keyword">this</span>.label+<span class="hljs-string">" "</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>indent the text to match expression statements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.indent =  ExpStmtWidget.computeSize.call(<span class="hljs-keyword">this</span>, properties).right();</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>make room for rhs socket</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.pad(r, { <span class="hljs-attr">left</span>: <span class="hljs-keyword">this</span>.indent,
                             <span class="hljs-attr">right</span>: <span class="hljs-keyword">this</span>.styles.expWidth }, <span class="hljs-literal">true</span><span class="hljs-comment">/*shift*/</span>);
    });
    LabelledExpStmtWidget.drawInterior = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>indent the text to match expression statements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.drawPaddedText(<span class="hljs-keyword">this</span>.label, pt(<span class="hljs-keyword">this</span>.indent, <span class="hljs-number">0</span>),
                            <span class="hljs-keyword">this</span>.styles.keywordColor);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>simple break statement tile.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> BREAK_TEXT = _(<span class="hljs-string">"break"</span>);
    <span class="hljs-keyword">var</span> BreakWidget = <span class="hljs-built_in">Object</span>.create(CeeWidget);
    BreakWidget.bgColor = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.styles.stmtColor; };
    BreakWidget.computeSize = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">var</span> r = <span class="hljs-keyword">this</span>.pad(<span class="hljs-keyword">this</span>.canvas.measureText(BREAK_TEXT+SEMI_TEXT));</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>indent the text to match expression statements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.indent =  ExpStmtWidget.computeSize.call(<span class="hljs-keyword">this</span>, properties).right();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.pad(r, {<span class="hljs-attr">left</span>: <span class="hljs-keyword">this</span>.indent }, <span class="hljs-literal">true</span>);
    });
    BreakWidget.drawInterior = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>indent the text to match expression statements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> x = <span class="hljs-keyword">this</span>.indent;
        <span class="hljs-keyword">this</span>.drawPaddedText(BREAK_TEXT, pt(x, <span class="hljs-number">0</span>), <span class="hljs-keyword">this</span>.styles.keywordColor);
        x += <span class="hljs-keyword">this</span>.canvas.measureText(BREAK_TEXT).width;
        <span class="hljs-keyword">this</span>.drawPaddedText(SEMI_TEXT, pt(x, <span class="hljs-number">0</span>), <span class="hljs-keyword">this</span>.styles.semiColor);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>return statement tile; takes an expression on the right</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> RETURN_TEXT = _(<span class="hljs-string">"return"</span>);
    <span class="hljs-keyword">var</span> ReturnWidget = <span class="hljs-built_in">Object</span>.create(LabelledExpStmtWidget);
    ReturnWidget.label = RETURN_TEXT;</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>var statement, holds a name list.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> VAR_TEXT = _(<span class="hljs-string">"var"</span>);
    <span class="hljs-keyword">var</span> VarWidget = <span class="hljs-built_in">Object</span>.create(LabelledExpStmtWidget);
    VarWidget.label = VAR_TEXT;
    VarWidget.isName = <span class="hljs-literal">true</span>;
    VarWidget.semiProto = <span class="hljs-built_in">Object</span>.create(SemiWidget);
    VarWidget.semiProto.isName = <span class="hljs-literal">true</span>;
    VarWidget.expression = <span class="hljs-built_in">Object</span>.create(YadaWidget);
    VarWidget.expression.isName = <span class="hljs-literal">true</span>;
    VarWidget.addName = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">nameWidget</span>) </span>{
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.hasOwnProperty(<span class="hljs-string">"expression"</span>)) {
            <span class="hljs-keyword">this</span>.expression = <span class="hljs-built_in">Object</span>.create(CommaListWidget);
            <span class="hljs-keyword">this</span>.expression.isName = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">this</span>.expression.addChild(nameWidget);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>Invisible vertical stacking container</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> BlockWidget = <span class="hljs-built_in">Object</span>.create(Widget);
    BlockWidget.length = <span class="hljs-number">0</span>; <span class="hljs-comment">// this is an array-like object.</span>
    BlockWidget.addChild = ContainerWidget.addChild;
    BlockWidget.children = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> r = [];
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.vars) { r.push(<span class="hljs-keyword">this</span>.vars); }
        <span class="hljs-keyword">return</span> r.concat(ContainerWidget.children.call(<span class="hljs-keyword">this</span>));
    };
    BlockWidget.addVar = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">nameWidget</span>) </span>{
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.vars) { <span class="hljs-keyword">this</span>.vars = <span class="hljs-built_in">Object</span>.create(VarWidget); }
        <span class="hljs-keyword">this</span>.vars.addName(nameWidget);
    };
    BlockWidget.computeSize = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">return</span> rect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// no size of our own</span>
    };
    BlockWidget.computeBBox = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>add a little padding below last block</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.pad(VertWidget.computeBBox.call(<span class="hljs-keyword">this</span>, properties),
                        { <span class="hljs-attr">bottom</span>: <span class="hljs-keyword">this</span>.styles.blockBottomPadding });
    };
    BlockWidget.draw = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> children = <span class="hljs-keyword">this</span>.children();
        <span class="hljs-keyword">var</span> drawChild = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c, idx</span>) </span>{
            <span class="hljs-keyword">this</span>.canvas.translate(<span class="hljs-keyword">this</span>.childOrigin[idx]);
            c.draw();
        });

        children.forEach(drawChild, <span class="hljs-keyword">this</span>);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>function expression, contains a name list and a block
XXX render functions w/ no body inline?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> FUNCTION_TEXT = _(<span class="hljs-string">"function"</span>);
    <span class="hljs-keyword">var</span> FunctionWidget = <span class="hljs-built_in">Object</span>.create(Widget);
    FunctionWidget.label = FUNCTION_TEXT;
    FunctionWidget.children = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> r = [];
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.args) {
            <span class="hljs-keyword">this</span>.args = <span class="hljs-built_in">Object</span>.create(CommaListWidget);
            <span class="hljs-keyword">this</span>.args.isName = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">this</span>.args.disallowEmptyList = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.block) {
            <span class="hljs-keyword">this</span>.block = <span class="hljs-built_in">Object</span>.create(BlockWidget);
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.name) { r.push(<span class="hljs-keyword">this</span>.name); }
        <span class="hljs-keyword">return</span> r.concat(<span class="hljs-keyword">this</span>.args, <span class="hljs-keyword">this</span>.block);
    };
    FunctionWidget.computeBBox = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">this</span>.children(); <span class="hljs-comment">// initialize fields as side effect</span>

        <span class="hljs-keyword">this</span>.functionBB = <span class="hljs-keyword">this</span>.pad(<span class="hljs-keyword">this</span>.canvas.measureText(FUNCTION_TEXT+<span class="hljs-string">" "</span>));

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.name) {
            <span class="hljs-keyword">this</span>.name.layout(<span class="hljs-keyword">this</span>.canvas, <span class="hljs-keyword">this</span>.styles, properties);
            <span class="hljs-keyword">this</span>.nameBB = <span class="hljs-keyword">this</span>.name.bbox; <span class="hljs-comment">// simple bounding box</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">this</span>.nameBB = rect(<span class="hljs-keyword">this</span>.styles.functionNameSpace,
                               <span class="hljs-keyword">this</span>.functionBB.height());
        }
        <span class="hljs-keyword">this</span>.nameBB = <span class="hljs-keyword">this</span>.nameBB.translate(<span class="hljs-keyword">this</span>.functionBB.widow());

        <span class="hljs-keyword">this</span>.leftParenBB = <span class="hljs-keyword">this</span>.pad(<span class="hljs-keyword">this</span>.canvas.measureText(<span class="hljs-string">" ("</span>));
        <span class="hljs-keyword">this</span>.leftParenBB = <span class="hljs-keyword">this</span>.leftParenBB.translate(<span class="hljs-keyword">this</span>.nameBB.widow());</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>args could be multiline, but aligns at the open paren</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> arg_props = <span class="hljs-built_in">Object</span>.create(properties);
        arg_props.lineHeight = arg_props.margin = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>.args.layout(<span class="hljs-keyword">this</span>.canvas, <span class="hljs-keyword">this</span>.styles, arg_props);
        <span class="hljs-keyword">this</span>.argsBB = <span class="hljs-keyword">this</span>.args.bbox;</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>adjust args to have a minimum height/width (even w/ no args)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.argsBB = <span class="hljs-keyword">this</span>.argsBB.ensureHeight(<span class="hljs-keyword">this</span>.styles.expHalfHeight*<span class="hljs-number">2</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.argsBB.width() &lt; <span class="hljs-keyword">this</span>.styles.functionNameSpace) {
            <span class="hljs-keyword">this</span>.argsBB=<span class="hljs-keyword">this</span>.argsBB.pad({<span class="hljs-attr">right</span>:<span class="hljs-keyword">this</span>.styles.functionNameSpace});
        }
        <span class="hljs-keyword">this</span>.argsBB = <span class="hljs-keyword">this</span>.argsBB.translate(<span class="hljs-keyword">this</span>.leftParenBB.widow());

        <span class="hljs-keyword">this</span>.rightParenBB = <span class="hljs-keyword">this</span>.pad(<span class="hljs-keyword">this</span>.canvas.measureText(<span class="hljs-string">") {"</span>));
        <span class="hljs-keyword">this</span>.rightParenBB = <span class="hljs-keyword">this</span>.rightParenBB.translate(<span class="hljs-keyword">this</span>.argsBB.widow());</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>ensure this is tall enough to cover args</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.rightParenBB =
            <span class="hljs-keyword">this</span>.rightParenBB.ensureHeight(<span class="hljs-keyword">this</span>.argsBB.widowHeight());</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>ensure rightParenBB is tall enough for everything else on the
first line (if we haven&#39;t line-wrapped yet)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.argsBB.multiline()) {
            <span class="hljs-keyword">this</span>.rightParenBB =
                <span class="hljs-keyword">this</span>.rightParenBB.ensureHeight(<span class="hljs-keyword">this</span>.leftParenBB.height(),
                                               <span class="hljs-keyword">this</span>.nameBB.height(),
                                               <span class="hljs-keyword">this</span>.functionBB.height());
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>ensure that we&#39;re taller than the lineheight context, so we can
shoot a runner underneath the left hand side.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.rightParenBB.bottom() &lt; (properties.lineHeight || <span class="hljs-number">0</span>)) {
            <span class="hljs-keyword">var</span> extraPad = properties.lineHeight - <span class="hljs-keyword">this</span>.rightParenBB.bottom();
            <span class="hljs-keyword">this</span>.rightParenBB = <span class="hljs-keyword">this</span>.rightParenBB.pad({<span class="hljs-attr">bottom</span>: extraPad});
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>add enough for an underline.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.rightParenBB =
            <span class="hljs-keyword">this</span>.rightParenBB.pad({<span class="hljs-attr">bottom</span>:<span class="hljs-keyword">this</span>.styles.expUnderHeight});</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>now we lay out the block</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> block_prop = <span class="hljs-built_in">Object</span>.create(properties);
        block_prop.margin = <span class="hljs-number">0</span>; <span class="hljs-comment">// already at the start of the line.</span>
        block_prop.lineHeight = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>.block.layout(<span class="hljs-keyword">this</span>.canvas, <span class="hljs-keyword">this</span>.styles, block_prop);
        <span class="hljs-keyword">this</span>.blockBB = <span class="hljs-keyword">this</span>.block.bbox;
        <span class="hljs-keyword">var</span> blkpt = pt(properties.margin + <span class="hljs-keyword">this</span>.styles.functionIndent,
                       <span class="hljs-keyword">this</span>.rightParenBB.bottom());
        <span class="hljs-keyword">this</span>.blockBB = <span class="hljs-keyword">this</span>.blockBB.translate(blkpt);</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>and the final close bracket</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.rightBraceBB = <span class="hljs-keyword">this</span>.pad(<span class="hljs-keyword">this</span>.canvas.measureText(<span class="hljs-string">"}"</span>));
        <span class="hljs-keyword">this</span>.rightBraceBB = <span class="hljs-keyword">this</span>.rightBraceBB.
            translate(pt(properties.margin, <span class="hljs-keyword">this</span>.blockBB.bottom()));</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>ok, add it all up!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> firstLineWidth = <span class="hljs-keyword">this</span>.rightParenBB.right(); <span class="hljs-comment">// XXX multiline</span>
        <span class="hljs-keyword">var</span> blockWidth = <span class="hljs-keyword">this</span>.blockBB.right();
        <span class="hljs-keyword">var</span> lastLineWidth = <span class="hljs-keyword">this</span>.rightBraceBB.right();

        <span class="hljs-keyword">var</span> w = <span class="hljs-built_in">Math</span>.max(firstLineWidth, blockWidth, lastLineWidth);
        <span class="hljs-keyword">var</span> h = <span class="hljs-keyword">this</span>.rightBraceBB.bottom();

        <span class="hljs-keyword">var</span> indent =
            pt(<span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.rightParenBB.bottom() - <span class="hljs-keyword">this</span>.styles.expUnderHeight);
        <span class="hljs-keyword">var</span> widow = <span class="hljs-keyword">this</span>.rightBraceBB.tr();
        <span class="hljs-keyword">return</span> mlbbox(pt(properties.margin, <span class="hljs-number">0</span>), pt(w, h), indent, widow);
    });
    FunctionWidget.draw = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.drawOutline();
        <span class="hljs-keyword">this</span>.drawInterior();
        <span class="hljs-keyword">this</span>.drawChildren();
    };
    FunctionWidget.drawOutline = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">this</span>.canvas.setFill(<span class="hljs-keyword">this</span>.bgColor());
        <span class="hljs-keyword">this</span>.canvas.beginPath();</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>expression plug on left</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.drawCapDown(pt(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>), <span class="hljs-literal">true</span><span class="hljs-comment">/*plug*/</span>, <span class="hljs-literal">false</span><span class="hljs-comment">/*left*/</span>, <span class="hljs-literal">false</span><span class="hljs-comment">/*exp*/</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>first line indent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.bbox.indent());
        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.bbox.left(), <span class="hljs-keyword">this</span>.bbox.indent().y);</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>all the way down to the bottom</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.bbox.bl());</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>to the end of rightBrace</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.rightBraceBB.br());</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>expression plug on right</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.drawCapUp(<span class="hljs-keyword">this</span>.rightBraceBB.tr(),
                       <span class="hljs-literal">true</span><span class="hljs-comment">/*plug*/</span>, <span class="hljs-literal">true</span><span class="hljs-comment">/*right*/</span>, <span class="hljs-literal">false</span><span class="hljs-comment">/*exp*/</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>back up past block to bottom of right paren</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.bbox.left() + <span class="hljs-keyword">this</span>.styles.functionIndent,
                           <span class="hljs-keyword">this</span>.rightBraceBB.top());
        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.bbox.left() + <span class="hljs-keyword">this</span>.styles.functionIndent,
                           <span class="hljs-keyword">this</span>.rightParenBB.bottom());</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>puzzle plug</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.arc(<span class="hljs-keyword">this</span>.bbox.left() + <span class="hljs-keyword">this</span>.styles.functionIndent +
                        <span class="hljs-keyword">this</span>.styles.puzzleIndent + <span class="hljs-keyword">this</span>.styles.puzzleRadius,
                        <span class="hljs-keyword">this</span>.rightParenBB.bottom(), <span class="hljs-keyword">this</span>.styles.puzzleRadius,
                        <span class="hljs-built_in">Math</span>.PI, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>circle right paren</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.drawRoundCorner(<span class="hljs-keyword">this</span>.rightParenBB.br(), <span class="hljs-number">1</span>, <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">this</span>.drawRoundCorner(<span class="hljs-keyword">this</span>.rightParenBB.tr(), <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <p>arg list name socket (right side of arg list; left side socket)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.drawCapDown(<span class="hljs-keyword">this</span>.rightParenBB.tl(),
                         <span class="hljs-literal">false</span><span class="hljs-comment">/*socket*/</span>, <span class="hljs-literal">false</span><span class="hljs-comment">/*left*/</span>, <span class="hljs-literal">true</span><span class="hljs-comment">/*name*/</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>underline the arg list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.argsBB.widow().x, <span class="hljs-keyword">this</span>.argsBB.bottom());
        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.argsBB.bl());
        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.argsBB.left(), <span class="hljs-keyword">this</span>.argsBB.indent().y);
        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.argsBB.indent());</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>arg list name socket (left side of arg list; right side socket)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.drawCapUp(pt(<span class="hljs-keyword">this</span>.argsBB.indent().x, <span class="hljs-keyword">this</span>.argsBB.top()),
                         <span class="hljs-literal">false</span><span class="hljs-comment">/*socket*/</span>, <span class="hljs-literal">true</span><span class="hljs-comment">/*right*/</span>, <span class="hljs-literal">true</span><span class="hljs-comment">/*name*/</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>function name socket (right side of name; left side socket)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.drawCapDown(<span class="hljs-keyword">this</span>.leftParenBB.tl(),
                         <span class="hljs-literal">false</span><span class="hljs-comment">/*socket*/</span>, <span class="hljs-literal">false</span><span class="hljs-comment">/*left*/</span>, <span class="hljs-literal">true</span><span class="hljs-comment">/*name*/</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>underline the function name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.nameBB.br());
        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.nameBB.bl());</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>function name socket (left side of name; right side socket)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.drawCapUp(<span class="hljs-keyword">this</span>.nameBB.tl(),
                       <span class="hljs-literal">false</span><span class="hljs-comment">/*socket*/</span>, <span class="hljs-literal">true</span><span class="hljs-comment">/*right*/</span>, <span class="hljs-literal">true</span><span class="hljs-comment">/*name*/</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>we&#39;re done!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.closePath();
        <span class="hljs-keyword">this</span>.canvas.fill();
        <span class="hljs-keyword">this</span>.canvas.stroke();
    });
    FunctionWidget.drawInterior = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>draw function label</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.drawPaddedText(FUNCTION_TEXT, <span class="hljs-keyword">this</span>.functionBB.tl(),
                            <span class="hljs-keyword">this</span>.styles.keywordColor);</pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>draw open paren</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.drawPaddedText(<span class="hljs-string">" ("</span>, <span class="hljs-keyword">this</span>.leftParenBB.tl(), <span class="hljs-keyword">this</span>.styles.semiColor);</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>draw close paren</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.drawPaddedText(<span class="hljs-string">") {"</span>,<span class="hljs-keyword">this</span>.rightParenBB.tl(),<span class="hljs-keyword">this</span>.styles.semiColor);</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p>draw close brace</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.drawPaddedText(<span class="hljs-string">"}"</span>, <span class="hljs-keyword">this</span>.rightBraceBB.tl(), <span class="hljs-keyword">this</span>.styles.semiColor);
    });
    FunctionWidget.drawChildren = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>draw function name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.withContext(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">this</span>.canvas.translate(<span class="hljs-keyword">this</span>.nameBB.tl());
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.name) {
                <span class="hljs-keyword">this</span>.name.draw();
            }
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>draw args list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.withContext(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">this</span>.canvas.translate(<span class="hljs-keyword">this</span>.argsBB.indent().x, <span class="hljs-keyword">this</span>.argsBB.top());
            <span class="hljs-keyword">this</span>.args.draw();
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>draw block</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.withContext(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">this</span>.canvas.translate(<span class="hljs-keyword">this</span>.blockBB.tl());
            <span class="hljs-keyword">this</span>.block.draw();
        });
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p>while statement tile. c-shaped, also takes a right hand expression.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> WHILE_TEXT = _(<span class="hljs-string">"while"</span>);
    <span class="hljs-keyword">var</span> WhileWidget = <span class="hljs-built_in">Object</span>.create(CeeWidget);
    WhileWidget.bgColor = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.styles.stmtColor; };
    WhileWidget.testExpr = YadaWidget;
    WhileWidget.label = WHILE_TEXT;
    WhileWidget.children = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.parenBrace) {
            <span class="hljs-keyword">this</span>.parenBrace = <span class="hljs-built_in">Object</span>.create(ParenBraceWidget);
        }
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.block) {
            <span class="hljs-keyword">this</span>.block = <span class="hljs-built_in">Object</span>.create(BlockWidget);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p>parenBrace is not a mutable child of this widget.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> [ <span class="hljs-keyword">this</span>.testExpr, <span class="hljs-keyword">this</span>.block ];
    };
    WhileWidget.computeSize = context_saved(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">var</span> w, h, indent;
        <span class="hljs-keyword">this</span>.children(); <span class="hljs-comment">// ensure children are defined/initialized</span>

        <span class="hljs-keyword">this</span>.topSize = <span class="hljs-keyword">this</span>.pad(<span class="hljs-keyword">this</span>.canvas.measureText(<span class="hljs-keyword">this</span>.label+<span class="hljs-string">" ("</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>make room for rhs socket</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.topSize = <span class="hljs-keyword">this</span>.pad(<span class="hljs-keyword">this</span>.topSize, { <span class="hljs-attr">right</span>: <span class="hljs-keyword">this</span>.styles.expWidth });</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>grow vertically to match test testExpr</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> test_props = <span class="hljs-built_in">Object</span>.create(properties);
        test_props.margin = test_props.lineHeight = <span class="hljs-number">0</span>; <span class="hljs-comment">// align with open paren</span>
        <span class="hljs-keyword">this</span>.testExpr.layout(<span class="hljs-keyword">this</span>.canvas, <span class="hljs-keyword">this</span>.styles, test_props);
        <span class="hljs-keyword">this</span>.topSize = <span class="hljs-keyword">this</span>.topSize.ensureHeight(<span class="hljs-keyword">this</span>.testExpr.bbox.bottom());</pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <p>increase the height to accomodate the block child.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> block_props = <span class="hljs-built_in">Object</span>.create(properties);
        block_props.margin = block_props.lineHeight = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>.block.layout(<span class="hljs-keyword">this</span>.canvas, <span class="hljs-keyword">this</span>.styles, block_props);
        h = <span class="hljs-keyword">this</span>.topSize.height();
        h += <span class="hljs-keyword">this</span>.block.bbox.bottom();
        <span class="hljs-keyword">this</span>.blockBottom = h;</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p>&quot;other block stuff&quot; (extension point used by IfWidget)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.indent = ExpStmtWidget.computeSize.call(<span class="hljs-keyword">this</span>, properties).right();
        h += <span class="hljs-keyword">this</span>.computeExtraBlockSize(properties);</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p>now accomodate the close brace below</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.braceY = h;
        <span class="hljs-keyword">this</span>.bottomSize = <span class="hljs-keyword">this</span>.pad(<span class="hljs-keyword">this</span>.canvas.measureText(<span class="hljs-string">"} "</span>));
        h += <span class="hljs-keyword">this</span>.bottomSize.height();</pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>indent the text to match expression statements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.topSize = <span class="hljs-keyword">this</span>.pad(<span class="hljs-keyword">this</span>.topSize, { <span class="hljs-attr">left</span>: <span class="hljs-keyword">this</span>.indent }, <span class="hljs-literal">true</span>);
        <span class="hljs-keyword">this</span>.bottomSize = <span class="hljs-keyword">this</span>.pad(<span class="hljs-keyword">this</span>.bottomSize, {<span class="hljs-attr">left</span>: <span class="hljs-keyword">this</span>.indent}, <span class="hljs-literal">true</span>);
        w = <span class="hljs-built_in">Math</span>.max(<span class="hljs-keyword">this</span>.topSize.width(), <span class="hljs-keyword">this</span>.bottomSize.width());

        <span class="hljs-keyword">this</span>.parenBrace.layout(<span class="hljs-keyword">this</span>.canvas, <span class="hljs-keyword">this</span>.styles, properties);

        <span class="hljs-keyword">return</span> rect(w, h);
    });
    WhileWidget.computeExtraBlockSize = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; };
    WhileWidget.computeBBox = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">var</span> w, h;
        <span class="hljs-keyword">this</span>.size = <span class="hljs-keyword">this</span>.computeSize(properties);
        <span class="hljs-keyword">var</span> sz0 = <span class="hljs-keyword">this</span>.testExpr.bbox;
        <span class="hljs-keyword">var</span> sz1 = <span class="hljs-keyword">this</span>.parenBrace.bbox;
        <span class="hljs-keyword">var</span> sz2 = <span class="hljs-keyword">this</span>.block.bbox;
        w = <span class="hljs-built_in">Math</span>.max(<span class="hljs-keyword">this</span>.size.width(),
                     sz1.width() + sz0.width() + <span class="hljs-keyword">this</span>.topSize.width(),
                     sz2.width() + <span class="hljs-keyword">this</span>.styles.blockIndent,
                     <span class="hljs-keyword">this</span>.bottomSize.width());</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>force trailing brace to match expression height</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.parenBrace.bbox = <span class="hljs-keyword">this</span>.parenBrace.size =
            <span class="hljs-keyword">this</span>.parenBrace.size.ensureHeight(<span class="hljs-keyword">this</span>.testExpr.bbox.widowHeight());

        <span class="hljs-keyword">return</span> rect(w, <span class="hljs-keyword">this</span>.size.height());
    };
    WhileWidget.rightHandPath = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.bottomSize.width() - <span class="hljs-keyword">this</span>.styles.tileCornerRadius,
                           <span class="hljs-keyword">this</span>.size.height());</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>bottom leg</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.drawRoundCorner(pt(<span class="hljs-keyword">this</span>.bottomSize.width(), <span class="hljs-keyword">this</span>.size.height()), <span class="hljs-number">1</span>, <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">this</span>.drawRoundCorner(pt(<span class="hljs-keyword">this</span>.bottomSize.width(),
                                <span class="hljs-keyword">this</span>.size.height() - <span class="hljs-keyword">this</span>.bottomSize.height()), <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>bottom puzzle piece socket</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.styles.blockIndent + <span class="hljs-keyword">this</span>.styles.puzzleIndent +
            <span class="hljs-number">2</span> * <span class="hljs-keyword">this</span>.styles.puzzleRadius &lt;=
            <span class="hljs-keyword">this</span>.bottomSize.width() - <span class="hljs-keyword">this</span>.styles.tileCornerRadius) {
        <span class="hljs-keyword">this</span>.canvas.arc(<span class="hljs-keyword">this</span>.styles.blockIndent + <span class="hljs-keyword">this</span>.styles.puzzleIndent +
                        <span class="hljs-keyword">this</span>.styles.puzzleRadius,
                        <span class="hljs-keyword">this</span>.size.height() - <span class="hljs-keyword">this</span>.bottomSize.height(),
                        <span class="hljs-keyword">this</span>.styles.tileCornerRadius,
                        <span class="hljs-number">0</span>, <span class="hljs-built_in">Math</span>.PI, <span class="hljs-literal">false</span>);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>inside of the C</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.styles.blockIndent,
                           <span class="hljs-keyword">this</span>.size.height() - <span class="hljs-keyword">this</span>.bottomSize.height());
        <span class="hljs-keyword">this</span>.extraRightHandPath(); <span class="hljs-comment">// hook for subclass</span>
        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.styles.blockIndent, <span class="hljs-keyword">this</span>.topSize.height());</pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <p>top puzzle piece plug</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.arc(<span class="hljs-keyword">this</span>.styles.blockIndent + <span class="hljs-keyword">this</span>.styles.puzzleIndent +
                        <span class="hljs-keyword">this</span>.styles.puzzleRadius, <span class="hljs-keyword">this</span>.topSize.height(),
                        <span class="hljs-keyword">this</span>.styles.puzzleRadius,
                        <span class="hljs-built_in">Math</span>.PI, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>);
        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.topSize.width(), <span class="hljs-keyword">this</span>.topSize.height());</pre></div></div>
            
        </li>
        
        
        <li id="section-151">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              <p>now the expression socket</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.drawCapUp(pt(<span class="hljs-keyword">this</span>.topSize.width(), <span class="hljs-number">0</span>),
                       <span class="hljs-literal">false</span><span class="hljs-comment">/*socket*/</span>, <span class="hljs-literal">true</span><span class="hljs-comment">/*right*/</span>, <span class="hljs-literal">false</span><span class="hljs-comment">/*exp*/</span>);
    };
    WhileWidget.extraRightHandPath = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ };
    WhileWidget.drawInterior = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-152">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              <p>indent the text to match expression statements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> x = <span class="hljs-keyword">this</span>.indent;
        <span class="hljs-keyword">this</span>.drawPaddedText(<span class="hljs-keyword">this</span>.label, pt(x, <span class="hljs-number">0</span>), <span class="hljs-keyword">this</span>.styles.keywordColor);
        <span class="hljs-keyword">var</span> wsz = <span class="hljs-keyword">this</span>.pad(<span class="hljs-keyword">this</span>.canvas.measureText(<span class="hljs-keyword">this</span>.label), {});
        <span class="hljs-keyword">this</span>.drawPaddedText(<span class="hljs-string">" ("</span>, pt(x+wsz.width(), <span class="hljs-number">0</span>), <span class="hljs-keyword">this</span>.styles.semiColor);
        <span class="hljs-keyword">var</span> y = <span class="hljs-keyword">this</span>.braceY - <span class="hljs-number">2</span>; <span class="hljs-comment">// cheat the brace upwards a bit.</span>
        <span class="hljs-keyword">this</span>.drawPaddedText(<span class="hljs-string">"}"</span>, pt(x, y), <span class="hljs-keyword">this</span>.styles.semiColor);</pre></div></div>
            
        </li>
        
        
        <li id="section-153">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              <p>now draw children</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.withContext(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">this</span>.canvas.translate(<span class="hljs-keyword">this</span>.topSize.widow());
            <span class="hljs-keyword">this</span>.testExpr.draw();
            <span class="hljs-keyword">this</span>.canvas.translate(<span class="hljs-keyword">this</span>.testExpr.bbox.widow());
            <span class="hljs-keyword">this</span>.parenBrace.draw();
        });
        <span class="hljs-keyword">this</span>.canvas.translate(<span class="hljs-keyword">this</span>.styles.blockIndent, <span class="hljs-keyword">this</span>.topSize.height());
        <span class="hljs-keyword">this</span>.block.draw();
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-154">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              <p>If statement widget, similar to the WhileWidget</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> IF_TEXT = _(<span class="hljs-string">"if"</span>);
    <span class="hljs-keyword">var</span> IF_ELSE_TEXT = _(<span class="hljs-string">"else"</span>);
    <span class="hljs-keyword">var</span> IfWidget = <span class="hljs-built_in">Object</span>.create(WhileWidget);
    IfWidget.label = IF_TEXT;
    IfWidget.children = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> children = IfWidget.__proto__.children.call(<span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.elseBlock) {
            children.push(<span class="hljs-keyword">this</span>.elseBlock);
        }
        <span class="hljs-keyword">return</span> children;
    };
    IfWidget.computeExtraBlockSize = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">properties</span>) </span>{
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.elseBlock) { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-155">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              <p>height of &#39;else&#39; clause and brace.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.elseBB = <span class="hljs-keyword">this</span>.pad(<span class="hljs-keyword">this</span>.canvas.measureText(
            <span class="hljs-string">"} "</span>+IF_ELSE_TEXT+<span class="hljs-string">" {"</span>)).translate(
                pt(<span class="hljs-keyword">this</span>.indent, <span class="hljs-keyword">this</span>.blockBottom));

        <span class="hljs-keyword">var</span> block_props = <span class="hljs-built_in">Object</span>.create(properties);
        block_props.margin = block_props.lineHeight = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>.elseBlock.layout(<span class="hljs-keyword">this</span>.canvas, <span class="hljs-keyword">this</span>.styles, block_props);
        <span class="hljs-keyword">this</span>.elseBlockBB = <span class="hljs-keyword">this</span>.elseBlock.bbox.translate(
            pt(<span class="hljs-keyword">this</span>.styles.blockIndent, <span class="hljs-keyword">this</span>.elseBB.bottom()));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.elseBlockBB.bottom() - <span class="hljs-keyword">this</span>.blockBottom;
    };
    IfWidget.extraRightHandPath = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.elseBlock) { <span class="hljs-keyword">return</span>; }

        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.styles.blockIndent, <span class="hljs-keyword">this</span>.elseBB.bottom());</pre></div></div>
            
        </li>
        
        
        <li id="section-156">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <p>make a puzzle piece plug</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.arc(<span class="hljs-keyword">this</span>.styles.blockIndent + <span class="hljs-keyword">this</span>.styles.puzzleIndent +
                        <span class="hljs-keyword">this</span>.styles.puzzleRadius, <span class="hljs-keyword">this</span>.elseBB.bottom(),
                        <span class="hljs-keyword">this</span>.styles.puzzleRadius,
                        <span class="hljs-built_in">Math</span>.PI, <span class="hljs-number">0</span>, <span class="hljs-literal">true</span>);
        <span class="hljs-keyword">this</span>.drawRoundCorner(<span class="hljs-keyword">this</span>.elseBB.br(), <span class="hljs-number">1</span>, <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">this</span>.drawRoundCorner(<span class="hljs-keyword">this</span>.elseBB.tr(), <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">this</span>.canvas.lineTo(<span class="hljs-keyword">this</span>.styles.blockIndent, <span class="hljs-keyword">this</span>.elseBB.top());
    };
    IfWidget.drawInterior = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.canvas.withContext(<span class="hljs-keyword">this</span>, IfWidget.__proto__.drawInterior);
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.elseBlock) { <span class="hljs-keyword">return</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-157">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              <p>draw the else keyword</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> pt = <span class="hljs-keyword">this</span>.elseBB.tl();
        pt = pt.add(<span class="hljs-number">0</span>, <span class="hljs-number">-2</span>); <span class="hljs-comment">// cheat up a bit.</span>
        <span class="hljs-keyword">this</span>.drawPaddedText(<span class="hljs-string">"} "</span>, pt, <span class="hljs-keyword">this</span>.styles.semiColor);
        pt = pt.add(<span class="hljs-keyword">this</span>.canvas.measureText(<span class="hljs-string">"} "</span>).width, <span class="hljs-number">0</span>);
        <span class="hljs-keyword">this</span>.drawPaddedText(IF_ELSE_TEXT, pt, <span class="hljs-keyword">this</span>.styles.keywordColor);
        pt = pt.add(<span class="hljs-keyword">this</span>.canvas.measureText(IF_ELSE_TEXT).width, <span class="hljs-number">0</span>);
        <span class="hljs-keyword">this</span>.drawPaddedText(<span class="hljs-string">" {"</span>, pt, <span class="hljs-keyword">this</span>.styles.semiColor);</pre></div></div>
            
        </li>
        
        
        <li id="section-158">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              <p>draw the else block.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.canvas.translate(<span class="hljs-keyword">this</span>.elseBlockBB.tl());
        <span class="hljs-keyword">this</span>.elseBlock.draw();
    };


    <span class="hljs-keyword">var</span> crender, crender_stmt, crender_stmts;
    <span class="hljs-keyword">var</span> indentation, prec_stack = [ <span class="hljs-number">0</span> ];

    <span class="hljs-keyword">var</span> assert = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">b, obj</span>) </span>{
        <span class="hljs-keyword">if</span> (!b) {
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'ASSERTION FAILURE'</span>, obj);
            <span class="hljs-built_in">console</span>.assert(<span class="hljs-literal">false</span>);
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-159">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <p>set the precedence to &#39;prec&#39; when evaluating f</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> with_prec = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">prec, f, obj</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> result;
            prec_stack.push(prec);
            result = f.apply(obj || <span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
            prec_stack.pop();
            <span class="hljs-keyword">return</span> result;
        };
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-160">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              <p>set the precedence, and parenthesize the result if appropriate.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> with_prec_paren = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">prec, f, obj</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> prev_prec = prec_stack[prec_stack.length - <span class="hljs-number">1</span>];
            <span class="hljs-keyword">var</span> result = with_prec(prec, f).apply(obj || <span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-161">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p>XXX this might be better done dynamically based on the
precedences of the widgets?  that would handle the drag &amp; drop
case better (where we need to dynamically add parens)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (prev_prec &gt; prec) {
                <span class="hljs-keyword">var</span> p = <span class="hljs-built_in">Object</span>.create(ParenWidget);
                p.operand = result;
                result = p;
            }
            <span class="hljs-keyword">return</span> result;
        };
    };

    <span class="hljs-keyword">var</span> dispatch = {};
    dispatch.name = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> nw = <span class="hljs-built_in">Object</span>.create(NameWidget);
        nw.name = <span class="hljs-keyword">this</span>.value;
        <span class="hljs-keyword">return</span> nw;
    };
    dispatch.literal = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> w;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.value === <span class="hljs-literal">undefined</span>) { <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.create(UndefinedWidget); }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.value === <span class="hljs-literal">null</span>) { <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.create(NullWidget); }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">this</span>.value)===<span class="hljs-string">'object'</span>) {
            w = <span class="hljs-built_in">Object</span>.create(LabelledExpWidget);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.value.length === <span class="hljs-number">0</span>) { w.label = <span class="hljs-string">"Array"</span>; <span class="hljs-keyword">return</span> w; }
            w.label = <span class="hljs-string">"Object"</span>;
            <span class="hljs-keyword">return</span> w;
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">this</span>.value)===<span class="hljs-string">'string'</span>) {
            w = <span class="hljs-built_in">Object</span>.create(StringWidget);
            w.label = str_escape(<span class="hljs-keyword">this</span>.value);
            <span class="hljs-keyword">return</span> w;
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">this</span>.value)===<span class="hljs-string">'boolean'</span>) {
            w = <span class="hljs-built_in">Object</span>.create(BooleanWidget);
            w.label = <span class="hljs-keyword">this</span>.value.toString();
            <span class="hljs-keyword">return</span> w;
        }
        w = <span class="hljs-built_in">Object</span>.create(NumericWidget);
        w.label = <span class="hljs-keyword">this</span>.value.toString();
        <span class="hljs-keyword">return</span> w;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-162">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <p>UNARY ASTs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch.unary = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        assert(dispatch.unary[<span class="hljs-keyword">this</span>.value], <span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> dispatch.unary[<span class="hljs-keyword">this</span>.value].apply(<span class="hljs-keyword">this</span>);
    };
    <span class="hljs-keyword">var</span> unary = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">op, prec, f</span>) </span>{
        dispatch.unary[op] = f || with_prec_paren(prec, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> pw = <span class="hljs-built_in">Object</span>.create(PrefixWidget);
            pw.operator = <span class="hljs-keyword">this</span>.value;
            pw.rightOperand = crender(<span class="hljs-keyword">this</span>.first);
            <span class="hljs-keyword">return</span> pw;
        });
    };
    unary(<span class="hljs-string">'!'</span>, <span class="hljs-number">70</span>);
    unary(<span class="hljs-string">'-'</span>, <span class="hljs-number">70</span>);
    unary(<span class="hljs-string">'typeof'</span>, <span class="hljs-number">70</span>);

    unary(<span class="hljs-string">'['</span>, <span class="hljs-number">90</span>, with_prec_paren(<span class="hljs-number">90</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> w = <span class="hljs-built_in">Object</span>.create(NewArrayWidget);
        <span class="hljs-keyword">this</span>.first.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>{
            w.addChild(with_prec(<span class="hljs-number">0</span>, crender)(c));
        });
        <span class="hljs-keyword">return</span> w;
    }));
    unary(<span class="hljs-string">'{'</span>, <span class="hljs-number">90</span>, with_prec_paren(<span class="hljs-number">90</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-163">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              <p>new object creation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> w = <span class="hljs-built_in">Object</span>.create(NewObjectWidget);
        <span class="hljs-keyword">this</span>.first.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
            <span class="hljs-keyword">var</span> name = <span class="hljs-built_in">Object</span>.create(NameLiteralWidget);
            name.setName(item.key);
            w.addChild(name, with_prec(<span class="hljs-number">0</span>, crender)(item));
        });
        <span class="hljs-keyword">return</span> w;
    }));</pre></div></div>
            
        </li>
        
        
        <li id="section-164">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              <p>Binary ASTs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch.binary = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        assert(dispatch.binary[<span class="hljs-keyword">this</span>.value], <span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> dispatch.binary[<span class="hljs-keyword">this</span>.value].apply(<span class="hljs-keyword">this</span>);
    };
    <span class="hljs-keyword">var</span> binary = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">op, prec, f, is_right</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-165">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-165">&#182;</a>
              </div>
              <p>with_prec_paren will add parentheses if necessary</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        dispatch.binary[op] = f || with_prec_paren(prec, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> iw = <span class="hljs-built_in">Object</span>.create(InfixWidget);
            iw.operator = <span class="hljs-keyword">this</span>.value;
            iw.leftOperand = crender(<span class="hljs-keyword">this</span>.first);
            iw.rightOperand = with_prec(is_right ? (prec<span class="hljs-number">-1</span>) : (prec+<span class="hljs-number">1</span>),
                                        crender)(<span class="hljs-keyword">this</span>.second);
            <span class="hljs-keyword">return</span> iw;
        });
    };
    <span class="hljs-keyword">var</span> binaryr = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">op, prec</span>) </span>{ binary(op, prec, <span class="hljs-literal">null</span>, <span class="hljs-number">1</span><span class="hljs-comment">/*is right*/</span>); };
    binaryr(<span class="hljs-string">'='</span>, <span class="hljs-number">10</span>);
    binaryr(<span class="hljs-string">'+='</span>, <span class="hljs-number">10</span>);
    binaryr(<span class="hljs-string">'-='</span>, <span class="hljs-number">10</span>);
    binaryr(<span class="hljs-string">'*='</span>, <span class="hljs-number">10</span>);
    binaryr(<span class="hljs-string">'/='</span>, <span class="hljs-number">10</span>);
    binaryr(<span class="hljs-string">'||'</span>, <span class="hljs-number">30</span>);
    binaryr(<span class="hljs-string">'&amp;&amp;'</span>, <span class="hljs-number">35</span>);
    binaryr(<span class="hljs-string">'==='</span>,<span class="hljs-number">40</span>);
    binaryr(<span class="hljs-string">'!=='</span>,<span class="hljs-number">40</span>);
    binaryr(<span class="hljs-string">'&lt;'</span>, <span class="hljs-number">45</span>);
    binaryr(<span class="hljs-string">'&lt;='</span>,<span class="hljs-number">45</span>);
    binaryr(<span class="hljs-string">'&gt;'</span>, <span class="hljs-number">45</span>);
    binaryr(<span class="hljs-string">'&gt;='</span>,<span class="hljs-number">45</span>);
    binary(<span class="hljs-string">'+'</span>, <span class="hljs-number">50</span>);
    binary(<span class="hljs-string">'-'</span>, <span class="hljs-number">50</span>);
    binary(<span class="hljs-string">'*'</span>, <span class="hljs-number">60</span>);
    binary(<span class="hljs-string">'/'</span>, <span class="hljs-number">60</span>);

    binary(<span class="hljs-string">"["</span>, <span class="hljs-number">80</span>, with_prec_paren(<span class="hljs-number">80</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> iw = <span class="hljs-built_in">Object</span>.create(WithSuffixWidget);
        iw.operator = <span class="hljs-string">'['</span>;
        iw.closeOperator = <span class="hljs-string">']'</span>;
        iw.leftOperand = crender(<span class="hljs-keyword">this</span>.first);
        iw.rightOperand = with_prec(<span class="hljs-number">0</span>, crender)(<span class="hljs-keyword">this</span>.second);
        <span class="hljs-keyword">return</span> iw;
    }));
    binary(<span class="hljs-string">"("</span>, <span class="hljs-number">75</span>, with_prec_paren(<span class="hljs-number">80</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-166">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-166">&#182;</a>
              </div>
              <p>simple method invocation (doesn&#39;t set &#39;this&#39;)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> iw = <span class="hljs-built_in">Object</span>.create(WithSuffixWidget);
        iw.operator = <span class="hljs-string">'('</span>;
        iw.closeOperator = <span class="hljs-string">')'</span>;
        iw.leftOperand = crender(<span class="hljs-keyword">this</span>.first);
        iw.rightOperand = <span class="hljs-built_in">Object</span>.create(CommaListWidget);
        <span class="hljs-keyword">this</span>.second.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>{
            iw.rightOperand.addChild(with_prec(<span class="hljs-number">0</span>, crender)(c));
        });
        <span class="hljs-keyword">return</span> iw;
    }));
    binary(<span class="hljs-string">"."</span>, <span class="hljs-number">80</span>, with_prec_paren(<span class="hljs-number">80</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        assert(<span class="hljs-keyword">this</span>.second.arity===<span class="hljs-string">'literal'</span>, <span class="hljs-keyword">this</span>.second);
        <span class="hljs-keyword">var</span> w = <span class="hljs-built_in">Object</span>.create(DotNameWidget);
        w.leftOperand = crender(<span class="hljs-keyword">this</span>.first);
        w.rightOperand = <span class="hljs-built_in">Object</span>.create(NameLiteralWidget);
        w.rightOperand.setName(<span class="hljs-keyword">this</span>.second.value);
        <span class="hljs-keyword">return</span> w;
    }));</pre></div></div>
            
        </li>
        
        
        <li id="section-167">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              <p>Ternary ASTs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch.ternary = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        assert(dispatch.ternary[<span class="hljs-keyword">this</span>.value], <span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> dispatch.ternary[<span class="hljs-keyword">this</span>.value].apply(<span class="hljs-keyword">this</span>);
    };
    <span class="hljs-keyword">var</span> ternary = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">op, prec, f</span>) </span>{
        dispatch.ternary[op] = with_prec_paren(prec, f);
    };
    ternary(<span class="hljs-string">"("</span>, <span class="hljs-number">80</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-168">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-168">&#182;</a>
              </div>
              <p>precedence is 80, same as . and &#39;(&#39;)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        assert(<span class="hljs-keyword">this</span>.second.arity===<span class="hljs-string">'literal'</span>, <span class="hljs-keyword">this</span>.second);
        <span class="hljs-keyword">var</span> w = <span class="hljs-built_in">Object</span>.create(DotNameInvokeWidget);
        w.leftOperand = crender(<span class="hljs-keyword">this</span>.first);
        w.rightOperand = <span class="hljs-built_in">Object</span>.create(NameLiteralWidget);
        w.rightOperand.setName(<span class="hljs-keyword">this</span>.second.value);
        w.args = <span class="hljs-built_in">Object</span>.create(CommaListWidget);
        <span class="hljs-keyword">this</span>.third.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>{
            w.args.addChild(with_prec(<span class="hljs-number">0</span>, crender)(c));
        });
        <span class="hljs-keyword">return</span> w;
    });
    ternary(<span class="hljs-string">"?"</span>, <span class="hljs-number">20</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> w = <span class="hljs-built_in">Object</span>.create(ConditionalWidget);
        w.testOperand = crender(<span class="hljs-keyword">this</span>.first);
        w.trueOperand = crender(<span class="hljs-keyword">this</span>.second);
        w.falseOperand = crender(<span class="hljs-keyword">this</span>.third);
        <span class="hljs-keyword">return</span> w;
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-169">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-169">&#182;</a>
              </div>
              <p>Statements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch.statement = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        assert(dispatch.statement[<span class="hljs-keyword">this</span>.value], <span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> dispatch.statement[<span class="hljs-keyword">this</span>.value].apply(<span class="hljs-keyword">this</span>);
    };
    <span class="hljs-keyword">var</span> stmt = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value, f</span>) </span>{
        dispatch.statement[value] = f;
    };
    stmt(<span class="hljs-string">"block"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> crender_stmts(<span class="hljs-keyword">this</span>.first);
    });
    stmt(<span class="hljs-string">"var"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        assert(<span class="hljs-literal">false</span>, <span class="hljs-string">"Should be handled by block context"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.create(YadaWidget);
    });
    stmt(<span class="hljs-string">"if"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> iw = <span class="hljs-built_in">Object</span>.create(IfWidget);
        iw.testExpr = crender(<span class="hljs-keyword">this</span>.first);
        iw.block = crender(<span class="hljs-keyword">this</span>.second);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.third) {
            iw.elseBlock = crender(<span class="hljs-keyword">this</span>.third);
        }
        <span class="hljs-keyword">return</span> iw;
    });
    stmt(<span class="hljs-string">"return"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> rw, w;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.first) {
            w = crender(<span class="hljs-keyword">this</span>.first);
        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-170">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-170">&#182;</a>
              </div>
              <p>XXX not quite right</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            w = <span class="hljs-built_in">Object</span>.create(UndefinedWidget);
        }
        rw = <span class="hljs-built_in">Object</span>.create(ReturnWidget);
        rw.expression = w;
        <span class="hljs-keyword">return</span> rw;
    });
    stmt(<span class="hljs-string">"break"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.create(BreakWidget); });
    stmt(<span class="hljs-string">"while"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> ww = <span class="hljs-built_in">Object</span>.create(WhileWidget);
        ww.testExpr = crender(<span class="hljs-keyword">this</span>.first);
        ww.block = crender(<span class="hljs-keyword">this</span>.second);
        <span class="hljs-keyword">return</span> ww;
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-171">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-171">&#182;</a>
              </div>
              <p>Odd cases</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch[<span class="hljs-string">'this'</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.create(ThisWidget); <span class="hljs-comment">// literal</span>
    };
    dispatch[<span class="hljs-string">'function'</span>] = with_prec(<span class="hljs-number">0</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> fw = <span class="hljs-built_in">Object</span>.create(FunctionWidget);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.name) {
            fw.name = <span class="hljs-built_in">Object</span>.create(NameWidget);
            fw.name.name = <span class="hljs-keyword">this</span>.name;
        }
        fw.args = <span class="hljs-built_in">Object</span>.create(CommaListWidget);
        fw.args.isName = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.first.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>{
            fw.args.addChild(crender(c));
        });
        fw.block = crender_stmts(<span class="hljs-keyword">this</span>.second);
        <span class="hljs-keyword">return</span> fw;
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-172">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-172">&#182;</a>
              </div>
              <p>Helpers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    crender = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tree</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-173">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-173">&#182;</a>
              </div>
              <p>make &#39;this&#39; the parse tree in the dispatched function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        assert(dispatch[tree.arity], tree);
        <span class="hljs-keyword">return</span> dispatch[tree.arity].apply(tree);
    };
    crender_stmt = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tree</span>) </span>{
        <span class="hljs-keyword">var</span> w = crender(tree);
        <span class="hljs-keyword">if</span> (tree.arity !== <span class="hljs-string">"statement"</span>) {
            <span class="hljs-keyword">var</span> esw = <span class="hljs-built_in">Object</span>.create(ExpStmtWidget);
            esw.expression = w;
            <span class="hljs-keyword">return</span> esw;
        }
        <span class="hljs-keyword">return</span> w;
    };
    crender_stmts = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tree_list</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-174">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-174">&#182;</a>
              </div>
              <p>collect leading &#39;var&#39; statements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> bw = <span class="hljs-built_in">Object</span>.create(BlockWidget);
        <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-175">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-175">&#182;</a>
              </div>
              <p>collect variables (if any)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">while</span> (i &lt; tree_list.length) {
            <span class="hljs-keyword">if</span> (!(tree_list[i].arity === <span class="hljs-string">'statement'</span> &amp;&amp;
                  tree_list[i].value === <span class="hljs-string">'var'</span>)) {
                <span class="hljs-keyword">break</span>;
            }
            bw.addVar(crender(tree_list[i].first));
            i += <span class="hljs-number">1</span>;
        }
        <span class="hljs-keyword">while</span> (i &lt; tree_list.length) {
            bw.addChild(crender_stmt(tree_list[i]));
            i += <span class="hljs-number">1</span>;
        }
        <span class="hljs-keyword">return</span> bw;
    };

    <span class="hljs-keyword">var</span> c = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">parse_tree</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-176">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-176">&#182;</a>
              </div>
              <p>parse_tree should be an array of statements.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        indentation = <span class="hljs-number">0</span>;
        prec_stack = [ <span class="hljs-number">0</span> ];
        <span class="hljs-keyword">return</span> crender_stmts(parse_tree);
    };
    c.__module_name__ = <span class="hljs-string">"crender"</span>;
    c.__module_init__ = make_crender;
    c.__module_deps__ = [<span class="hljs-string">'str-escape'</span>];
    c.__module_source__ = crender_source;
    <span class="hljs-keyword">return</span> c;
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
