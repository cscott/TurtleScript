<!DOCTYPE html>

<html>
<head>
  <title>ts.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="asm-llvm.html">
                asm-llvm.js
              </a>
            
              
              <a class="source" href="bcompile.html">
                bcompile.js
              </a>
            
              
              <a class="source" href="binterp.html">
                binterp.js
              </a>
            
              
              <a class="source" href="browsercanvas.html">
                browsercanvas.js
              </a>
            
              
              <a class="source" href="bytecode-table.html">
                bytecode-table.js
              </a>
            
              
              <a class="source" href="canvastest.html">
                canvastest.js
              </a>
            
              
              <a class="source" href="ccanvas.html">
                ccanvas.js
              </a>
            
              
              <a class="source" href="crender-styles.html">
                crender-styles.js
              </a>
            
              
              <a class="source" href="crender.html">
                crender.js
              </a>
            
              
              <a class="source" href="ctiles.html">
                ctiles.js
              </a>
            
              
              <a class="source" href="events.html">
                events.js
              </a>
            
              
              <a class="source" href="eventtests.html">
                eventtests.js
              </a>
            
              
              <a class="source" href="extensions.html">
                extensions.js
              </a>
            
              
              <a class="source" href="global-es5.html">
                global-es5.js
              </a>
            
              
              <a class="source" href="global.html">
                global.js
              </a>
            
              
              <a class="source" href="html-escape.html">
                html-escape.js
              </a>
            
              
              <a class="source" href="jcompile.html">
                jcompile.js
              </a>
            
              
              <a class="source" href="json2.html">
                json2.js
              </a>
            
              
              <a class="source" href="nodemain.html">
                nodemain.js
              </a>
            
              
              <a class="source" href="parse.html">
                parse.js
              </a>
            
              
              <a class="source" href="render.html">
                render.js
              </a>
            
              
              <a class="source" href="render2.html">
                render2.js
              </a>
            
              
              <a class="source" href="require.html">
                require.js
              </a>
            
              
              <a class="source" href="stdlib.html">
                stdlib.js
              </a>
            
              
              <a class="source" href="str-escape.html">
                str-escape.js
              </a>
            
              
              <a class="source" href="tdop.html">
                tdop.js
              </a>
            
              
              <a class="source" href="tests.html">
                tests.js
              </a>
            
              
              <a class="source" href="text.html">
                text.js
              </a>
            
              
              <a class="source" href="tiles.html">
                tiles.js
              </a>
            
              
              <a class="source" href="tokenize.html">
                tokenize.js
              </a>
            
              
              <a class="source" href="top-level.html">
                top-level.js
              </a>
            
              
              <a class="source" href="ts.html">
                ts.js
              </a>
            
              
              <a class="source" href="write-lua-bytecode.html">
                write-lua-bytecode.js
              </a>
            
              
              <a class="source" href="write-lua-ops.html">
                write-lua-ops.js
              </a>
            
              
              <a class="source" href="write-php-bytecode.html">
                write-php-bytecode.js
              </a>
            
              
              <a class="source" href="write-php-ops.html">
                write-php-ops.js
              </a>
            
              
              <a class="source" href="write-rust-bytecode.html">
                write-rust-bytecode.js
              </a>
            
              
              <a class="source" href="write-rust-ops.html">
                write-rust-ops.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="tsjs">ts.js</h1>
<p><a href="http://requirejs.org/">requirejs</a>
<a href="http://requirejs.org/docs/plugins.html">plugin</a>
for loading TurtleScript code which has been run through
<code>parse</code> and <code>jcompile</code>.</p>
<p>This is mostly to keep us honest, by ensuring that our source code
really is valid TurtleScript.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/**
 * <span class="hljs-doctag">@license </span>ts 0.0.0 Copyright (c) 2011 C. Scott Ananian, portions Copyright (c) 2010-2011, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 */</span>

<span class="hljs-comment">/* Yes, deliciously evil. */</span>
<span class="hljs-comment">/*jslint evil: true, strict: false, plusplus: false, regexp: false */</span>
<span class="hljs-comment">/*global require: false, XMLHttpRequest: false, ActiveXObject: false,
  define: false, process: false, window: false */</span>

(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">var</span> fs, getXhr,
        progIds = [<span class="hljs-string">'Msxml2.XMLHTTP'</span>, <span class="hljs-string">'Microsoft.XMLHTTP'</span>, <span class="hljs-string">'Msxml2.XMLHTTP.4.0'</span>],
        fetchText = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Environment unsupported.'</span>);
        },
        buildMap = [];



    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span> !== <span class="hljs-string">"undefined"</span> &amp;&amp; <span class="hljs-built_in">window</span>.navigator &amp;&amp; <span class="hljs-built_in">window</span>.document) {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Browser action</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        getXhr = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Would love to dump the ActiveX crap in here. Need IE 6 to die first.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> xhr, i, progId;
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> XMLHttpRequest !== <span class="hljs-string">"undefined"</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> XMLHttpRequest();
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
                    progId = progIds[i];
                    <span class="hljs-keyword">try</span> {
                        xhr = <span class="hljs-keyword">new</span> ActiveXObject(progId);
                    } <span class="hljs-keyword">catch</span> (e) {}

                    <span class="hljs-keyword">if</span> (xhr) {
                        progIds = [progId];  <span class="hljs-comment">// so faster next time</span>
                        <span class="hljs-keyword">break</span>;
                    }
                }
            }

            <span class="hljs-keyword">if</span> (!xhr) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"getXhr(): XMLHttpRequest not available"</span>);
            }

            <span class="hljs-keyword">return</span> xhr;
        };

        fetchText = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">url, callback</span>) </span>{
            <span class="hljs-keyword">var</span> xhr = getXhr();
            xhr.open(<span class="hljs-string">'GET'</span>, url, <span class="hljs-literal">true</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>XXX FOR DEVELOPMENT</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            xhr.setRequestHeader(<span class="hljs-string">'Cache-Control'</span>, <span class="hljs-string">'no-cache'</span>);
            xhr.setRequestHeader(<span class="hljs-string">'Pragma'</span>, <span class="hljs-string">'no-cache'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>XXX END DEVELOPMENT</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Do not explicitly handle errors, those should be
visible via console output in the browser.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (xhr.readyState === <span class="hljs-number">4</span>) {
                    callback(xhr.responseText);
                }
            };
            xhr.send(<span class="hljs-literal">null</span>);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>end browser.js adapters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> process !== <span class="hljs-string">"undefined"</span> &amp;&amp;
               process.versions &amp;&amp;
               !!process.versions.node) {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Using special require.nodeRequire, something added by r.js.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        fs = <span class="hljs-built_in">require</span>.nodeRequire(<span class="hljs-string">'fs'</span>);
        fetchText = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">path, callback</span>) </span>{
            callback(fs.readFileSync(path, <span class="hljs-string">'utf8'</span>));
        };
    }

    define([<span class="hljs-string">'parse'</span>,<span class="hljs-string">'jcompile'</span>,<span class="hljs-string">'top-level'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">parse, jcompile, top_level</span>) </span>{
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Object</span>.Throw) {
            <span class="hljs-built_in">Object</span>.Throw = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">obj</span>) </span>{ <span class="hljs-keyword">throw</span> obj; };
        }
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TurtleScript</span>(<span class="hljs-params">text, config</span>) </span>{
            tree = parse(text, top_level);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>find top-level call(s) to &#39;define()&#39; and hack the dependencies
to also use the ts! loader.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            tree.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">stmt</span>) </span>{
                <span class="hljs-keyword">if</span> (stmt.arity===<span class="hljs-string">"binary"</span> &amp;&amp; stmt.value === <span class="hljs-string">'('</span> &amp;&amp;
                    stmt.first.arity===<span class="hljs-string">"name"</span> &amp;&amp; stmt.first.value===<span class="hljs-string">"define"</span>) {
                    <span class="hljs-keyword">var</span> i, deps;
                    <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i&lt;stmt.second.length; i++) {
                        <span class="hljs-keyword">if</span> (stmt.second[i].arity===<span class="hljs-string">"unary"</span> &amp;&amp;
                            stmt.second[i].value===<span class="hljs-string">"["</span>) {
                            deps = stmt.second[i];
                            <span class="hljs-keyword">break</span>;
                        }
                    }
                    <span class="hljs-keyword">if</span> (!deps) { <span class="hljs-keyword">return</span>; }
                    deps.first.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">dname</span>) </span>{
                        <span class="hljs-keyword">if</span> (dname.arity !== <span class="hljs-string">'literal'</span>) { <span class="hljs-keyword">return</span>; }
                        <span class="hljs-keyword">if</span> (dname.value.indexOf(<span class="hljs-string">'!'</span>) !== <span class="hljs-number">-1</span>) { <span class="hljs-keyword">return</span>; }
                        dname.value = <span class="hljs-string">"ts!"</span> + dname.value;
                    });
                }
            });
            <span class="hljs-keyword">return</span> jcompile(tree);
        };
        <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">version</span>: <span class="hljs-string">'0.1.0'</span>,

        <span class="hljs-attr">load</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">name, parentRequire, load, config</span>) </span>{
            <span class="hljs-keyword">var</span> path = parentRequire.toUrl(name + <span class="hljs-string">'.js'</span>);<span class="hljs-comment">// XXX could be .ts?</span>
            fetchText(path, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">text</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Do TurtleScript transform.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> origText = text;
                <span class="hljs-keyword">try</span> {
                  text = TurtleScript(origText, config.TurtleScript);
                } <span class="hljs-keyword">catch</span> (e) {
                    <span class="hljs-keyword">if</span> (e.from &amp;&amp; e.to) {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>find newline before &#39;from&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">var</span> fromNL = origText.lastIndexOf(<span class="hljs-string">'\n'</span>, e.from);
                        <span class="hljs-keyword">var</span> toNL = origText.indexOf(<span class="hljs-string">'\n'</span>, e.to);
                        <span class="hljs-keyword">if</span> (fromNL === <span class="hljs-number">-1</span>) fromNL = <span class="hljs-number">0</span>; <span class="hljs-keyword">else</span> fromNL++;
                        <span class="hljs-keyword">if</span> (toNL === <span class="hljs-number">-1</span>) toNL = e.to;
                        <span class="hljs-keyword">var</span> line = origText.substring(fromNL, toNL);
                        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Syntax Error: "</span>+<span class="hljs-built_in">JSON</span>.stringify(e));
                        <span class="hljs-built_in">console</span>.log(line);
                    }
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Could not compile: "</span>+path);
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Hold on to the transformed text if a build.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (config.isBuild) {
                    buildMap[name] = text;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>IE with conditional comments on cannot handle the
sourceURL trick, so skip it if enabled.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-comment">/*@if (@_jscript) @else @*/</span>
                <span class="hljs-keyword">if</span> (!config.isBuild) {
                    text += <span class="hljs-string">"\r\n//@ sourceURL="</span> + path;
                }
                <span class="hljs-comment">/*@end@*/</span>

                load.fromText(name, text);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Give result to load. Need to wait until the module
is fully parse, which will happen after this
execution.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                parentRequire([name], <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) </span>{
                    load(value);
                });
            });

        },

        <span class="hljs-attr">write</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">pluginName, name, write</span>) </span>{
            <span class="hljs-keyword">if</span> (name <span class="hljs-keyword">in</span> buildMap) {
                <span class="hljs-keyword">var</span> text = buildMap[name];
                write.asModule(pluginName + <span class="hljs-string">"!"</span> + name, text);
            }
        }
        };
    });

}());</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
