<!DOCTYPE html>

<html>
<head>
  <title>tdop.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="asm-llvm.html">
                asm-llvm.js
              </a>
            
              
              <a class="source" href="bcompile.html">
                bcompile.js
              </a>
            
              
              <a class="source" href="binterp.html">
                binterp.js
              </a>
            
              
              <a class="source" href="browsercanvas.html">
                browsercanvas.js
              </a>
            
              
              <a class="source" href="bytecode-table.html">
                bytecode-table.js
              </a>
            
              
              <a class="source" href="canvastest.html">
                canvastest.js
              </a>
            
              
              <a class="source" href="ccanvas.html">
                ccanvas.js
              </a>
            
              
              <a class="source" href="crender-styles.html">
                crender-styles.js
              </a>
            
              
              <a class="source" href="crender.html">
                crender.js
              </a>
            
              
              <a class="source" href="ctiles.html">
                ctiles.js
              </a>
            
              
              <a class="source" href="events.html">
                events.js
              </a>
            
              
              <a class="source" href="eventtests.html">
                eventtests.js
              </a>
            
              
              <a class="source" href="extensions.html">
                extensions.js
              </a>
            
              
              <a class="source" href="global-es5.html">
                global-es5.js
              </a>
            
              
              <a class="source" href="global.html">
                global.js
              </a>
            
              
              <a class="source" href="html-escape.html">
                html-escape.js
              </a>
            
              
              <a class="source" href="jcompile.html">
                jcompile.js
              </a>
            
              
              <a class="source" href="json2.html">
                json2.js
              </a>
            
              
              <a class="source" href="nodemain.html">
                nodemain.js
              </a>
            
              
              <a class="source" href="parse.html">
                parse.js
              </a>
            
              
              <a class="source" href="render.html">
                render.js
              </a>
            
              
              <a class="source" href="render2.html">
                render2.js
              </a>
            
              
              <a class="source" href="require.html">
                require.js
              </a>
            
              
              <a class="source" href="stdlib.html">
                stdlib.js
              </a>
            
              
              <a class="source" href="str-escape.html">
                str-escape.js
              </a>
            
              
              <a class="source" href="tdop.html">
                tdop.js
              </a>
            
              
              <a class="source" href="tests.html">
                tests.js
              </a>
            
              
              <a class="source" href="text.html">
                text.js
              </a>
            
              
              <a class="source" href="tiles.html">
                tiles.js
              </a>
            
              
              <a class="source" href="tokenize.html">
                tokenize.js
              </a>
            
              
              <a class="source" href="top-level.html">
                top-level.js
              </a>
            
              
              <a class="source" href="ts.html">
                ts.js
              </a>
            
              
              <a class="source" href="write-lua-bytecode.html">
                write-lua-bytecode.js
              </a>
            
              
              <a class="source" href="write-lua-ops.html">
                write-lua-ops.js
              </a>
            
              
              <a class="source" href="write-php-bytecode.html">
                write-php-bytecode.js
              </a>
            
              
              <a class="source" href="write-php-ops.html">
                write-php-ops.js
              </a>
            
              
              <a class="source" href="write-rust-bytecode.html">
                write-rust-bytecode.js
              </a>
            
              
              <a class="source" href="write-rust-ops.html">
                write-rust-ops.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>tdop.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Source for the <code>tdop.html</code> demonstration page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>define([<span class="hljs-string">"html-escape"</span>, <span class="hljs-string">"json2"</span>, <span class="hljs-string">"ts!parse"</span>, <span class="hljs-string">"ts!bcompile"</span>, <span class="hljs-string">"ts!binterp"</span>, <span class="hljs-string">"ts!stdlib"</span>, <span class="hljs-string">"ts!top-level"</span>, <span class="hljs-string">"ts!tests"</span>], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">html_escape, JSON, parse, bcompile, binterp, stdlib, top_level, tests</span>) </span>{

<span class="hljs-comment">/*jslint evil: true */</span>

<span class="hljs-comment">/*members create, error, message, name, prototype, stringify, toSource,
    toString, write
*/</span>

<span class="hljs-comment">/*global JSON, make_parse, parse, source, tree */</span>

<span class="hljs-keyword">var</span> CATCH_ERRORS = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">var</span> SHOW_SOURCE = <span class="hljs-literal">true</span>;
<span class="hljs-keyword">var</span> PRINT_TREE = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">var</span> PRINT_JCOMPILE = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">var</span> PRINT_RAW_BYTECODE = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">var</span> PRINT_ENCODED_BYTECODE = <span class="hljs-literal">true</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fill</span>(<span class="hljs-params">elem_id, h1, contents, no_escape</span>) </span>{
  <span class="hljs-keyword">if</span> (!no_escape) contents = html_escape(contents);
  elem = <span class="hljs-built_in">document</span>.getElementById(elem_id);
  elem.innerHTML = <span class="hljs-string">"&lt;h1&gt;"</span> + h1 + <span class="hljs-string">"&lt;/h1&gt;\n"</span> + contents;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">do_it</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>We are going to make the compiler/interpreter compile itself.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> make_self_test = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">parse, bcompile, top_level</span>) </span>{
       <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">source</span>) </span>{
           <span class="hljs-keyword">var</span> result;
           source = source || <span class="hljs-string">'{ return 1+2; }'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>result = tokenize(source, &#39;=&lt;&gt;!+-*&amp;|/%^&#39;, &#39;=&lt;&gt;&amp;|&#39;);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>           <span class="hljs-keyword">var</span> tree = parse(source, top_level);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>result = tree;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>           <span class="hljs-keyword">var</span> bc = bcompile(tree);
           result = bc.decompile(<span class="hljs-number">0</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>result = bc.encode().join();
console.log(result);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>           <span class="hljs-keyword">return</span> result;
       };
    };
    define(<span class="hljs-string">"self_test"</span>, [<span class="hljs-string">"parse"</span>, <span class="hljs-string">"bcompile"</span>, <span class="hljs-string">"top-level"</span>], make_self_test);
    <span class="hljs-keyword">var</span> self_test_source = make_self_test.toSource ?
        make_self_test.toSource() : make_self_test.toString();
    self_test_source = <span class="hljs-string">'define("self_test", ["parse","bcompile","top-level"], '</span>+
        self_test_source + <span class="hljs-string">');\n'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>combine sources</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> isource = <span class="hljs-string">'{ return 2+3; }'</span>; <span class="hljs-comment">// input to interpreted version of compiler</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>isource = &#39;var f = function() { };&#39;;
isource = sources[7].replace(/module/, &#39;library_init&#39;);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> fake_require =
        <span class="hljs-string">"var __modules__ = {};\n"</span>+
        <span class="hljs-string">"define = function(name, deps, init_func) {\n"</span>+
        <span class="hljs-string">"  var d = deps.map(function(m) { return __modules__[m]; });\n"</span>+
        <span class="hljs-string">"  __modules__[name] = init_func.apply(this, d);\n"</span>+
        <span class="hljs-string">"};"</span>;
    <span class="hljs-keyword">var</span> top_level_source = <span class="hljs-string">'define("top-level", [], '</span>+
        <span class="hljs-string">'function() { return '</span>+<span class="hljs-built_in">JSON</span>.stringify(top_level)+<span class="hljs-string">'; });'</span>;
    <span class="hljs-keyword">var</span> source = <span class="hljs-string">'{\n'</span>+
        stdlib.source()+<span class="hljs-string">'\n'</span>+
        fake_require+<span class="hljs-string">'\n'</span>+
        tests.lookup(<span class="hljs-string">"tokenize"</span>)+<span class="hljs-string">"\n"</span>+
        tests.lookup(<span class="hljs-string">"parse"</span>)+<span class="hljs-string">"\n"</span>+
        tests.lookup(<span class="hljs-string">"bytecode-table"</span>)+<span class="hljs-string">"\n"</span>+
        tests.lookup(<span class="hljs-string">"bcompile"</span>)+<span class="hljs-string">"\n"</span>+
        tests.lookup(<span class="hljs-string">"binterp"</span>)+<span class="hljs-string">"\n"</span>+
        top_level_source+<span class="hljs-string">"\n"</span>+
        self_test_source+<span class="hljs-string">"\n"</span>+
        <span class="hljs-string">"return __modules__['self_test'](arguments[0]); }\n"</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>HACK to run specific test cases</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    test_case = tests[<span class="hljs-number">29</span>].replace(<span class="hljs-regexp">/^define\([^,]+,/</span>, <span class="hljs-string">"define('self_test',"</span>);
    source = <span class="hljs-string">'{\n'</span> + stdlib.source() + <span class="hljs-string">'\n'</span> + fake_require + <span class="hljs-string">'\n'</span> +
            test_case + <span class="hljs-string">"\n"</span>+
            <span class="hljs-string">"return __modules__['self_test'](arguments[0]); }\n"</span>;
        <span class="hljs-built_in">console</span>.log(source);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>END HACK</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    }

    <span class="hljs-keyword">if</span> (<span class="hljs-number">1</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>for use comparing the output of the interpreter with the
output of the javascript code run directly.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>       <span class="hljs-built_in">eval</span>(<span class="hljs-string">"function self_test() {"</span>+source+<span class="hljs-string">"}"</span>);
       eresult = self_test(isource);
       <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(eresult) != <span class="hljs-string">"string"</span>) eresult = <span class="hljs-string">""</span>+<span class="hljs-built_in">JSON</span>.stringify(eresult);
       fill(<span class="hljs-string">'expected-result'</span>, <span class="hljs-string">'Expected result'</span>, eresult);
    }

    <span class="hljs-keyword">if</span> (SHOW_SOURCE) {
       sl = source.split(<span class="hljs-regexp">/\n/</span>);
       ci = <span class="hljs-number">0</span>;
       o = <span class="hljs-string">"&lt;pre&gt;"</span>;
       <span class="hljs-keyword">for</span> (j=<span class="hljs-number">0</span>; j &lt; sl.length; j++) {
          o += ci+<span class="hljs-string">": "</span>+html_escape(sl[j])+<span class="hljs-string">"\n"</span>;
          ci += sl[j].length + <span class="hljs-number">1</span>;
       }
       o += <span class="hljs-string">"&lt;/pre&gt;"</span>;
       fill(<span class="hljs-string">'source'</span>, <span class="hljs-string">'Interpreted source'</span>, o, <span class="hljs-number">1</span><span class="hljs-comment">/*no escape*/</span>);
   }

    tree = parse(source, top_level);
    <span class="hljs-keyword">if</span> (tree) {
        <span class="hljs-comment">/* Raw compiled tree */</span>
        <span class="hljs-keyword">if</span> (PRINT_TREE) {
           fill(<span class="hljs-string">'parse-tree'</span>, <span class="hljs-string">'Parse tree'</span>,
            <span class="hljs-built_in">JSON</span>.stringify(tree, [<span class="hljs-string">'key'</span>, <span class="hljs-string">'name'</span>, <span class="hljs-string">'message'</span>,
            <span class="hljs-string">'value'</span>, <span class="hljs-string">'arity'</span>, <span class="hljs-string">'first'</span>, <span class="hljs-string">'second'</span>, <span class="hljs-string">'third'</span>, <span class="hljs-string">'fourth'</span>], <span class="hljs-number">4</span>));
        }

        <span class="hljs-comment">/* Pretty-printed to eval'able javascript */</span>
        <span class="hljs-keyword">if</span> (PRINT_JCOMPILE) {
           fill(<span class="hljs-string">'jcompile'</span>, <span class="hljs-string">'Recompiled to JavaScript'</span>, jcompile(tree));
        }

        <span class="hljs-comment">/* Bytecode compiled (raw) */</span>
        bc = bcompile(tree);
        <span class="hljs-keyword">if</span> (PRINT_RAW_BYTECODE) {
            fill(<span class="hljs-string">'raw-bytecode'</span>, <span class="hljs-string">'Raw Bytecode File Contents'</span>,
                 <span class="hljs-built_in">JSON</span>.stringify(bc, [<span class="hljs-string">'functions'</span>, <span class="hljs-string">'literals'</span>, <span class="hljs-string">'id'</span>, <span class="hljs-string">'nargs'</span>,
                                     <span class="hljs-string">'bytecode'</span>, <span class="hljs-string">'label'</span>], <span class="hljs-number">4</span>));
        }
        <span class="hljs-keyword">if</span> (PRINT_ENCODED_BYTECODE) {
            <span class="hljs-keyword">var</span> out_file = bc.encode();
            fill(<span class="hljs-string">'encoded-bytecode'</span>, <span class="hljs-string">'Encoded Bytecode'</span>, out_file.length+<span class="hljs-string">" "</span>+
             <span class="hljs-built_in">JSON</span>.stringify(out_file));
        }

        <span class="hljs-comment">/* Pretty-printed bytecode */</span>
        b = <span class="hljs-string">"&lt;p&gt;Index: "</span>;
        <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i&lt;bc.functions.length; i++) {
          <span class="hljs-keyword">var</span> f = bc.functions[i];
          b+= <span class="hljs-string">"&lt;a href='#bc-"</span>+i+<span class="hljs-string">"'&gt;"</span>;
          b+= html_escape((f.name) ? f.name : (<span class="hljs-string">"&lt;#"</span>+i+<span class="hljs-string">"&gt;"</span>));
          b+= <span class="hljs-string">"&lt;/a&gt; "</span>;
        }
        b += <span class="hljs-string">"&lt;/p&gt;"</span>;
        <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i&lt;bc.functions.length; i++) {
          <span class="hljs-keyword">var</span> f = bc.functions[i];
          b += <span class="hljs-string">"&lt;h2&gt;&lt;a id='bc-"</span>+i+<span class="hljs-string">"'&gt;Function #"</span>+f.id;
          <span class="hljs-keyword">if</span> (f.name) b += <span class="hljs-string">" "</span>+html_escape(f.name);
          b += <span class="hljs-string">"&lt;/a&gt;"</span>;
          b += <span class="hljs-string">" ("</span>+f.nargs+<span class="hljs-string">" args; max stack depth="</span>+f.max_stack+<span class="hljs-string">")&lt;/h2&gt;\n"</span>;
          b += <span class="hljs-string">"&lt;pre&gt;"</span>+html_escape(bc.decompile(f.id))+<span class="hljs-string">"&lt;/pre&gt;"</span>;
        }
        fill(<span class="hljs-string">'bytecode'</span>, <span class="hljs-string">'Compiled Bytecode'</span>, b, <span class="hljs-number">1</span><span class="hljs-comment">/*no escape*/</span>);

        <span class="hljs-comment">/* Interpreter test! */</span>
        frame = binterp.make_top_level_frame.call(<span class="hljs-comment">/*this: */</span>{<span class="hljs-comment">/*this*/</span>} ,
                                                  <span class="hljs-comment">/* args:*/</span> isource);
        result = binterp.binterp(bc, <span class="hljs-number">0</span>, frame);
        fill(<span class="hljs-string">'isource'</span>, <span class="hljs-string">'Input to interpreted compiler'</span>, isource);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(result) != <span class="hljs-string">"string"</span>) result = <span class="hljs-string">""</span>+<span class="hljs-built_in">JSON</span>.stringify(result);
        fill(<span class="hljs-string">'result'</span>, <span class="hljs-string">'Result from interpreter'</span>, result);
   }
}

<span class="hljs-keyword">if</span> (!CATCH_ERRORS) {
    do_it();
} <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">try</span> {
        do_it();
    } <span class="hljs-keyword">catch</span> (e) {
        fill(<span class="hljs-string">'errors'</span>, <span class="hljs-string">'Error!'</span>,
             <span class="hljs-built_in">JSON</span>.stringify(e, [<span class="hljs-string">'name'</span>, <span class="hljs-string">'message'</span>, <span class="hljs-string">'from'</span>, <span class="hljs-string">'to'</span>,
                                          <span class="hljs-string">'key'</span>, <span class="hljs-string">'value'</span>, <span class="hljs-string">'arity'</span>, <span class="hljs-string">'first'</span>,
                                          <span class="hljs-string">'second'</span>, <span class="hljs-string">'third'</span>, <span class="hljs-string">'fourth'</span>], <span class="hljs-number">4</span>));
    }
}


});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
