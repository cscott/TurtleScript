<!DOCTYPE html>

<html>
<head>
  <title>binterp.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="asm-llvm.html">
                asm-llvm.js
              </a>
            
              
              <a class="source" href="bcompile.html">
                bcompile.js
              </a>
            
              
              <a class="source" href="binterp.html">
                binterp.js
              </a>
            
              
              <a class="source" href="browsercanvas.html">
                browsercanvas.js
              </a>
            
              
              <a class="source" href="bytecode-table.html">
                bytecode-table.js
              </a>
            
              
              <a class="source" href="canvastest.html">
                canvastest.js
              </a>
            
              
              <a class="source" href="ccanvas.html">
                ccanvas.js
              </a>
            
              
              <a class="source" href="crender-styles.html">
                crender-styles.js
              </a>
            
              
              <a class="source" href="crender.html">
                crender.js
              </a>
            
              
              <a class="source" href="ctiles.html">
                ctiles.js
              </a>
            
              
              <a class="source" href="events.html">
                events.js
              </a>
            
              
              <a class="source" href="eventtests.html">
                eventtests.js
              </a>
            
              
              <a class="source" href="extensions.html">
                extensions.js
              </a>
            
              
              <a class="source" href="global-es5.html">
                global-es5.js
              </a>
            
              
              <a class="source" href="global.html">
                global.js
              </a>
            
              
              <a class="source" href="html-escape.html">
                html-escape.js
              </a>
            
              
              <a class="source" href="jcompile.html">
                jcompile.js
              </a>
            
              
              <a class="source" href="json2.html">
                json2.js
              </a>
            
              
              <a class="source" href="nodemain.html">
                nodemain.js
              </a>
            
              
              <a class="source" href="parse.html">
                parse.js
              </a>
            
              
              <a class="source" href="render.html">
                render.js
              </a>
            
              
              <a class="source" href="render2.html">
                render2.js
              </a>
            
              
              <a class="source" href="require.html">
                require.js
              </a>
            
              
              <a class="source" href="stdlib.html">
                stdlib.js
              </a>
            
              
              <a class="source" href="str-escape.html">
                str-escape.js
              </a>
            
              
              <a class="source" href="tdop.html">
                tdop.js
              </a>
            
              
              <a class="source" href="tests.html">
                tests.js
              </a>
            
              
              <a class="source" href="tiles.html">
                tiles.js
              </a>
            
              
              <a class="source" href="tokenize.html">
                tokenize.js
              </a>
            
              
              <a class="source" href="top-level.html">
                top-level.js
              </a>
            
              
              <a class="source" href="ts.html">
                ts.js
              </a>
            
              
              <a class="source" href="write-rust-bytecode.html">
                write-rust-bytecode.js
              </a>
            
              
              <a class="source" href="write-rust-ops.html">
                write-rust-ops.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1>binterp.js</h1>
<p>Bytecode interpreter, written in Simplified JavaScript.</p>
<p>TODO: string coercions aren&#39;t quite right yet, we don&#39;t call the
      proper toString() method, etc.</p>
<p>C. Scott Ananian
2011-05-11</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>define([<span class="string">"bytecode-table"</span><span class="comment">/*, "!html-escape"*/</span>], <span class="function"><span class="keyword">function</span> <span class="title">make_binterp</span><span class="params">(bytecode_table, html_escape)</span> {</span>
    <span class="keyword">var</span> mkstate = <span class="keyword">function</span>(parent, frame, module, func_id) {
        <span class="keyword">return</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Main interpreter state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            parent: parent, <span class="comment">// calling context (another state)</span>
            frame: frame,
            stack: [],
            pc: <span class="number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>from bytecode file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            module: module,
            func_id: func_id,</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>cached</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            bytecode: module.functions[func_id].bytecode,
            literals: module.literals
        };
    };

    <span class="keyword">var</span> dispatch = {};
    <span class="keyword">var</span> SLOT_PREFIX = <span class="string">"!bi!"</span>; <span class="comment">// prevent leaking slots from metacontext</span>

    <span class="keyword">var</span> MyObject = {};
    MyObject.type = <span class="string">"object"</span>;
    <span class="keyword">var</span> MyArray = Object.create(MyObject);
    MyArray.type = <span class="string">"array"</span>;
    MyArray[SLOT_PREFIX+<span class="string">"length"</span>] = <span class="number">0</span>;
    <span class="keyword">var</span> MyFunction = Object.create(MyObject);
    MyFunction.type = <span class="string">"function"</span>;
    <span class="keyword">var</span> MyString = Object.create(MyObject);
    MyString.type = <span class="string">"string"</span>;
    <span class="keyword">var</span> MyNumber = Object.create(MyObject);
    MyNumber.type = <span class="string">"number"</span>;
    <span class="keyword">var</span> MyBoolean = Object.create(MyObject);
    MyBoolean.type = <span class="string">"boolean"</span>;
    <span class="keyword">var</span> MyTrue = Object.create(MyBoolean);
    MyTrue.value = <span class="literal">true</span>;
    <span class="keyword">var</span> MyFalse = Object.create(MyBoolean);
    MyFalse.value = <span class="literal">false</span>;

    <span class="keyword">var</span> MyMath = Object.create(MyObject);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Basic TypedArray support</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> MyUint8Array = Object.create(MyObject);

    <span class="keyword">var</span> interpret = <span class="keyword">function</span>(state) {
        <span class="keyword">var</span> op = bytecode_table.for_num(state.bytecode[state.pc]);
        <span class="comment">/*
        document.write("Executing: " +
                       state.pc + ": " +
                       op.name +
                       op.printargs(state.module, state.bytecode, state.pc)+
                       "  \n");
        */</span>
        <span class="keyword">var</span> args = [];
        <span class="keyword">var</span> i = <span class="number">0</span>;
        <span class="keyword">while</span> (i &lt; op.args) {
            args.push(state.bytecode[state.pc + i + <span class="number">1</span>]);
            i += <span class="number">1</span>;
        }
        state.pc += <span class="number">1</span> + op.args;
        <span class="keyword">var</span> ns = dispatch[op.name].apply(state, args);
        <span class="comment">/*
        document.write(JSON.stringify(state.stack,
                                      ['type', SLOT_PREFIX+"length"])+"\n");
        */</span>
        <span class="keyword">return</span> ns ? ns : state;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>helpers for debugging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> fname = <span class="keyword">function</span>(state) {
        <span class="keyword">var</span> result, name;
        <span class="keyword">var</span> func_id = state.func_id;
        result = <span class="string">"#"</span>+func_id;
        name = state.module ? state.module.functions[func_id].name : <span class="literal">null</span>;
        <span class="keyword">if</span> (name) {
            result += <span class="string">" ("</span>+name+<span class="string">")"</span>;
        }
        <span class="keyword">return</span> result;
    };
    <span class="keyword">var</span> stack_trace = <span class="keyword">function</span>(state) {
        <span class="keyword">if</span> (!state.parent) { <span class="keyword">return</span> <span class="string">""</span>; }
        <span class="keyword">return</span> stack_trace(state.parent) + <span class="string">"-&gt;"</span> + fname(state);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Implementations of bytecode instructions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch.push_frame = <span class="keyword">function</span>() {
        <span class="keyword">this</span>.stack.push(<span class="keyword">this</span>.frame);
    };
    dispatch.push_literal = <span class="keyword">function</span>(idx) {
        <span class="keyword">this</span>.stack.push(<span class="keyword">this</span>.literals[idx]);
    };
    dispatch.new_object = <span class="keyword">function</span>() {
        <span class="keyword">this</span>.stack.push(Object.create(MyObject));
    };
    dispatch.new_array = <span class="keyword">function</span>() {
        <span class="keyword">var</span> na = Object.create(MyArray);
        na[SLOT_PREFIX+<span class="string">"length"</span>] = <span class="number">0</span>;
        <span class="keyword">this</span>.stack.push(na);
    };
    dispatch.new_function = <span class="keyword">function</span>(idx) {
        <span class="keyword">var</span> f = Object.create(MyFunction);</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>hidden fields of function object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        f.parent_frame = <span class="keyword">this</span>.frame;
        f.module = <span class="keyword">this</span>.module;
        f.func_id = idx;
        f[SLOT_PREFIX+<span class="string">"name"</span>] = <span class="keyword">this</span>.module.functions[idx].name;
        f[SLOT_PREFIX+<span class="string">"length"</span>] = <span class="keyword">this</span>.module.functions[idx].nargs;
        <span class="keyword">this</span>.stack.push(f);
    };
    <span class="keyword">var</span> get_slot = <span class="keyword">function</span>(obj, name) {
        <span class="keyword">if</span> (<span class="keyword">typeof</span>(obj)===<span class="string">"string"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>special case fields of String</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (name === <span class="string">"__proto__"</span>) {
                <span class="keyword">return</span> MyString;
            }
            <span class="keyword">if</span> (name === <span class="string">"length"</span> || isFinite(<span class="number">1</span> * name)) {
                <span class="keyword">if</span> (name!==<span class="string">"length"</span>) {
                    console.log(<span class="string">"WARNING: accessing string char by index"</span>);
                }
                <span class="keyword">return</span> obj[name];
            }
            <span class="keyword">return</span> MyString[SLOT_PREFIX+name];
        }
        <span class="keyword">if</span> (<span class="keyword">typeof</span>(obj)===<span class="string">"boolean"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>special case fields of Boolean</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (name === <span class="string">"__proto__"</span>) {
                <span class="keyword">return</span> MyBoolean;
            }
            <span class="keyword">return</span> (obj ? MyTrue : MyFalse)[SLOT_PREFIX+name];
        }
        <span class="keyword">if</span> (<span class="keyword">typeof</span>(obj)===<span class="string">"number"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>special case fields of Number</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (name === <span class="string">"__proto__"</span>) {
                <span class="keyword">return</span> MyNumber;
            }
            <span class="keyword">return</span> MyNumber[SLOT_PREFIX+name];
        }
        <span class="keyword">if</span> (<span class="keyword">typeof</span>(obj)===<span class="string">"object"</span> &amp;&amp; obj!==<span class="literal">null</span> &amp;&amp; obj.array) {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>very basic TypedArray support</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (name === <span class="string">"length"</span> || isFinite(<span class="number">1</span> * name)) {
                <span class="keyword">return</span> obj.array[name];
            }
        }
        <span class="keyword">return</span> obj[SLOT_PREFIX+name];
    };
    dispatch.get_slot_direct = <span class="keyword">function</span>(slot_name_idx) {
        <span class="keyword">var</span> obj = <span class="keyword">this</span>.stack.pop();
        <span class="keyword">var</span> name = <span class="keyword">this</span>.literals[slot_name_idx];
        <span class="keyword">this</span>.stack.push(get_slot(obj, name));
    };
    dispatch.get_slot_direct_check = <span class="keyword">function</span>(slot_name_idx) {
        <span class="keyword">var</span> obj = <span class="keyword">this</span>.stack.pop();
        <span class="keyword">var</span> name = <span class="keyword">this</span>.literals[slot_name_idx];
        <span class="keyword">var</span> result = get_slot(obj, name);
        <span class="keyword">if</span> (!result) {</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>warn about unimplemented (probably library) functions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            console.log(<span class="string">"Failing lookup of method"</span>,
                        <span class="keyword">this</span>.literals[slot_name_idx]);
        }
        <span class="keyword">this</span>.stack.push(result);
    };
    dispatch.get_slot_indirect = <span class="keyword">function</span>() {
        <span class="keyword">var</span> name = <span class="keyword">this</span>.stack.pop();
        <span class="keyword">var</span> obj = <span class="keyword">this</span>.stack.pop();
        <span class="keyword">this</span>.stack.push(get_slot(obj, name));
    };
    <span class="keyword">var</span> set_slot = <span class="keyword">function</span>(obj, name, nval) {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>handle array sets specially: they update the length field.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (obj.type === <span class="string">"array"</span>) {
            <span class="keyword">if</span> (name === <span class="string">"length"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>sanity-check new length. XXX should throw RangeError</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                nval = (<span class="number">1</span>*nval) || <span class="number">0</span>;
                <span class="keyword">if</span> (nval &lt; <span class="number">0</span>) { nval = <span class="number">0</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>truncate the array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> i = obj[SLOT_PREFIX+<span class="string">"length"</span>];
                <span class="keyword">while</span> (i &gt; nval) {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Object.Delete defined in global.js; uses &#39;delete&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    Object.Delete(obj, SLOT_PREFIX+(i-<span class="number">1</span>));
                    i -= <span class="number">1</span>;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>fall through to set length</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            }
            <span class="keyword">if</span> (isFinite(<span class="number">1</span> * name)) {
                name = <span class="number">1</span> * name; <span class="comment">// convert to int</span>
                <span class="keyword">if</span> (name &gt;= obj[SLOT_PREFIX+<span class="string">"length"</span>]) {
                    obj[SLOT_PREFIX+<span class="string">"length"</span>] = name + <span class="number">1</span>;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>fall through to set element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>handle writes to booleans (not supported in standard javascript)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (<span class="keyword">typeof</span>(obj)===<span class="string">"boolean"</span>) {
            obj = obj ? MyTrue : MyFalse;
        }
        <span class="keyword">if</span> (<span class="keyword">typeof</span>(obj)===<span class="string">"object"</span> &amp;&amp; obj.array) {</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>very basic TypedArray support</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (isFinite(<span class="number">1</span> * name)) {
                obj[<span class="number">1</span>*name] = nval;
                <span class="keyword">return</span>;
            }
        }
        obj[SLOT_PREFIX+name] = nval;
    };
    dispatch.set_slot_direct = <span class="keyword">function</span>(slot_name_idx) {
        <span class="keyword">var</span> nval = <span class="keyword">this</span>.stack.pop();
        <span class="keyword">var</span> name = <span class="keyword">this</span>.literals[slot_name_idx];
        <span class="keyword">var</span> obj = <span class="keyword">this</span>.stack.pop();
        set_slot(obj, name, nval);
    };
    dispatch.set_slot_indirect = <span class="keyword">function</span>() {
        <span class="keyword">var</span> nval = <span class="keyword">this</span>.stack.pop();
        <span class="keyword">var</span> name = <span class="keyword">this</span>.stack.pop();
        <span class="keyword">var</span> obj = <span class="keyword">this</span>.stack.pop();
        set_slot(obj, name, nval);
    };
    dispatch.invoke = <span class="keyword">function</span>(nargs) {</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>collect arguments.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> i = nargs;
        <span class="keyword">var</span> my_arguments = Object.create(MyArray);
        <span class="keyword">while</span> (i &gt; <span class="number">0</span>) {
            my_arguments[SLOT_PREFIX+(i-<span class="number">1</span>)] = <span class="keyword">this</span>.stack.pop();
            i -= <span class="number">1</span>;
        }
        my_arguments[SLOT_PREFIX+<span class="string">"length"</span>] = nargs;</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>collect &#39;this&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> my_this = <span class="keyword">this</span>.stack.pop();</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>get function object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> func = <span class="keyword">this</span>.stack.pop();</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>assert func is a function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (func === <span class="literal">null</span> || <span class="keyword">typeof</span>(func) !== <span class="string">"object"</span> ||
            func.type !== <span class="string">"function"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>XXX: throw wrapped TypeError</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            Object.Throw(<span class="string">"Not a function at "</span>+<span class="keyword">this</span>.pc);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>&quot;native code&quot;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (func.type === <span class="string">"function"</span> &amp;&amp; func.native_code) {</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>build proper native arguments array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> native_args = [ my_this ];
            i = <span class="number">0</span>;
            <span class="keyword">while</span> (i &lt; nargs) {
                native_args.push(my_arguments[SLOT_PREFIX+i]);
                i += <span class="number">1</span>;
            }
            <span class="keyword">if</span> (func.is_apply) {</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>returns a new state, just like invoke does.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">return</span> func.native_code.apply(<span class="keyword">this</span>, native_args);
            }
            <span class="keyword">this</span>.stack.push(func.native_code.apply(<span class="keyword">this</span>, native_args));
            <span class="keyword">return</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>create new frame</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> nframe = Object.create(func.parent_frame);
        nframe[SLOT_PREFIX+<span class="string">"__proto__"</span>] = func.parent_frame;
        nframe[SLOT_PREFIX+<span class="string">"arguments"</span>] = my_arguments;
        nframe[SLOT_PREFIX+<span class="string">"this"</span>] = my_this;</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>construct new child state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> ns = mkstate(<span class="keyword">this</span>, nframe, func.module, func.func_id);</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>document.write(html_escape(&quot;--- &quot;+stack_trace(this)+&quot; --calling-&gt; &quot;+fname(ns)+&quot; ---\n&quot;));</p>
<p>ok, continue executing in child state!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> ns;
    };
    dispatch[<span class="string">"return"</span>] = <span class="keyword">function</span>() {
        <span class="keyword">var</span> retval = <span class="keyword">this</span>.stack.pop();</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>go up to the parent state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> ns = <span class="keyword">this</span>.parent;
        ns.stack.push(retval);</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>document.write(html_escape(&quot;--- &quot;+stack_trace(ns)+&quot; &lt;-returning-- &quot;+fname(this)+&quot; ---\n&quot;));</p>
<p>continue in parent state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> ns;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>branches</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> branch = <span class="keyword">function</span>(f) {
        <span class="keyword">return</span> <span class="keyword">function</span>(new_pc) {
            <span class="keyword">if</span> (<span class="keyword">typeof</span>(new_pc) !== <span class="string">"number"</span>) {
                new_pc = new_pc.label;
            }
            <span class="keyword">this</span>.pc = f.call(<span class="keyword">this</span>, new_pc);
        };
    };
    dispatch.jmp = branch(<span class="keyword">function</span>(new_pc) {
        <span class="keyword">return</span> new_pc;
    });
    dispatch.jmp_unless = branch(<span class="keyword">function</span>(new_pc) {
        <span class="keyword">var</span> condition = <span class="keyword">this</span>.stack.pop();
        <span class="keyword">return</span> condition ? <span class="keyword">this</span>.pc : new_pc;
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>stack manipulation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch.pop = <span class="keyword">function</span>() {
        <span class="keyword">this</span>.stack.pop();
    };
    dispatch.dup = <span class="keyword">function</span>() {
        <span class="keyword">var</span> top = <span class="keyword">this</span>.stack[<span class="keyword">this</span>.stack.length-<span class="number">1</span>];
        <span class="keyword">this</span>.stack.push(top);
    };
    dispatch[<span class="string">"2dup"</span>] = <span class="keyword">function</span>() {
        <span class="keyword">var</span> top = <span class="keyword">this</span>.stack[<span class="keyword">this</span>.stack.length-<span class="number">1</span>];
        <span class="keyword">var</span> nxt = <span class="keyword">this</span>.stack[<span class="keyword">this</span>.stack.length-<span class="number">2</span>];
        <span class="keyword">this</span>.stack.push(nxt);
        <span class="keyword">this</span>.stack.push(top);
    };
    dispatch.over = <span class="keyword">function</span>() {
        <span class="keyword">var</span> top = <span class="keyword">this</span>.stack.pop();
        <span class="keyword">var</span> nxt = <span class="keyword">this</span>.stack.pop();
        <span class="keyword">this</span>.stack.push(top);
        <span class="keyword">this</span>.stack.push(nxt);
        <span class="keyword">this</span>.stack.push(top);
    };
    dispatch.over2 = <span class="keyword">function</span>() {
        <span class="keyword">var</span> top = <span class="keyword">this</span>.stack.pop();
        <span class="keyword">var</span> nx1 = <span class="keyword">this</span>.stack.pop();
        <span class="keyword">var</span> nx2 = <span class="keyword">this</span>.stack.pop();
        <span class="keyword">this</span>.stack.push(top);
        <span class="keyword">this</span>.stack.push(nx2);
        <span class="keyword">this</span>.stack.push(nx1);
        <span class="keyword">this</span>.stack.push(top);
    };
    dispatch.swap = <span class="keyword">function</span>() {
        <span class="keyword">var</span> top = <span class="keyword">this</span>.stack.pop();
        <span class="keyword">var</span> nxt = <span class="keyword">this</span>.stack.pop();
        <span class="keyword">this</span>.stack.push(top);
        <span class="keyword">this</span>.stack.push(nxt);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>unary operators</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> unary = <span class="keyword">function</span>(f) {
        <span class="keyword">return</span> <span class="keyword">function</span>() {
            <span class="keyword">this</span>.stack.push(f(<span class="keyword">this</span>.stack.pop()));
        };
    };
    dispatch.un_not = unary(<span class="keyword">function</span>(arg) { <span class="keyword">return</span> !arg; });
    dispatch.un_minus = unary(<span class="keyword">function</span>(arg) { <span class="keyword">return</span> -arg; });
    dispatch.un_typeof = unary(<span class="keyword">function</span>(arg) {
        <span class="keyword">var</span> t = <span class="keyword">typeof</span>(arg);
        <span class="keyword">if</span> (t === <span class="string">"object"</span> &amp;&amp; arg !== <span class="literal">null</span>) {
            t = arg.type;
            <span class="keyword">if</span> (t === <span class="string">"array"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>weird javascript misfeature</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                t = <span class="string">"object"</span>;
            }
        }
        <span class="keyword">return</span> t;
    });
    <span class="keyword">var</span> binary = <span class="keyword">function</span>(f) {
        <span class="keyword">return</span> <span class="keyword">function</span>() {
            <span class="keyword">var</span> right = <span class="keyword">this</span>.stack.pop();
            <span class="keyword">var</span> left = <span class="keyword">this</span>.stack.pop();
            <span class="keyword">this</span>.stack.push(f(left, right));
        };
    };
    dispatch.bi_eq = binary(<span class="keyword">function</span>(l, r) { <span class="keyword">return</span> l === r; });
    dispatch.bi_gt = binary(<span class="keyword">function</span>(l, r) { <span class="keyword">return</span> l &gt; r; });
    dispatch.bi_gte = binary(<span class="keyword">function</span>(l, r) { <span class="keyword">return</span> l &gt;= r; });
    dispatch.bi_add = binary(<span class="keyword">function</span>(l, r) { <span class="keyword">return</span> l + r; });
    dispatch.bi_sub = binary(<span class="keyword">function</span>(l, r) { <span class="keyword">return</span> l - r; });
    dispatch.bi_mul = binary(<span class="keyword">function</span>(l, r) { <span class="keyword">return</span> l * r; });
    dispatch.bi_div = binary(<span class="keyword">function</span>(l, r) { <span class="keyword">return</span> l / r; });

    <span class="keyword">var</span> make_top_level_frame = <span class="keyword">function</span>() {
        <span class="keyword">var</span> frame = {};
        <span class="keyword">var</span> oset = <span class="keyword">function</span>(obj, name, value) {
            obj[SLOT_PREFIX+name] = value;
        };
        <span class="keyword">var</span> fset = <span class="keyword">function</span>(name, value) {
            oset(frame, name, value);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>set up &#39;this&#39; and &#39;arguments&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        fset(<span class="string">"this"</span>, <span class="keyword">this</span>);
        <span class="keyword">var</span> my_arguments = Object.create(MyArray);
        oset(my_arguments, <span class="string">"length"</span>, arguments.length);
        <span class="keyword">var</span> i = <span class="number">0</span>;
        <span class="keyword">while</span> ( i &lt; arguments.length ) {
            oset(my_arguments, i, arguments[i]);
            i += <span class="number">1</span>;
        }
        fset(<span class="string">"arguments"</span>, my_arguments);</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Constants</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> my_ObjectCons = Object.create(MyFunction);
        oset(my_ObjectCons, <span class="string">"prototype"</span>, MyObject);
        fset(<span class="string">"Object"</span>, my_ObjectCons);

        <span class="keyword">var</span> my_ArrayCons = Object.create(MyFunction);
        oset(my_ArrayCons, <span class="string">"prototype"</span>, MyArray);
        fset(<span class="string">"Array"</span>, my_ArrayCons);

        <span class="keyword">var</span> my_FunctionCons = Object.create(MyFunction);
        oset(my_FunctionCons, <span class="string">"prototype"</span>, MyFunction);
        fset(<span class="string">"Function"</span>, my_FunctionCons);

        <span class="keyword">var</span> my_BooleanCons = Object.create(MyFunction);
        oset(my_BooleanCons, <span class="string">"prototype"</span>, MyBoolean);
        fset(<span class="string">"Boolean"</span>, my_BooleanCons);

        <span class="keyword">var</span> my_StringCons = Object.create(MyFunction);
        oset(my_StringCons, <span class="string">"prototype"</span>, MyString);
        fset(<span class="string">"String"</span>, my_StringCons);

        <span class="keyword">var</span> my_NumberCons = Object.create(MyFunction);
        oset(my_NumberCons, <span class="string">"prototype"</span>, MyNumber);
        fset(<span class="string">"Number"</span>, my_NumberCons);

        fset(<span class="string">"Math"</span>, MyMath);</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>support for console.log</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> my_console = Object.create(MyObject);
        fset(<span class="string">"console"</span>, my_console);</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> native_func = <span class="keyword">function</span>(obj, name, f, is_apply<span class="comment">/*optional*/</span>) {
            <span class="keyword">var</span> my_func = Object.create(MyFunction);
            my_func.parent_frame = frame;
            my_func.native_code = f;
            oset(obj, name, my_func);
            <span class="keyword">if</span> (is_apply) {
                my_func.is_apply = is_apply;
            }
        };
        native_func(my_console, <span class="string">"log"</span>, <span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>ES-5 strict mode won&#39;t let us directly modify &#39;arguments&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> nargs = Array.prototype.concat.apply([], arguments);
            nargs[<span class="number">0</span>] = <span class="string">"INTERP:"</span>;
            console.log.apply(console, nargs);
        });
        native_func(MyObject, <span class="string">"hasOwnProperty"</span>, <span class="keyword">function</span>(_this_, propname) {
            <span class="keyword">return</span> _this_.hasOwnProperty(SLOT_PREFIX+propname);
        });
        native_func(my_ObjectCons, <span class="string">"create"</span>, <span class="keyword">function</span>(_this_, prototype) {</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Object.create defined in global.js; uses &#39;new&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> result = Object.create(prototype);
            oset(result, <span class="string">"__proto__"</span>, prototype);
            <span class="keyword">return</span> result;
        });
        native_func(my_ObjectCons, <span class="string">"Delete"</span>, <span class="keyword">function</span>(_this_, obj, propname) {
            Object.Delete(obj, SLOT_PREFIX+propname);
        });
        native_func(frame, <span class="string">"isNaN"</span>, <span class="keyword">function</span>(_this_, number) {
            <span class="keyword">return</span> isNaN(number);
        });
        native_func(frame, <span class="string">"isFinite"</span>, <span class="keyword">function</span>(_this_, number) {
            <span class="keyword">return</span> isFinite(number);
        });
        native_func(frame, <span class="string">"parseInt"</span>, <span class="keyword">function</span>(_this_, number, radix) {
            <span class="keyword">return</span> parseInt(number, radix);
        });
        native_func(frame, <span class="string">"now"</span>, <span class="keyword">function</span>(_this_) {
            <span class="keyword">return</span> now(); <span class="comment">/* (new Date()).getTime() */</span>
        });
        native_func(MyString, <span class="string">"charAt"</span>, <span class="keyword">function</span>(_this_, idx) {</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>note that accessing a string by index (w/o using charAt)
isn&#39;t actually part of EcmaScript 3 &amp; might not work in IE</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> _this_.charAt(idx);
        });
        native_func(MyString, <span class="string">"charCodeAt"</span>, <span class="keyword">function</span>(_this_, idx) {
            <span class="keyword">return</span> _this_.charCodeAt(idx);
        });
        native_func(MyString, <span class="string">"substring"</span>, <span class="keyword">function</span>(_this_, from, to) {
            <span class="keyword">return</span> _this_.substring(from, to);
        });
        native_func(my_StringCons, <span class="string">"fromCharCode"</span>, <span class="keyword">function</span>(_this_, arg) {
            <span class="keyword">return</span> String.fromCharCode(arg);
        });
        native_func(MyNumber, <span class="string">"toString"</span>, <span class="keyword">function</span>(_this_) {
            <span class="keyword">return</span> _this_.toString();
        });
        native_func(MyMath, <span class="string">"floor"</span>, <span class="keyword">function</span>(_this_, val) {
            <span class="keyword">return</span> Math.floor(val);
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p><em>Very</em> basic TypedArray support</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        native_func(my_ObjectCons, <span class="string">"newUint8Array"</span>, <span class="keyword">function</span>(_this_, size) {
            <span class="keyword">var</span> my_typedarray = Object.create(MyUint8Array);</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>newUint8Array defined in global.js; uses &#39;new&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            my_typedarray.array = Object.newUint8Array(size);
            <span class="keyword">return</span> my_typedarray;
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>XXX: We&#39;re not quite handling the &quot;this&quot; argument correctly.
According to:
<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function/call">https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function/call</a>
&quot;If thisArg is null or undefined, this will be the global
object. Otherwise, this will be equal to Object(thisArg)
(which is thisArg if thisArg is already an object, or a
String, Boolean, or Number if thisArg is a primitive value
of the corresponding type).&quot;
this is disallowed in ES-5 strict mode; throws an exception instead
 <a href="http://ejohn.org/blog/ecmascript-5-strict-mode-json-and-more/">http://ejohn.org/blog/ecmascript-5-strict-mode-json-and-more/</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        native_func(MyFunction, <span class="string">"call"</span>, <span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>push arguments on stack and use &#39;invoke&#39; bytecode op.
arg #0 is the function itself.
arg #1 is &#39;this&#39;
arg #2-#n are rest of arguments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> i = <span class="number">0</span>;
            <span class="keyword">while</span> ( i &lt; arguments.length ) {
                <span class="keyword">this</span>.stack.push(arguments[i]);
                i += <span class="number">1</span>;
            }
            <span class="keyword">return</span> dispatch.invoke.call(<span class="keyword">this</span>, arguments.length-<span class="number">2</span>);
        }, <span class="number">1</span><span class="comment">/*is apply*/</span>);
        native_func(MyFunction, <span class="string">"apply"</span>, <span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>push arguments on stack and use &#39;invoke&#39; bytecode op.
arg #0 is the function itself.
arg #1 is &#39;this&#39;
arg #2 is rest of arguments, as array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.stack.push(arguments[<span class="number">0</span>]);
            <span class="keyword">this</span>.stack.push(arguments[<span class="number">1</span>]);
            <span class="keyword">var</span> i = <span class="number">0</span>, nargs = arguments[<span class="number">2</span>][SLOT_PREFIX+<span class="string">"length"</span>];
            <span class="keyword">while</span> ( i &lt; nargs ) {
                <span class="keyword">this</span>.stack.push(arguments[<span class="number">2</span>][SLOT_PREFIX+i]);
                i += <span class="number">1</span>;
            }
            <span class="keyword">return</span> dispatch.invoke.call(<span class="keyword">this</span>, nargs);
        }, <span class="number">1</span><span class="comment">/*is apply*/</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>primitives will be replaced by message sends
XXX this is simplistic; a proper version should explicitly
    represent the type conversions performed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        native_func(MyObject, <span class="string">"+"</span>, <span class="keyword">function</span>(_this_, arg1) {
            <span class="keyword">return</span> _this_ + arg1;
        });
        native_func(MyObject, <span class="string">"-"</span>, <span class="keyword">function</span>(_this_, arg1) {
            <span class="keyword">return</span> _this_ - arg1;
        });
        native_func(MyObject, <span class="string">"*"</span>, <span class="keyword">function</span>(_this_, arg1) {
            <span class="keyword">return</span> _this_ * arg1;
        });
        native_func(MyObject, <span class="string">"/"</span>, <span class="keyword">function</span>(_this_, arg1) {
            <span class="keyword">return</span> _this_ / arg1;
        });
        native_func(MyObject, <span class="string">"="</span>, <span class="keyword">function</span>(_this_, arg1) {
            <span class="keyword">return</span> _this_ === arg1;
        });
        native_func(MyObject, <span class="string">"&gt;"</span>, <span class="keyword">function</span>(_this_, arg1) {
            <span class="keyword">return</span> _this_ &gt; arg1;
        });
        native_func(MyObject, <span class="string">"&gt;="</span>, <span class="keyword">function</span>(_this_, arg1) {
            <span class="keyword">return</span> _this_ &gt;= arg1;
        });

        <span class="keyword">return</span> frame;
    };

    <span class="keyword">var</span> binterp = <span class="keyword">function</span>(module, func_id, frame) {
        <span class="keyword">var</span> TOP = { stack: [] };
        <span class="keyword">var</span> FRAME = frame ? frame : make_top_level_frame.call({<span class="comment">/*this*/</span>});

        <span class="keyword">var</span> state = mkstate(TOP, FRAME, module, func_id);
        <span class="keyword">while</span> (state !== TOP) {
            state = interpret(state);
        }
        <span class="keyword">return</span> TOP.stack.pop();
    };
    <span class="keyword">var</span> invoke = <span class="keyword">function</span>(func, this_value, args) {
        <span class="keyword">var</span> my_arguments = Object.create(MyArray);
        args.forEach(<span class="keyword">function</span>(v, i) {
            my_arguments[SLOT_PREFIX+i] = v;
        });
        my_arguments[SLOT_PREFIX+<span class="string">"length"</span>] = args.length;
        <span class="keyword">var</span> nframe = Object.create(func.parent_frame);
        nframe[SLOT_PREFIX+<span class="string">"__proto__"</span>] = func.parent_frame;
        nframe[SLOT_PREFIX+<span class="string">"arguments"</span>] = my_arguments;
        nframe[SLOT_PREFIX+<span class="string">"this"</span>] = this_value;</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>go for it!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> binterp(func.module, func.func_id, nframe);
    };
    <span class="keyword">return</span> {
        __module_name__: <span class="string">"binterp"</span>,
        __module_init__: make_binterp,
        __module_deps__: [<span class="string">"bytecode-table"</span>, <span class="string">"html-escape"</span>],

        binterp: binterp,
        make_top_level_frame: make_top_level_frame,
        invoke: invoke
    };
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
