<!DOCTYPE html>

<html>
<head>
  <title>binterp.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="asm-llvm.html">
                asm-llvm.js
              </a>
            
              
              <a class="source" href="bcompile.html">
                bcompile.js
              </a>
            
              
              <a class="source" href="binterp.html">
                binterp.js
              </a>
            
              
              <a class="source" href="browsercanvas.html">
                browsercanvas.js
              </a>
            
              
              <a class="source" href="bytecode-table.html">
                bytecode-table.js
              </a>
            
              
              <a class="source" href="canvastest.html">
                canvastest.js
              </a>
            
              
              <a class="source" href="ccanvas.html">
                ccanvas.js
              </a>
            
              
              <a class="source" href="crender-styles.html">
                crender-styles.js
              </a>
            
              
              <a class="source" href="crender.html">
                crender.js
              </a>
            
              
              <a class="source" href="ctiles.html">
                ctiles.js
              </a>
            
              
              <a class="source" href="events.html">
                events.js
              </a>
            
              
              <a class="source" href="eventtests.html">
                eventtests.js
              </a>
            
              
              <a class="source" href="extensions.html">
                extensions.js
              </a>
            
              
              <a class="source" href="global-es5.html">
                global-es5.js
              </a>
            
              
              <a class="source" href="global.html">
                global.js
              </a>
            
              
              <a class="source" href="html-escape.html">
                html-escape.js
              </a>
            
              
              <a class="source" href="jcompile.html">
                jcompile.js
              </a>
            
              
              <a class="source" href="json2.html">
                json2.js
              </a>
            
              
              <a class="source" href="nodemain.html">
                nodemain.js
              </a>
            
              
              <a class="source" href="parse.html">
                parse.js
              </a>
            
              
              <a class="source" href="render.html">
                render.js
              </a>
            
              
              <a class="source" href="render2.html">
                render2.js
              </a>
            
              
              <a class="source" href="require.html">
                require.js
              </a>
            
              
              <a class="source" href="stdlib.html">
                stdlib.js
              </a>
            
              
              <a class="source" href="str-escape.html">
                str-escape.js
              </a>
            
              
              <a class="source" href="tdop.html">
                tdop.js
              </a>
            
              
              <a class="source" href="tests.html">
                tests.js
              </a>
            
              
              <a class="source" href="text.html">
                text.js
              </a>
            
              
              <a class="source" href="tiles.html">
                tiles.js
              </a>
            
              
              <a class="source" href="tokenize.html">
                tokenize.js
              </a>
            
              
              <a class="source" href="top-level.html">
                top-level.js
              </a>
            
              
              <a class="source" href="ts.html">
                ts.js
              </a>
            
              
              <a class="source" href="write-lua-bytecode.html">
                write-lua-bytecode.js
              </a>
            
              
              <a class="source" href="write-lua-ops.html">
                write-lua-ops.js
              </a>
            
              
              <a class="source" href="write-php-bytecode.html">
                write-php-bytecode.js
              </a>
            
              
              <a class="source" href="write-php-ops.html">
                write-php-ops.js
              </a>
            
              
              <a class="source" href="write-rust-bytecode.html">
                write-rust-bytecode.js
              </a>
            
              
              <a class="source" href="write-rust-ops.html">
                write-rust-ops.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="binterpjs">binterp.js</h1>
<p>Bytecode interpreter, written in Simplified JavaScript.</p>
<p>TODO: string coercions aren&#39;t quite right yet, we don&#39;t call the
      proper toString() method, etc.</p>
<p>C. Scott Ananian
2011-05-11</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>define([<span class="hljs-string">"text!binterp.js"</span>, <span class="hljs-string">"bytecode-table"</span><span class="hljs-comment">/*, "!html-escape"*/</span>], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make_binterp</span>(<span class="hljs-params">binterp_source, bytecode_table, html_escape</span>) </span>{
    <span class="hljs-keyword">var</span> mkstate = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">parent, frame, module, func_id</span>) </span>{
        <span class="hljs-keyword">return</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Main interpreter state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            parent: parent, <span class="hljs-comment">// calling context (another state)</span>
            <span class="hljs-attr">frame</span>: frame,
            <span class="hljs-attr">local_frame</span>: <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>),
            <span class="hljs-attr">stack</span>: [],
            <span class="hljs-attr">pc</span>: <span class="hljs-number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>from bytecode file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-built_in">module</span>: <span class="hljs-built_in">module</span>,
            <span class="hljs-attr">func_id</span>: func_id,</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>cached</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            bytecode: <span class="hljs-built_in">module</span>.functions[func_id].bytecode,
            <span class="hljs-attr">literals</span>: <span class="hljs-built_in">module</span>.literals
        };
    };
    <span class="hljs-keyword">var</span> invoke; <span class="hljs-comment">// forward declaration</span>

    <span class="hljs-keyword">var</span> dispatch = {};
    <span class="hljs-keyword">var</span> SLOT_PREFIX = <span class="hljs-string">"!bi!"</span>; <span class="hljs-comment">// prevent leaking slots from metacontext</span>

    <span class="hljs-keyword">var</span> MyObject = {};
    MyObject.type = <span class="hljs-string">"object"</span>;
    <span class="hljs-keyword">var</span> MyArray = <span class="hljs-built_in">Object</span>.create(MyObject);
    MyArray.type = <span class="hljs-string">"array"</span>;
    MyArray[SLOT_PREFIX+<span class="hljs-string">"length"</span>] = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> MyFunction = <span class="hljs-built_in">Object</span>.create(MyObject);
    MyFunction.type = <span class="hljs-string">"function"</span>;
    <span class="hljs-keyword">var</span> MyString = <span class="hljs-built_in">Object</span>.create(MyObject);
    MyString.type = <span class="hljs-string">"string"</span>;
    <span class="hljs-keyword">var</span> MyNumber = <span class="hljs-built_in">Object</span>.create(MyObject);
    MyNumber.type = <span class="hljs-string">"number"</span>;
    <span class="hljs-keyword">var</span> MyBoolean = <span class="hljs-built_in">Object</span>.create(MyObject);
    MyBoolean.type = <span class="hljs-string">"boolean"</span>;
    <span class="hljs-keyword">var</span> MyTrue = <span class="hljs-built_in">Object</span>.create(MyBoolean);
    MyTrue.value = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">var</span> MyFalse = <span class="hljs-built_in">Object</span>.create(MyBoolean);
    MyFalse.value = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">var</span> MyMath = <span class="hljs-built_in">Object</span>.create(MyObject);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Basic TypedArray support</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> MyUint8Array = <span class="hljs-built_in">Object</span>.create(MyObject);

    <span class="hljs-keyword">var</span> interpret = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">state</span>) </span>{
        <span class="hljs-keyword">var</span> op = bytecode_table.for_num(state.bytecode[state.pc]);
        <span class="hljs-comment">/*
        document.write("Executing: " +
                       state.pc + ": " +
                       op.name +
                       op.printargs(state.module, state.bytecode, state.pc)+
                       "  \n");
        */</span>
        <span class="hljs-keyword">var</span> args = [];
        <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> (i &lt; op.args) {
            args.push(state.bytecode[state.pc + i + <span class="hljs-number">1</span>]);
            i += <span class="hljs-number">1</span>;
        }
        state.pc += <span class="hljs-number">1</span> + op.args;
        <span class="hljs-keyword">var</span> ns = dispatch[op.name].apply(state, args);
        <span class="hljs-comment">/*
        document.write(JSON.stringify(state.stack,
                                      ['type', SLOT_PREFIX+"length"])+"\n");
        */</span>
        <span class="hljs-keyword">return</span> ns ? ns : state;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>helpers for debugging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> fname = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">state</span>) </span>{
        <span class="hljs-keyword">var</span> result, name;
        <span class="hljs-keyword">var</span> func_id = state.func_id;
        result = <span class="hljs-string">"#"</span>+func_id;
        name = state.module ? state.module.functions[func_id].name : <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span> (name) {
            result += <span class="hljs-string">" ("</span>+name+<span class="hljs-string">")"</span>;
        }
        <span class="hljs-keyword">return</span> result;
    };
    <span class="hljs-keyword">var</span> stack_trace = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">state</span>) </span>{
        <span class="hljs-keyword">if</span> (!state.parent) { <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>; }
        <span class="hljs-keyword">return</span> stack_trace(state.parent) + <span class="hljs-string">"-&gt;"</span> + fname(state);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Implementations of bytecode instructions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch.push_frame = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.stack.push(<span class="hljs-keyword">this</span>.frame);
    };
    dispatch.push_local_frame = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>These variables don&#39;t escape into child functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.stack.push(<span class="hljs-keyword">this</span>.local_frame);
    };
    dispatch.push_literal = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">idx</span>) </span>{
        <span class="hljs-keyword">this</span>.stack.push(<span class="hljs-keyword">this</span>.literals[idx]);
    };
    dispatch.new_object = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.stack.push(<span class="hljs-built_in">Object</span>.create(MyObject));
    };
    dispatch.new_array = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> na = <span class="hljs-built_in">Object</span>.create(MyArray);
        na[SLOT_PREFIX+<span class="hljs-string">"length"</span>] = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>.stack.push(na);
    };
    dispatch.new_function = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">idx</span>) </span>{
        <span class="hljs-keyword">var</span> f = <span class="hljs-built_in">Object</span>.create(MyFunction);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>hidden fields of function object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        f.parent_frame = <span class="hljs-keyword">this</span>.frame;
        f.module = <span class="hljs-keyword">this</span>.module;
        f.func_id = idx;
        f[SLOT_PREFIX+<span class="hljs-string">"name"</span>] = <span class="hljs-keyword">this</span>.module.functions[idx].name;
        f[SLOT_PREFIX+<span class="hljs-string">"length"</span>] = <span class="hljs-keyword">this</span>.module.functions[idx].nargs;
        <span class="hljs-keyword">this</span>.stack.push(f);
    };
    <span class="hljs-keyword">var</span> get_slot = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">obj, name</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(obj)===<span class="hljs-string">"string"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>special case fields of String</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (name === <span class="hljs-string">"__proto__"</span>) {
                <span class="hljs-keyword">return</span> MyString;
            }
            <span class="hljs-keyword">if</span> (name === <span class="hljs-string">"length"</span> || <span class="hljs-built_in">isFinite</span>(<span class="hljs-number">1</span> * name)) {
                <span class="hljs-keyword">if</span> (name!==<span class="hljs-string">"length"</span>) {
                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"WARNING: accessing string char by index"</span>);
                }
                <span class="hljs-keyword">return</span> obj[name];
            }
            <span class="hljs-keyword">return</span> MyString[SLOT_PREFIX+name];
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(obj)===<span class="hljs-string">"boolean"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>special case fields of Boolean</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (name === <span class="hljs-string">"__proto__"</span>) {
                <span class="hljs-keyword">return</span> MyBoolean;
            }
            <span class="hljs-keyword">return</span> (obj ? MyTrue : MyFalse)[SLOT_PREFIX+name];
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(obj)===<span class="hljs-string">"number"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>special case fields of Number</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (name === <span class="hljs-string">"__proto__"</span>) {
                <span class="hljs-keyword">return</span> MyNumber;
            }
            <span class="hljs-keyword">return</span> MyNumber[SLOT_PREFIX+name];
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(obj)===<span class="hljs-string">"object"</span> &amp;&amp; obj!==<span class="hljs-literal">null</span> &amp;&amp; obj.array) {</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>very basic TypedArray support</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (name === <span class="hljs-string">"length"</span> || <span class="hljs-built_in">isFinite</span>(<span class="hljs-number">1</span> * name)) {
                <span class="hljs-keyword">return</span> obj.array[name];
            }
        }
        <span class="hljs-keyword">return</span> obj[SLOT_PREFIX+name];
    };
    dispatch.get_slot_direct = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">slot_name_idx</span>) </span>{
        <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">this</span>.stack.pop();
        <span class="hljs-keyword">var</span> name = <span class="hljs-keyword">this</span>.literals[slot_name_idx];
        <span class="hljs-keyword">this</span>.stack.push(get_slot(obj, name));
    };
    dispatch.get_slot_direct_check = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">slot_name_idx</span>) </span>{
        <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">this</span>.stack.pop();
        <span class="hljs-keyword">var</span> name = <span class="hljs-keyword">this</span>.literals[slot_name_idx];
        <span class="hljs-keyword">var</span> result = get_slot(obj, name);
        <span class="hljs-keyword">if</span> (!result) {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>warn about unimplemented (probably library) functions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Failing lookup of method"</span>,
                        <span class="hljs-keyword">this</span>.literals[slot_name_idx]);
        }
        <span class="hljs-keyword">this</span>.stack.push(result);
    };
    dispatch.get_slot_indirect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> name = <span class="hljs-keyword">this</span>.stack.pop();
        <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">this</span>.stack.pop();
        <span class="hljs-keyword">this</span>.stack.push(get_slot(obj, name));
    };
    <span class="hljs-keyword">var</span> set_slot = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">obj, name, nval</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>handle array sets specially: they update the length field.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (obj.type === <span class="hljs-string">"array"</span>) {
            <span class="hljs-keyword">if</span> (name === <span class="hljs-string">"length"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>sanity-check new length. XXX should throw RangeError</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                nval = (<span class="hljs-number">1</span>*nval) || <span class="hljs-number">0</span>;
                <span class="hljs-keyword">if</span> (nval &lt; <span class="hljs-number">0</span>) { nval = <span class="hljs-number">0</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>truncate the array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> i = obj[SLOT_PREFIX+<span class="hljs-string">"length"</span>];
                <span class="hljs-keyword">while</span> (i &gt; nval) {</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Object.Delete defined in global.js; uses &#39;delete&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-built_in">Object</span>.Delete(obj, SLOT_PREFIX+(i<span class="hljs-number">-1</span>));
                    i -= <span class="hljs-number">1</span>;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>fall through to set length</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            }
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isFinite</span>(<span class="hljs-number">1</span> * name)) {
                name = <span class="hljs-number">1</span> * name; <span class="hljs-comment">// convert to int</span>
                <span class="hljs-keyword">if</span> (name &gt;= obj[SLOT_PREFIX+<span class="hljs-string">"length"</span>]) {
                    obj[SLOT_PREFIX+<span class="hljs-string">"length"</span>] = name + <span class="hljs-number">1</span>;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>fall through to set element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>handle writes to booleans (not supported in standard javascript)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(obj)===<span class="hljs-string">"boolean"</span>) {
            obj = obj ? MyTrue : MyFalse;
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(obj)===<span class="hljs-string">"object"</span> &amp;&amp; obj.array) {</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>very basic TypedArray support</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isFinite</span>(<span class="hljs-number">1</span> * name)) {
                obj[<span class="hljs-number">1</span>*name] = nval;
                <span class="hljs-keyword">return</span>;
            }
        }
        obj[SLOT_PREFIX+name] = nval;
    };
    dispatch.set_slot_direct = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">slot_name_idx</span>) </span>{
        <span class="hljs-keyword">var</span> nval = <span class="hljs-keyword">this</span>.stack.pop();
        <span class="hljs-keyword">var</span> name = <span class="hljs-keyword">this</span>.literals[slot_name_idx];
        <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">this</span>.stack.pop();
        set_slot(obj, name, nval);
    };
    dispatch.set_slot_indirect = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> nval = <span class="hljs-keyword">this</span>.stack.pop();
        <span class="hljs-keyword">var</span> name = <span class="hljs-keyword">this</span>.stack.pop();
        <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">this</span>.stack.pop();
        set_slot(obj, name, nval);
    };
    dispatch.invoke = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">nargs</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>collect arguments.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> i = nargs;
        <span class="hljs-keyword">var</span> my_arguments = <span class="hljs-built_in">Object</span>.create(MyArray);
        <span class="hljs-keyword">while</span> (i &gt; <span class="hljs-number">0</span>) {
            my_arguments[SLOT_PREFIX+(i<span class="hljs-number">-1</span>)] = <span class="hljs-keyword">this</span>.stack.pop();
            i -= <span class="hljs-number">1</span>;
        }
        my_arguments[SLOT_PREFIX+<span class="hljs-string">"length"</span>] = nargs;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>collect &#39;this&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> my_this = <span class="hljs-keyword">this</span>.stack.pop();</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>get function object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> func = <span class="hljs-keyword">this</span>.stack.pop();</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>assert func is a function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (func === <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span>(func) !== <span class="hljs-string">"object"</span> ||
            func.type !== <span class="hljs-string">"function"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>XXX: throw wrapped TypeError</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-built_in">Object</span>.Throw(<span class="hljs-string">"Not a function at "</span>+<span class="hljs-keyword">this</span>.pc);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>&quot;native code&quot;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (func.type === <span class="hljs-string">"function"</span> &amp;&amp; func.native_code) {</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>build proper native arguments array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> native_args = [ my_this ];
            i = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">while</span> (i &lt; nargs) {
                native_args.push(my_arguments[SLOT_PREFIX+i]);
                i += <span class="hljs-number">1</span>;
            }
            <span class="hljs-keyword">if</span> (func.is_apply) {</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>returns a new state, just like invoke does.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">return</span> func.native_code.apply(<span class="hljs-keyword">this</span>, native_args);
            }
            <span class="hljs-keyword">this</span>.stack.push(func.native_code.apply(<span class="hljs-keyword">this</span>, native_args));
            <span class="hljs-keyword">return</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>create new frame</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> nframe = <span class="hljs-built_in">Object</span>.create(func.parent_frame);
        nframe[SLOT_PREFIX+<span class="hljs-string">"__proto__"</span>] = func.parent_frame;</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>construct new child state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> ns = mkstate(<span class="hljs-keyword">this</span>, nframe, func.module, func.func_id);
        ns.local_frame[SLOT_PREFIX+<span class="hljs-string">"arguments"</span>] = my_arguments;
        ns.local_frame[SLOT_PREFIX+<span class="hljs-string">"this"</span>] = my_this;</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>document.write(html_escape(&quot;--- &quot;+stack_trace(this)+&quot; --calling-&gt; &quot;+fname(ns)+&quot; ---\n&quot;));</p>
<p>ok, continue executing in child state!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> ns;
    };
    dispatch[<span class="hljs-string">"return"</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> retval = <span class="hljs-keyword">this</span>.stack.pop();</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>go up to the parent state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> ns = <span class="hljs-keyword">this</span>.parent;
        ns.stack.push(retval);</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>document.write(html_escape(&quot;--- &quot;+stack_trace(ns)+&quot; &lt;-returning-- &quot;+fname(this)+&quot; ---\n&quot;));</p>
<p>continue in parent state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> ns;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>branches</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> branch = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">f</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">new_pc</span>) </span>{
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(new_pc) !== <span class="hljs-string">"number"</span>) {
                new_pc = new_pc.label;
            }
            <span class="hljs-keyword">this</span>.pc = f.call(<span class="hljs-keyword">this</span>, new_pc);
        };
    };
    dispatch.jmp = branch(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">new_pc</span>) </span>{
        <span class="hljs-keyword">return</span> new_pc;
    });
    dispatch.jmp_unless = branch(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">new_pc</span>) </span>{
        <span class="hljs-keyword">var</span> condition = <span class="hljs-keyword">this</span>.stack.pop();
        <span class="hljs-keyword">return</span> condition ? <span class="hljs-keyword">this</span>.pc : new_pc;
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>stack manipulation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch.pop = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.stack.pop();
    };
    dispatch.dup = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> top = <span class="hljs-keyword">this</span>.stack[<span class="hljs-keyword">this</span>.stack.length<span class="hljs-number">-1</span>];
        <span class="hljs-keyword">this</span>.stack.push(top);
    };
    dispatch[<span class="hljs-string">"2dup"</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> top = <span class="hljs-keyword">this</span>.stack[<span class="hljs-keyword">this</span>.stack.length<span class="hljs-number">-1</span>];
        <span class="hljs-keyword">var</span> nxt = <span class="hljs-keyword">this</span>.stack[<span class="hljs-keyword">this</span>.stack.length<span class="hljs-number">-2</span>];
        <span class="hljs-keyword">this</span>.stack.push(nxt);
        <span class="hljs-keyword">this</span>.stack.push(top);
    };
    dispatch.over = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> top = <span class="hljs-keyword">this</span>.stack.pop();
        <span class="hljs-keyword">var</span> nxt = <span class="hljs-keyword">this</span>.stack.pop();
        <span class="hljs-keyword">this</span>.stack.push(top);
        <span class="hljs-keyword">this</span>.stack.push(nxt);
        <span class="hljs-keyword">this</span>.stack.push(top);
    };
    dispatch.over2 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> top = <span class="hljs-keyword">this</span>.stack.pop();
        <span class="hljs-keyword">var</span> nx1 = <span class="hljs-keyword">this</span>.stack.pop();
        <span class="hljs-keyword">var</span> nx2 = <span class="hljs-keyword">this</span>.stack.pop();
        <span class="hljs-keyword">this</span>.stack.push(top);
        <span class="hljs-keyword">this</span>.stack.push(nx2);
        <span class="hljs-keyword">this</span>.stack.push(nx1);
        <span class="hljs-keyword">this</span>.stack.push(top);
    };
    dispatch.swap = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> top = <span class="hljs-keyword">this</span>.stack.pop();
        <span class="hljs-keyword">var</span> nxt = <span class="hljs-keyword">this</span>.stack.pop();
        <span class="hljs-keyword">this</span>.stack.push(top);
        <span class="hljs-keyword">this</span>.stack.push(nxt);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>unary operators</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> unary = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">f</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">this</span>.stack.push(f(<span class="hljs-keyword">this</span>.stack.pop()));
        };
    };
    dispatch.un_not = unary(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">arg</span>) </span>{ <span class="hljs-keyword">return</span> !arg; });
    dispatch.un_minus = unary(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">arg</span>) </span>{ <span class="hljs-keyword">return</span> -arg; });
    dispatch.un_typeof = unary(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">arg</span>) </span>{
        <span class="hljs-keyword">var</span> t = <span class="hljs-keyword">typeof</span>(arg);
        <span class="hljs-keyword">if</span> (t === <span class="hljs-string">"object"</span> &amp;&amp; arg !== <span class="hljs-literal">null</span>) {
            t = arg.type;
            <span class="hljs-keyword">if</span> (t === <span class="hljs-string">"array"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>weird javascript misfeature</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                t = <span class="hljs-string">"object"</span>;
            }
            <span class="hljs-keyword">if</span> (t === <span class="hljs-string">'function'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>If non-callable we&#39;ll say this is an object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (arg.parent_frame || arg.native_code) {
                    <span class="hljs-comment">/* A callable function! */</span>
                } <span class="hljs-keyword">else</span> {
                    t = <span class="hljs-string">'object'</span>; <span class="hljs-comment">// not callable</span>
                }
            }
        }
        <span class="hljs-keyword">return</span> t;
    });
    <span class="hljs-keyword">var</span> binary = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">f</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> right = <span class="hljs-keyword">this</span>.stack.pop();
            <span class="hljs-keyword">var</span> left = <span class="hljs-keyword">this</span>.stack.pop();
            <span class="hljs-keyword">this</span>.stack.push(f(left, right));
        };
    };
    dispatch.bi_eq = binary(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">l, r</span>) </span>{ <span class="hljs-keyword">return</span> l === r; });
    dispatch.bi_gt = binary(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">l, r</span>) </span>{ <span class="hljs-keyword">return</span> l &gt; r; });
    dispatch.bi_gte = binary(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">l, r</span>) </span>{ <span class="hljs-keyword">return</span> l &gt;= r; });
    dispatch.bi_add = binary(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">l, r</span>) </span>{ <span class="hljs-keyword">return</span> l + r; });
    dispatch.bi_sub = binary(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">l, r</span>) </span>{ <span class="hljs-keyword">return</span> l - r; });
    dispatch.bi_mul = binary(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">l, r</span>) </span>{ <span class="hljs-keyword">return</span> l * r; });
    dispatch.bi_div = binary(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">l, r</span>) </span>{ <span class="hljs-keyword">return</span> l / r; });

    <span class="hljs-keyword">var</span> make_top_level_frame = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> frame = {};
        <span class="hljs-keyword">var</span> oset = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">obj, name, value</span>) </span>{
            obj[SLOT_PREFIX+name] = value;
        };
        <span class="hljs-keyword">var</span> fset = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name, value</span>) </span>{
            oset(frame, name, value);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>this frame is the <code>globalThis</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        fset(<span class="hljs-string">"globalThis"</span>, frame);</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Constants</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> my_ObjectCons = <span class="hljs-built_in">Object</span>.create(MyFunction);
        oset(my_ObjectCons, <span class="hljs-string">"prototype"</span>, MyObject);
        fset(<span class="hljs-string">"Object"</span>, my_ObjectCons);

        <span class="hljs-keyword">var</span> my_ArrayCons = <span class="hljs-built_in">Object</span>.create(MyFunction);
        oset(my_ArrayCons, <span class="hljs-string">"prototype"</span>, MyArray);
        fset(<span class="hljs-string">"Array"</span>, my_ArrayCons);

        <span class="hljs-keyword">var</span> my_FunctionCons = <span class="hljs-built_in">Object</span>.create(MyFunction);
        oset(my_FunctionCons, <span class="hljs-string">"prototype"</span>, MyFunction);
        fset(<span class="hljs-string">"Function"</span>, my_FunctionCons);

        <span class="hljs-keyword">var</span> my_BooleanCons = <span class="hljs-built_in">Object</span>.create(MyFunction);
        oset(my_BooleanCons, <span class="hljs-string">"prototype"</span>, MyBoolean);
        fset(<span class="hljs-string">"Boolean"</span>, my_BooleanCons);

        <span class="hljs-keyword">var</span> my_StringCons = <span class="hljs-built_in">Object</span>.create(MyFunction);
        oset(my_StringCons, <span class="hljs-string">"prototype"</span>, MyString);
        fset(<span class="hljs-string">"String"</span>, my_StringCons);

        <span class="hljs-keyword">var</span> my_NumberCons = <span class="hljs-built_in">Object</span>.create(MyFunction);
        oset(my_NumberCons, <span class="hljs-string">"prototype"</span>, MyNumber);
        fset(<span class="hljs-string">"Number"</span>, my_NumberCons);

        fset(<span class="hljs-string">"Math"</span>, MyMath);</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>support for console.log</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> my_console = <span class="hljs-built_in">Object</span>.create(MyObject);
        fset(<span class="hljs-string">"console"</span>, my_console);</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> native_func = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">obj, name, f, is_apply<span class="hljs-regexp">/*optional*/</span></span>) </span>{
            <span class="hljs-keyword">var</span> my_func = <span class="hljs-built_in">Object</span>.create(MyFunction);
            my_func.parent_frame = frame;
            my_func.native_code = f;
            oset(obj, name, my_func);
            <span class="hljs-keyword">if</span> (is_apply) {
                my_func.is_apply = is_apply;
            }
        };
        native_func(my_console, <span class="hljs-string">"log"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>ES-5 strict mode won&#39;t let us directly modify &#39;arguments&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> nargs = <span class="hljs-built_in">Array</span>.prototype.concat.apply([], <span class="hljs-built_in">arguments</span>);
            nargs[<span class="hljs-number">0</span>] = <span class="hljs-string">"INTERP:"</span>;
            <span class="hljs-built_in">console</span>.log.apply(<span class="hljs-built_in">console</span>, nargs);
        });
        native_func(MyObject, <span class="hljs-string">"hasOwnProperty"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_, propname</span>) </span>{
            <span class="hljs-keyword">return</span> _this_.hasOwnProperty(SLOT_PREFIX+propname);
        });
        native_func(my_ObjectCons, <span class="hljs-string">"create"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_, prototype</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Object.create defined in global.js; uses &#39;new&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> result = <span class="hljs-built_in">Object</span>.create(prototype);
            oset(result, <span class="hljs-string">"__proto__"</span>, prototype);
            <span class="hljs-keyword">return</span> result;
        });
        native_func(my_ObjectCons, <span class="hljs-string">"Delete"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_, obj, propname</span>) </span>{
            <span class="hljs-built_in">Object</span>.Delete(obj, SLOT_PREFIX+propname);
        });
        native_func(my_ObjectCons, <span class="hljs-string">"Try"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_, context, bodyBlock, catchBlock, finallyBlock</span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.Try(<span class="hljs-literal">null</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> invoke(bodyBlock, context, []);
            }, catchBlock ? <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
                invoke(catchBlock, context, [e]);
            } : <span class="hljs-literal">undefined</span>, finallyBlock ? <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                invoke(finallyBlock, context, []);
            } : <span class="hljs-literal">undefined</span>);
        });
        native_func(my_ObjectCons, <span class="hljs-string">"Throw"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_, e</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>XXX We could wrap this to easily distinguish interpreted
exceptions from real exceptions; if we did so we&#39;d need to
unwrap above in the implementation of Object.Throw&#39;s catchBlock</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-built_in">Object</span>.Throw(e);
        });
        native_func(frame, <span class="hljs-string">"isNaN"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_, number</span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">isNaN</span>(number);
        });
        native_func(frame, <span class="hljs-string">"isFinite"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_, number</span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">isFinite</span>(number);
        });
        native_func(frame, <span class="hljs-string">"parseInt"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_, number, radix</span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseInt</span>(number, radix);
        });
        native_func(frame, <span class="hljs-string">"now"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_</span>) </span>{
            <span class="hljs-keyword">return</span> now(); <span class="hljs-comment">/* (new Date()).getTime() */</span>
        });
        native_func(MyString, <span class="hljs-string">"charAt"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_, idx</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>note that accessing a string by index (w/o using charAt)
isn&#39;t actually part of EcmaScript 3 &amp; might not work in IE</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> _this_.charAt(idx);
        });
        native_func(MyString, <span class="hljs-string">"charCodeAt"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_, idx</span>) </span>{
            <span class="hljs-keyword">return</span> _this_.charCodeAt(idx);
        });
        native_func(MyString, <span class="hljs-string">"substring"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_, from, to</span>) </span>{
            <span class="hljs-keyword">return</span> _this_.substring(<span class="hljs-keyword">from</span>, to);
        });
        native_func(my_StringCons, <span class="hljs-string">"fromCharCode"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_, arg</span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">String</span>.fromCharCode(arg);
        });
        native_func(MyNumber, <span class="hljs-string">"valueOf"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_</span>) </span>{
            <span class="hljs-keyword">return</span> _this_.valueOf();
        });
        native_func(MyMath, <span class="hljs-string">"floor"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_, val</span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.floor(val);
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p><em>Very</em> basic TypedArray support</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        native_func(my_ObjectCons, <span class="hljs-string">"newUint8Array"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_, size</span>) </span>{
            <span class="hljs-keyword">var</span> my_typedarray = <span class="hljs-built_in">Object</span>.create(MyUint8Array);</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>newUint8Array defined in global.js; uses &#39;new&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            my_typedarray.array = <span class="hljs-built_in">Object</span>.newUint8Array(size);
            <span class="hljs-keyword">return</span> my_typedarray;
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>In non-strict mode, if thisArg is null or undefined it is
replaced with the global object; otherwise it is equal to
ToObject(thisArg).
<a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function/call">https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function/call</a>
We&#39;re implementing strict mode semantics, where no massaging
of the this argument is done; it is provided to the callee
as-is.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        native_func(MyFunction, <span class="hljs-string">"call"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>push arguments on stack and use &#39;invoke&#39; bytecode op.
arg #0 is the function itself.
arg #1 is &#39;this&#39;
arg #2-#n are rest of arguments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">while</span> ( i &lt; <span class="hljs-built_in">arguments</span>.length ) {
                <span class="hljs-keyword">this</span>.stack.push(<span class="hljs-built_in">arguments</span>[i]);
                i += <span class="hljs-number">1</span>;
            }
            <span class="hljs-keyword">return</span> dispatch.invoke.call(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>.length<span class="hljs-number">-2</span>);
        }, <span class="hljs-number">1</span><span class="hljs-comment">/*is apply*/</span>);
        native_func(MyFunction, <span class="hljs-string">"apply"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>push arguments on stack and use &#39;invoke&#39; bytecode op.
arg #0 is the function itself.
arg #1 is &#39;this&#39;
arg #2 is rest of arguments, as array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>.stack.push(<span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>]);
            <span class="hljs-keyword">this</span>.stack.push(<span class="hljs-built_in">arguments</span>[<span class="hljs-number">1</span>]);
            <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, nargs = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">2</span>][SLOT_PREFIX+<span class="hljs-string">"length"</span>];
            <span class="hljs-keyword">while</span> ( i &lt; nargs ) {
                <span class="hljs-keyword">this</span>.stack.push(<span class="hljs-built_in">arguments</span>[<span class="hljs-number">2</span>][SLOT_PREFIX+i]);
                i += <span class="hljs-number">1</span>;
            }
            <span class="hljs-keyword">return</span> dispatch.invoke.call(<span class="hljs-keyword">this</span>, nargs);
        }, <span class="hljs-number">1</span><span class="hljs-comment">/*is apply*/</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>primitives will be replaced by message sends
XXX this is simplistic; a proper version should explicitly
    represent the type conversions performed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        native_func(MyObject, <span class="hljs-string">"+"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_, arg1</span>) </span>{
            <span class="hljs-keyword">return</span> _this_ + arg1;
        });
        native_func(MyObject, <span class="hljs-string">"-"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_, arg1</span>) </span>{
            <span class="hljs-keyword">return</span> _this_ - arg1;
        });
        native_func(MyObject, <span class="hljs-string">"*"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_, arg1</span>) </span>{
            <span class="hljs-keyword">return</span> _this_ * arg1;
        });
        native_func(MyObject, <span class="hljs-string">"/"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_, arg1</span>) </span>{
            <span class="hljs-keyword">return</span> _this_ / arg1;
        });
        native_func(MyObject, <span class="hljs-string">"="</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_, arg1</span>) </span>{
            <span class="hljs-keyword">return</span> _this_ === arg1;
        });
        native_func(MyObject, <span class="hljs-string">"&gt;"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_, arg1</span>) </span>{
            <span class="hljs-keyword">return</span> _this_ &gt; arg1;
        });
        native_func(MyObject, <span class="hljs-string">"&gt;="</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_this_, arg1</span>) </span>{
            <span class="hljs-keyword">return</span> _this_ &gt;= arg1;
        });

        <span class="hljs-keyword">return</span> frame;
    };

    <span class="hljs-keyword">var</span> binterp = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">module, func_id, frame, this_value, my_arguments, local_frame</span>) </span>{
        <span class="hljs-keyword">if</span> (frame===<span class="hljs-literal">undefined</span>) {
            frame = make_top_level_frame();
        }
        <span class="hljs-keyword">if</span> (this_value===<span class="hljs-literal">undefined</span> &amp;&amp; my_arguments === <span class="hljs-literal">undefined</span>) {
            this_value = <span class="hljs-literal">undefined</span>; <span class="hljs-comment">// "Strict mode" semantics</span>
            my_arguments = <span class="hljs-built_in">Object</span>.create(MyArray);
            my_arguments[SLOT_PREFIX+<span class="hljs-string">"length"</span>] = <span class="hljs-number">0</span>;
        }
        <span class="hljs-keyword">var</span> TOP = { <span class="hljs-attr">stack</span>: [] };
        <span class="hljs-keyword">var</span> FRAME = frame;

        <span class="hljs-keyword">var</span> state = mkstate(TOP, FRAME, <span class="hljs-built_in">module</span>, func_id);
        <span class="hljs-keyword">if</span> (local_frame===<span class="hljs-literal">undefined</span>) {
            state.local_frame[SLOT_PREFIX+<span class="hljs-string">"this"</span>] = this_value;
            state.local_frame[SLOT_PREFIX+<span class="hljs-string">"arguments"</span>] = my_arguments;
        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>passing local_frame into this function should only be done
by REPL loops which deliberately want to keep a consistent
local variable state across invocations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            state.local_frame = local_frame;
        }
        <span class="hljs-keyword">while</span> (state !== TOP) {
            state = interpret(state);
        }
        <span class="hljs-keyword">return</span> TOP.stack.pop();
    };
    invoke = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">func, this_value, args</span>) </span>{
        <span class="hljs-keyword">var</span> my_arguments = <span class="hljs-built_in">Object</span>.create(MyArray);
        args.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v, i</span>) </span>{
            my_arguments[SLOT_PREFIX+i] = v;
        });
        my_arguments[SLOT_PREFIX+<span class="hljs-string">"length"</span>] = args.length;
        <span class="hljs-keyword">var</span> nframe = <span class="hljs-built_in">Object</span>.create(func.parent_frame);
        nframe[SLOT_PREFIX+<span class="hljs-string">"__proto__"</span>] = func.parent_frame;</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>go for it!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> binterp(func.module, func.func_id, nframe, this_value, my_arguments);
    };
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">__module_name__</span>: <span class="hljs-string">"binterp"</span>,
        <span class="hljs-attr">__module_init__</span>: make_binterp,
        <span class="hljs-attr">__module_deps__</span>: [<span class="hljs-string">"bytecode-table"</span>, <span class="hljs-string">"html-escape"</span>],
        <span class="hljs-attr">__module_source__</span>: binterp_source,

        <span class="hljs-attr">binterp</span>: binterp,
        <span class="hljs-attr">make_top_level_frame</span>: make_top_level_frame,
        <span class="hljs-attr">invoke</span>: invoke
    };
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
