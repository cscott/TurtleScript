<!DOCTYPE html>

<html>
<head>
  <title>text.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="asm-llvm.html">
                asm-llvm.js
              </a>
            
              
              <a class="source" href="bcompile.html">
                bcompile.js
              </a>
            
              
              <a class="source" href="binterp.html">
                binterp.js
              </a>
            
              
              <a class="source" href="browsercanvas.html">
                browsercanvas.js
              </a>
            
              
              <a class="source" href="bytecode-table.html">
                bytecode-table.js
              </a>
            
              
              <a class="source" href="canvastest.html">
                canvastest.js
              </a>
            
              
              <a class="source" href="ccanvas.html">
                ccanvas.js
              </a>
            
              
              <a class="source" href="crender-styles.html">
                crender-styles.js
              </a>
            
              
              <a class="source" href="crender.html">
                crender.js
              </a>
            
              
              <a class="source" href="ctiles.html">
                ctiles.js
              </a>
            
              
              <a class="source" href="events.html">
                events.js
              </a>
            
              
              <a class="source" href="eventtests.html">
                eventtests.js
              </a>
            
              
              <a class="source" href="extensions.html">
                extensions.js
              </a>
            
              
              <a class="source" href="global-es5.html">
                global-es5.js
              </a>
            
              
              <a class="source" href="global.html">
                global.js
              </a>
            
              
              <a class="source" href="html-escape.html">
                html-escape.js
              </a>
            
              
              <a class="source" href="jcompile.html">
                jcompile.js
              </a>
            
              
              <a class="source" href="json2.html">
                json2.js
              </a>
            
              
              <a class="source" href="nodemain.html">
                nodemain.js
              </a>
            
              
              <a class="source" href="parse.html">
                parse.js
              </a>
            
              
              <a class="source" href="render.html">
                render.js
              </a>
            
              
              <a class="source" href="render2.html">
                render2.js
              </a>
            
              
              <a class="source" href="require.html">
                require.js
              </a>
            
              
              <a class="source" href="stdlib.html">
                stdlib.js
              </a>
            
              
              <a class="source" href="str-escape.html">
                str-escape.js
              </a>
            
              
              <a class="source" href="tdop.html">
                tdop.js
              </a>
            
              
              <a class="source" href="tests.html">
                tests.js
              </a>
            
              
              <a class="source" href="text.html">
                text.js
              </a>
            
              
              <a class="source" href="tiles.html">
                tiles.js
              </a>
            
              
              <a class="source" href="tokenize.html">
                tokenize.js
              </a>
            
              
              <a class="source" href="top-level.html">
                top-level.js
              </a>
            
              
              <a class="source" href="ts.html">
                ts.js
              </a>
            
              
              <a class="source" href="write-lua-bytecode.html">
                write-lua-bytecode.js
              </a>
            
              
              <a class="source" href="write-lua-ops.html">
                write-lua-ops.js
              </a>
            
              
              <a class="source" href="write-php-bytecode.html">
                write-php-bytecode.js
              </a>
            
              
              <a class="source" href="write-php-ops.html">
                write-php-ops.js
              </a>
            
              
              <a class="source" href="write-rust-bytecode.html">
                write-rust-bytecode.js
              </a>
            
              
              <a class="source" href="write-rust-ops.html">
                write-rust-ops.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>text.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/**
 * <span class="hljs-doctag">@license </span>RequireJS text 2.0.7 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/text for details
 */</span>
<span class="hljs-comment">/*jslint regexp: true */</span>
<span class="hljs-comment">/*global require, XMLHttpRequest, ActiveXObject,
  define, window, process, Packages,
  java, location, Components, FileUtils */</span>

define([<span class="hljs-string">'module'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">module</span>) </span>{
    <span class="hljs-string">'use strict'</span>;

    <span class="hljs-keyword">var</span> text, fs, Cc, Ci,
        progIds = [<span class="hljs-string">'Msxml2.XMLHTTP'</span>, <span class="hljs-string">'Microsoft.XMLHTTP'</span>, <span class="hljs-string">'Msxml2.XMLHTTP.4.0'</span>],
        xmlRegExp = <span class="hljs-regexp">/^\s*&lt;\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?&gt;/im</span>,
        bodyRegExp = <span class="hljs-regexp">/&lt;body[^&gt;]*&gt;\s*([\s\S]+)\s*&lt;\/body&gt;/im</span>,
        hasLocation = <span class="hljs-keyword">typeof</span> location !== <span class="hljs-string">'undefined'</span> &amp;&amp; location.href,
        defaultProtocol = hasLocation &amp;&amp; location.protocol &amp;&amp; location.protocol.replace(<span class="hljs-regexp">/\:/</span>, <span class="hljs-string">''</span>),
        defaultHostName = hasLocation &amp;&amp; location.hostname,
        defaultPort = hasLocation &amp;&amp; (location.port || <span class="hljs-literal">undefined</span>),
        buildMap = {},
        masterConfig = (<span class="hljs-built_in">module</span>.config &amp;&amp; <span class="hljs-built_in">module</span>.config()) || {};

    text = {
        <span class="hljs-attr">version</span>: <span class="hljs-string">'2.0.7'</span>,

        <span class="hljs-attr">strip</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">content</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Strips <?xml ...?> declarations so that external SVG and XML
documents can be added to a document without worry. Also, if the string
is an HTML document, only the part inside the body tag is returned.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (content) {
                content = content.replace(xmlRegExp, <span class="hljs-string">""</span>);
                <span class="hljs-keyword">var</span> matches = content.match(bodyRegExp);
                <span class="hljs-keyword">if</span> (matches) {
                    content = matches[<span class="hljs-number">1</span>];
                }
            } <span class="hljs-keyword">else</span> {
                content = <span class="hljs-string">""</span>;
            }
            <span class="hljs-keyword">return</span> content;
        },

        <span class="hljs-attr">jsEscape</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">content</span>) </span>{
            <span class="hljs-keyword">return</span> content.replace(<span class="hljs-regexp">/(['\\])/g</span>, <span class="hljs-string">'\\$1'</span>)
                .replace(<span class="hljs-regexp">/[\f]/g</span>, <span class="hljs-string">"\\f"</span>)
                .replace(<span class="hljs-regexp">/[\b]/g</span>, <span class="hljs-string">"\\b"</span>)
                .replace(<span class="hljs-regexp">/[\n]/g</span>, <span class="hljs-string">"\\n"</span>)
                .replace(<span class="hljs-regexp">/[\t]/g</span>, <span class="hljs-string">"\\t"</span>)
                .replace(<span class="hljs-regexp">/[\r]/g</span>, <span class="hljs-string">"\\r"</span>)
                .replace(<span class="hljs-regexp">/[\u2028]/g</span>, <span class="hljs-string">"\\u2028"</span>)
                .replace(<span class="hljs-regexp">/[\u2029]/g</span>, <span class="hljs-string">"\\u2029"</span>);
        },

        <span class="hljs-attr">createXhr</span>: masterConfig.createXhr || <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Would love to dump the ActiveX crap in here. Need IE 6 to die first.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> xhr, i, progId;
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> XMLHttpRequest !== <span class="hljs-string">"undefined"</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> XMLHttpRequest();
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> ActiveXObject !== <span class="hljs-string">"undefined"</span>) {
                <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i += <span class="hljs-number">1</span>) {
                    progId = progIds[i];
                    <span class="hljs-keyword">try</span> {
                        xhr = <span class="hljs-keyword">new</span> ActiveXObject(progId);
                    } <span class="hljs-keyword">catch</span> (e) {}

                    <span class="hljs-keyword">if</span> (xhr) {
                        progIds = [progId];  <span class="hljs-comment">// so faster next time</span>
                        <span class="hljs-keyword">break</span>;
                    }
                }
            }

            <span class="hljs-keyword">return</span> xhr;
        },

        <span class="hljs-comment">/**
         * Parses a resource name into its component parts. Resource names
         * look like: module/name.ext!strip, where the !strip part is
         * optional.
         * <span class="hljs-doctag">@param <span class="hljs-type">{String}</span> </span>name the resource name
         * <span class="hljs-doctag">@returns <span class="hljs-type">{Object}</span> </span>with properties "moduleName", "ext" and "strip"
         * where strip is a boolean.
         */</span>
        <span class="hljs-attr">parseName</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">name</span>) </span>{
            <span class="hljs-keyword">var</span> modName, ext, temp,
                strip = <span class="hljs-literal">false</span>,
                index = name.indexOf(<span class="hljs-string">"."</span>),
                isRelative = name.indexOf(<span class="hljs-string">'./'</span>) === <span class="hljs-number">0</span> ||
                             name.indexOf(<span class="hljs-string">'../'</span>) === <span class="hljs-number">0</span>;

            <span class="hljs-keyword">if</span> (index !== <span class="hljs-number">-1</span> &amp;&amp; (!isRelative || index &gt; <span class="hljs-number">1</span>)) {
                modName = name.substring(<span class="hljs-number">0</span>, index);
                ext = name.substring(index + <span class="hljs-number">1</span>, name.length);
            } <span class="hljs-keyword">else</span> {
                modName = name;
            }

            temp = ext || modName;
            index = temp.indexOf(<span class="hljs-string">"!"</span>);
            <span class="hljs-keyword">if</span> (index !== <span class="hljs-number">-1</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Pull off the strip arg.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                strip = temp.substring(index + <span class="hljs-number">1</span>) === <span class="hljs-string">"strip"</span>;
                temp = temp.substring(<span class="hljs-number">0</span>, index);
                <span class="hljs-keyword">if</span> (ext) {
                    ext = temp;
                } <span class="hljs-keyword">else</span> {
                    modName = temp;
                }
            }

            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">moduleName</span>: modName,
                <span class="hljs-attr">ext</span>: ext,
                <span class="hljs-attr">strip</span>: strip
            };
        },

        <span class="hljs-attr">xdRegExp</span>: <span class="hljs-regexp">/^((\w+)\:)?\/\/([^\/\\]+)/</span>,

        <span class="hljs-comment">/**
         * Is an URL on another domain. Only works for browser use, returns
         * false in non-browser environments. Only used to know if an
         * optimized .js version of a text resource should be loaded
         * instead.
         * <span class="hljs-doctag">@param <span class="hljs-type">{String}</span> <span class="hljs-variable">url</span></span>
         * <span class="hljs-doctag">@returns <span class="hljs-variable">Boolean</span></span>
         */</span>
        <span class="hljs-attr">useXhr</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">url, protocol, hostname, port</span>) </span>{
            <span class="hljs-keyword">var</span> uProtocol, uHostName, uPort,
                match = text.xdRegExp.exec(url);
            <span class="hljs-keyword">if</span> (!match) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            uProtocol = match[<span class="hljs-number">2</span>];
            uHostName = match[<span class="hljs-number">3</span>];

            uHostName = uHostName.split(<span class="hljs-string">':'</span>);
            uPort = uHostName[<span class="hljs-number">1</span>];
            uHostName = uHostName[<span class="hljs-number">0</span>];

            <span class="hljs-keyword">return</span> (!uProtocol || uProtocol === protocol) &amp;&amp;
                   (!uHostName || uHostName.toLowerCase() === hostname.toLowerCase()) &amp;&amp;
                   ((!uPort &amp;&amp; !uHostName) || uPort === port);
        },

        <span class="hljs-attr">finishLoad</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">name, strip, content, onLoad</span>) </span>{
            content = strip ? text.strip(content) : content;
            <span class="hljs-keyword">if</span> (masterConfig.isBuild) {
                buildMap[name] = content;
            }
            onLoad(content);
        },

        <span class="hljs-attr">load</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">name, req, onLoad, config</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Name has format: some.module.filext!strip
The strip part is optional.
if strip is present, then that means only get the string contents
inside a body tag in an HTML string. For XML/SVG content it means
removing the <?xml ...?> declarations so the content can be inserted
into the current doc without problems.</p>
<p>Do not bother with the work if a build and text will
not be inlined.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (config.isBuild &amp;&amp; !config.inlineText) {
                onLoad();
                <span class="hljs-keyword">return</span>;
            }

            masterConfig.isBuild = config.isBuild;

            <span class="hljs-keyword">var</span> parsed = text.parseName(name),
                nonStripName = parsed.moduleName +
                    (parsed.ext ? <span class="hljs-string">'.'</span> + parsed.ext : <span class="hljs-string">''</span>),
                url = req.toUrl(nonStripName),
                useXhr = (masterConfig.useXhr) ||
                         text.useXhr;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Load the text. Use XHR if possible and in a browser.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (!hasLocation || useXhr(url, defaultProtocol, defaultHostName, defaultPort)) {
                text.get(url, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">content</span>) </span>{
                    text.finishLoad(name, parsed.strip, content, onLoad);
                }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
                    <span class="hljs-keyword">if</span> (onLoad.error) {
                        onLoad.error(err);
                    }
                });
            } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Need to fetch the resource across domains. Assume
the resource has been optimized into a JS module. Fetch
by the module name + extension, but do not include the
!strip part to avoid file system issues.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                req([nonStripName], <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">content</span>) </span>{
                    text.finishLoad(parsed.moduleName + <span class="hljs-string">'.'</span> + parsed.ext,
                                    parsed.strip, content, onLoad);
                });
            }
        },

        <span class="hljs-attr">write</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">pluginName, moduleName, write, config</span>) </span>{
            <span class="hljs-keyword">if</span> (buildMap.hasOwnProperty(moduleName)) {
                <span class="hljs-keyword">var</span> content = text.jsEscape(buildMap[moduleName]);
                write.asModule(pluginName + <span class="hljs-string">"!"</span> + moduleName,
                               <span class="hljs-string">"define(function () { return '"</span> +
                                   content +
                               <span class="hljs-string">"';});\n"</span>);
            }
        },

        <span class="hljs-attr">writeFile</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">pluginName, moduleName, req, write, config</span>) </span>{
            <span class="hljs-keyword">var</span> parsed = text.parseName(moduleName),
                extPart = parsed.ext ? <span class="hljs-string">'.'</span> + parsed.ext : <span class="hljs-string">''</span>,
                nonStripName = parsed.moduleName + extPart,</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Use a &#39;.js&#39; file name so that it indicates it is a
script that can be loaded across domains.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                fileName = req.toUrl(parsed.moduleName + extPart) + <span class="hljs-string">'.js'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Leverage own load() method to load plugin value, but only
write out values that do not have the strip argument,
to avoid any potential issues with ! in file names.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            text.load(nonStripName, req, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Use own write() method to construct full module value.
But need to create shell that translates writeFile&#39;s
write() to the right interface.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> textWrite = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">contents</span>) </span>{
                    <span class="hljs-keyword">return</span> write(fileName, contents);
                };
                textWrite.asModule = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">moduleName, contents</span>) </span>{
                    <span class="hljs-keyword">return</span> write.asModule(moduleName, fileName, contents);
                };

                text.write(pluginName, nonStripName, textWrite, config);
            }, config);
        }
    };

    <span class="hljs-keyword">if</span> (masterConfig.env === <span class="hljs-string">'node'</span> || (!masterConfig.env &amp;&amp;
            <span class="hljs-keyword">typeof</span> process !== <span class="hljs-string">"undefined"</span> &amp;&amp;
            process.versions &amp;&amp;
            !!process.versions.node)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Using special require.nodeRequire, something added by r.js.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        fs = <span class="hljs-built_in">require</span>.nodeRequire(<span class="hljs-string">'fs'</span>);

        text.get = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">url, callback, errback</span>) </span>{
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">var</span> file = fs.readFileSync(url, <span class="hljs-string">'utf8'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Remove BOM (Byte Mark Order) from utf8 files if it is there.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (file.indexOf(<span class="hljs-string">'\uFEFF'</span>) === <span class="hljs-number">0</span>) {
                    file = file.substring(<span class="hljs-number">1</span>);
                }
                callback(file);
            } <span class="hljs-keyword">catch</span> (e) {
                errback(e);
            }
        };
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (masterConfig.env === <span class="hljs-string">'xhr'</span> || (!masterConfig.env &amp;&amp;
            text.createXhr())) {
        text.get = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">url, callback, errback, headers</span>) </span>{
            <span class="hljs-keyword">var</span> xhr = text.createXhr(), header;
            xhr.open(<span class="hljs-string">'GET'</span>, url, <span class="hljs-literal">true</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Allow plugins direct access to xhr headers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (headers) {
                <span class="hljs-keyword">for</span> (header <span class="hljs-keyword">in</span> headers) {
                    <span class="hljs-keyword">if</span> (headers.hasOwnProperty(header)) {
                        xhr.setRequestHeader(header.toLowerCase(), headers[header]);
                    }
                }
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Allow overrides specified in config</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (masterConfig.onXhr) {
                masterConfig.onXhr(xhr, url);
            }

            xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) </span>{
                <span class="hljs-keyword">var</span> status, err;</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Do not explicitly handle errors, those should be
visible via console output in the browser.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (xhr.readyState === <span class="hljs-number">4</span>) {
                    status = xhr.status;
                    <span class="hljs-keyword">if</span> (status &gt; <span class="hljs-number">399</span> &amp;&amp; status &lt; <span class="hljs-number">600</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>An http 4xx or 5xx error. Signal an error.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(url + <span class="hljs-string">' HTTP status: '</span> + status);
                        err.xhr = xhr;
                        errback(err);
                    } <span class="hljs-keyword">else</span> {
                        callback(xhr.responseText);
                    }

                    <span class="hljs-keyword">if</span> (masterConfig.onXhrComplete) {
                        masterConfig.onXhrComplete(xhr, url);
                    }
                }
            };
            xhr.send(<span class="hljs-literal">null</span>);
        };
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (masterConfig.env === <span class="hljs-string">'rhino'</span> || (!masterConfig.env &amp;&amp;
            <span class="hljs-keyword">typeof</span> Packages !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> java !== <span class="hljs-string">'undefined'</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Why Java, why is this so awkward?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        text.get = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">url, callback</span>) </span>{
            <span class="hljs-keyword">var</span> stringBuffer, line,
                encoding = <span class="hljs-string">"utf-8"</span>,
                file = <span class="hljs-keyword">new</span> java.io.File(url),
                lineSeparator = java.lang.System.getProperty(<span class="hljs-string">"line.separator"</span>),
                input = <span class="hljs-keyword">new</span> java.io.BufferedReader(<span class="hljs-keyword">new</span> java.io.InputStreamReader(<span class="hljs-keyword">new</span> java.io.FileInputStream(file), encoding)),
                content = <span class="hljs-string">''</span>;
            <span class="hljs-keyword">try</span> {
                stringBuffer = <span class="hljs-keyword">new</span> java.lang.StringBuffer();
                line = input.readLine();</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Byte Order Mark (BOM) - The Unicode Standard, version 3.0, page 324
<a href="http://www.unicode.org/faq/utf_bom.html">http://www.unicode.org/faq/utf_bom.html</a></p>
<p>Note that when we use utf-8, the BOM should appear as &quot;EF BB BF&quot;, but it doesn&#39;t due to this bug in the JDK:
<a href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4508058">http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4508058</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (line &amp;&amp; line.length() &amp;&amp; line.charAt(<span class="hljs-number">0</span>) === <span class="hljs-number">0xfeff</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Eat the BOM, since we&#39;ve already found the encoding on this file,
and we plan to concatenating this buffer with others; the BOM should
only appear at the top of a file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    line = line.substring(<span class="hljs-number">1</span>);
                }

                <span class="hljs-keyword">if</span> (line !== <span class="hljs-literal">null</span>) {
                    stringBuffer.append(line);
                }

                <span class="hljs-keyword">while</span> ((line = input.readLine()) !== <span class="hljs-literal">null</span>) {
                    stringBuffer.append(lineSeparator);
                    stringBuffer.append(line);
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Make sure we return a JavaScript string and not a Java string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                content = <span class="hljs-built_in">String</span>(stringBuffer.toString()); <span class="hljs-comment">//String</span>
            } <span class="hljs-keyword">finally</span> {
                input.close();
            }
            callback(content);
        };
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (masterConfig.env === <span class="hljs-string">'xpconnect'</span> || (!masterConfig.env &amp;&amp;
            <span class="hljs-keyword">typeof</span> Components !== <span class="hljs-string">'undefined'</span> &amp;&amp; Components.classes &amp;&amp;
            Components.interfaces)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Avert your gaze!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        Cc = Components.classes,
        Ci = Components.interfaces;
        Components.utils[<span class="hljs-string">'import'</span>](<span class="hljs-string">'resource://gre/modules/FileUtils.jsm'</span>);

        text.get = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">url, callback</span>) </span>{
            <span class="hljs-keyword">var</span> inStream, convertStream,
                readData = {},
                fileObj = <span class="hljs-keyword">new</span> FileUtils.File(url);</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>XPCOM, you so crazy</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">try</span> {
                inStream = Cc[<span class="hljs-string">'@mozilla.org/network/file-input-stream;1'</span>]
                           .createInstance(Ci.nsIFileInputStream);
                inStream.init(fileObj, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);

                convertStream = Cc[<span class="hljs-string">'@mozilla.org/intl/converter-input-stream;1'</span>]
                                .createInstance(Ci.nsIConverterInputStream);
                convertStream.init(inStream, <span class="hljs-string">"utf-8"</span>, inStream.available(),
                Ci.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER);

                convertStream.readString(inStream.available(), readData);
                convertStream.close();
                inStream.close();
                callback(readData.value);
            } <span class="hljs-keyword">catch</span> (e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>((fileObj &amp;&amp; fileObj.path || <span class="hljs-string">''</span>) + <span class="hljs-string">': '</span> + e);
            }
        };
    }
    <span class="hljs-keyword">return</span> text;
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
