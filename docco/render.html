<!DOCTYPE html>

<html>
<head>
  <title>render.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="asm-llvm.html">
                asm-llvm.js
              </a>
            
              
              <a class="source" href="bcompile.html">
                bcompile.js
              </a>
            
              
              <a class="source" href="binterp.html">
                binterp.js
              </a>
            
              
              <a class="source" href="browsercanvas.html">
                browsercanvas.js
              </a>
            
              
              <a class="source" href="bytecode-table.html">
                bytecode-table.js
              </a>
            
              
              <a class="source" href="canvastest.html">
                canvastest.js
              </a>
            
              
              <a class="source" href="ccanvas.html">
                ccanvas.js
              </a>
            
              
              <a class="source" href="crender-styles.html">
                crender-styles.js
              </a>
            
              
              <a class="source" href="crender.html">
                crender.js
              </a>
            
              
              <a class="source" href="ctiles.html">
                ctiles.js
              </a>
            
              
              <a class="source" href="events.html">
                events.js
              </a>
            
              
              <a class="source" href="eventtests.html">
                eventtests.js
              </a>
            
              
              <a class="source" href="extensions.html">
                extensions.js
              </a>
            
              
              <a class="source" href="global-es5.html">
                global-es5.js
              </a>
            
              
              <a class="source" href="global.html">
                global.js
              </a>
            
              
              <a class="source" href="html-escape.html">
                html-escape.js
              </a>
            
              
              <a class="source" href="jcompile.html">
                jcompile.js
              </a>
            
              
              <a class="source" href="json2.html">
                json2.js
              </a>
            
              
              <a class="source" href="nodemain.html">
                nodemain.js
              </a>
            
              
              <a class="source" href="parse.html">
                parse.js
              </a>
            
              
              <a class="source" href="render.html">
                render.js
              </a>
            
              
              <a class="source" href="render2.html">
                render2.js
              </a>
            
              
              <a class="source" href="require.html">
                require.js
              </a>
            
              
              <a class="source" href="stdlib.html">
                stdlib.js
              </a>
            
              
              <a class="source" href="str-escape.html">
                str-escape.js
              </a>
            
              
              <a class="source" href="tdop.html">
                tdop.js
              </a>
            
              
              <a class="source" href="tests.html">
                tests.js
              </a>
            
              
              <a class="source" href="text.html">
                text.js
              </a>
            
              
              <a class="source" href="tiles.html">
                tiles.js
              </a>
            
              
              <a class="source" href="tokenize.html">
                tokenize.js
              </a>
            
              
              <a class="source" href="top-level.html">
                top-level.js
              </a>
            
              
              <a class="source" href="ts.html">
                ts.js
              </a>
            
              
              <a class="source" href="write-lua-bytecode.html">
                write-lua-bytecode.js
              </a>
            
              
              <a class="source" href="write-lua-ops.html">
                write-lua-ops.js
              </a>
            
              
              <a class="source" href="write-php-bytecode.html">
                write-php-bytecode.js
              </a>
            
              
              <a class="source" href="write-php-ops.html">
                write-php-ops.js
              </a>
            
              
              <a class="source" href="write-rust-bytecode.html">
                write-rust-bytecode.js
              </a>
            
              
              <a class="source" href="write-rust-ops.html">
                write-rust-ops.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="renderjs">render.js</h1>
<p>Create DOM element tree for parsed Simplified JavaScript.</p>
<p>Written in Simplified JavaScript, but uses jQuery methods.</p>
<p>C. Scott Ananian
2010-07-08</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>define([<span class="hljs-string">"str-escape"</span>,<span class="hljs-string">"!html-escape"</span>], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make_render</span>(<span class="hljs-params">str_escape, html_escape</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>grabs $ from global context, sigh</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> render, render_stmt, render_stmts;
    <span class="hljs-keyword">var</span> indentation, prec_stack = [ <span class="hljs-number">0</span> ];

    <span class="hljs-keyword">var</span> assert = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">b, obj</span>) </span>{
        <span class="hljs-keyword">if</span> (!b) { <span class="hljs-built_in">console</span>.assert(b, <span class="hljs-string">"Assertion failure"</span>, obj); }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>helper function for delimiter-joined lists</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> gather = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">elem, lst, f</span>) </span>{
        <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> ( i &lt; lst.length ) {
            elem.append(f(lst[i]));
            i += <span class="hljs-number">1</span>;
        }
        <span class="hljs-keyword">return</span> elem;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>set the precedence to &#39;prec&#39; when evaluating f</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> with_prec = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">prec, f, obj</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> result;
            prec_stack.push(prec);
            result = f.apply(obj || <span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
            prec_stack.pop();
            <span class="hljs-keyword">return</span> result;
        };
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>set the precedence, and parenthesize the result if appropriate.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> with_prec_paren = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">prec, f, obj</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> prev_prec = prec_stack[prec_stack.length - <span class="hljs-number">1</span>];
            <span class="hljs-keyword">var</span> result = with_prec(prec, f).apply(obj || <span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>if (prev_prec &gt; prec) { result = &quot;(&quot; + result + &quot;)&quot;; }</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> result;
        };
    };

    <span class="hljs-keyword">var</span> semi = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;span class='semi'&gt;;&lt;/span&gt;"</span>);
    };

    <span class="hljs-keyword">var</span> dispatch = {};
    dispatch.name = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;li class='name'&gt;"</span>+html_escape(<span class="hljs-keyword">this</span>.value)+<span class="hljs-string">"&lt;/li&gt;"</span>);
    };
    dispatch.literal = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.value === <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;li class='literal'&gt;null&lt;/li&gt;"</span>);
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">this</span>.value)===<span class="hljs-string">'object'</span>) {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.value.length === <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;li class='literal'&gt;Array&lt;/li&gt;"</span>);
            }
            <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;li class='literal'&gt;Object&lt;/li&gt;"</span>);
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">this</span>.value)===<span class="hljs-string">'string'</span>) {
            <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;li class='literal'&gt;"</span> +
                     html_escape(str_escape(<span class="hljs-keyword">this</span>.value)) +
                     <span class="hljs-string">"&lt;/li&gt;"</span>);
        }
        <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;li class='literal'&gt;"</span> +
                 html_escape(<span class="hljs-keyword">this</span>.value.toString()) +
                 <span class="hljs-string">"&lt;/li&gt;"</span>);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>UNARY ASTs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch.unary = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        assert(dispatch.unary[<span class="hljs-keyword">this</span>.value], <span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> dispatch.unary[<span class="hljs-keyword">this</span>.value].apply(<span class="hljs-keyword">this</span>);
    };
    <span class="hljs-keyword">var</span> unary = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">op, prec, f</span>) </span>{
        dispatch.unary[op] = f || with_prec_paren(prec, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;li class='unop'&gt;&lt;span class='op'&gt;"</span> +
                         html_escape(<span class="hljs-keyword">this</span>.value) +
                         <span class="hljs-string">"&lt;/span&gt;&lt;/li&gt;"</span>).
                    append($(<span class="hljs-string">"&lt;ul class='expr'&gt;&lt;/ul&gt;"</span>).
                           append(render(<span class="hljs-keyword">this</span>.first)));
            });
    };
    unary(<span class="hljs-string">'!'</span>, <span class="hljs-number">70</span>);
    unary(<span class="hljs-string">'-'</span>, <span class="hljs-number">70</span>);
    unary(<span class="hljs-string">'typeof'</span>, <span class="hljs-number">70</span>, with_prec_paren(<span class="hljs-number">70</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;li class='unop'&gt;&lt;span class='op'&gt;typeof"</span> +
                         <span class="hljs-string">"&lt;/span&gt;&lt;/li&gt;"</span>).
                    append($(<span class="hljs-string">"&lt;ul class='expr'&gt;&lt;/ul&gt;"</span>).
                           append(with_prec(<span class="hljs-number">0</span>, render)(<span class="hljs-keyword">this</span>.first)));
            }));
    unary(<span class="hljs-string">'['</span>, <span class="hljs-number">90</span><span class="hljs-comment">/*???*/</span>, with_prec_paren(<span class="hljs-number">90</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;li class='unop'&gt;&lt;span class='op'&gt;new array&lt;/span&gt;&lt;/li&gt;"</span>).
                    append(gather($(<span class="hljs-string">"&lt;ul&gt;&lt;/ul&gt;"</span>), <span class="hljs-keyword">this</span>.first,
                                  with_prec(<span class="hljs-number">0</span>, render)));
            }));
    unary(<span class="hljs-string">'{'</span>, <span class="hljs-number">90</span><span class="hljs-comment">/*???*/</span>, with_prec_paren(<span class="hljs-number">90</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>new object creation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;li class='unop'&gt;&lt;span class='op'&gt;new object&lt;/span&gt;&lt;/li&gt;"</span>).
                    append(gather($(<span class="hljs-string">"&lt;dl&gt;&lt;/dl&gt;"</span>), <span class="hljs-keyword">this</span>.first, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">item</span>) </span>{
                                <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;dt&gt;&lt;span class='name'&gt;"</span> +</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>XXX not editable?
XXX suppress quotes when unnecessary</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                         html_escape(str_escape(item.key)) +
                                         <span class="hljs-string">"&lt;/span&gt;:&lt;/dt&gt;"</span>).
                                    append($(<span class="hljs-string">"&lt;dd&gt;&lt;/dd&gt;"</span>).
                                           append($(<span class="hljs-string">"&lt;ul&gt;&lt;/ul&gt;"</span>).
                                                  append(with_prec(<span class="hljs-number">0</span>, render)
                                                         (item))));
                            }));
            }));</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Binary ASTs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch.binary = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        assert(dispatch.binary[<span class="hljs-keyword">this</span>.value], <span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> dispatch.binary[<span class="hljs-keyword">this</span>.value].apply(<span class="hljs-keyword">this</span>);
    };
    <span class="hljs-keyword">var</span> binary = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">op, prec, f</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>with_prec_paren will add parentheses if necessary</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        dispatch.binary[op] = f || with_prec_paren(prec, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;li class='binop'&gt;&lt;/li&gt;"</span>).
                append($(<span class="hljs-string">"&lt;ul class='expr'&gt;&lt;/ul&gt;"</span>).
                       append(render(<span class="hljs-keyword">this</span>.first))).
                append($(<span class="hljs-string">"&lt;span class='op'&gt;"</span> +
                         html_escape(<span class="hljs-keyword">this</span>.value) +
                         <span class="hljs-string">"&lt;/span&gt;"</span>)).</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>handle left associativity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                append($(<span class="hljs-string">"&lt;ul class='expr'&gt;&lt;/ul&gt;"</span>).
                       append(with_prec(prec+<span class="hljs-number">1</span>, render)(<span class="hljs-keyword">this</span>.second)));
            });
    };
    binary(<span class="hljs-string">'='</span>, <span class="hljs-number">10</span>);
    binary(<span class="hljs-string">'+='</span>, <span class="hljs-number">10</span>);
    binary(<span class="hljs-string">'-='</span>, <span class="hljs-number">10</span>);
    binary(<span class="hljs-string">'||'</span>, <span class="hljs-number">30</span>);
    binary(<span class="hljs-string">'&amp;&amp;'</span>, <span class="hljs-number">35</span>);
    binary(<span class="hljs-string">'==='</span>,<span class="hljs-number">40</span>);
    binary(<span class="hljs-string">'!=='</span>,<span class="hljs-number">40</span>);
    binary(<span class="hljs-string">'&lt;'</span>, <span class="hljs-number">45</span>);
    binary(<span class="hljs-string">'&lt;='</span>,<span class="hljs-number">45</span>);
    binary(<span class="hljs-string">'&gt;'</span>, <span class="hljs-number">45</span>);
    binary(<span class="hljs-string">'&gt;='</span>,<span class="hljs-number">45</span>);
    binary(<span class="hljs-string">'+'</span>, <span class="hljs-number">50</span>);
    binary(<span class="hljs-string">'-'</span>, <span class="hljs-number">50</span>);
    binary(<span class="hljs-string">'*'</span>, <span class="hljs-number">60</span>);
    binary(<span class="hljs-string">'/'</span>, <span class="hljs-number">60</span>);
    binary(<span class="hljs-string">"."</span>, <span class="hljs-number">80</span>, with_prec_paren(<span class="hljs-number">80</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                assert (<span class="hljs-keyword">this</span>.second.arity===<span class="hljs-string">'literal'</span>, <span class="hljs-keyword">this</span>.second);
                <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;li class='binop'&gt;&lt;/li&gt;"</span>).
                    append($(<span class="hljs-string">"&lt;ul class='expr'&gt;&lt;/ul&gt;"</span>).
                           append(render(<span class="hljs-keyword">this</span>.first))).
                    append($(<span class="hljs-string">"&lt;span class='op'&gt;.&lt;/span&gt;"</span>)).</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>XXX doesn&#39;t allow field name to be edited</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    append($(<span class="hljs-string">"&lt;span class='field'&gt;&lt;/span&gt;"</span>).
                           append(html_escape(<span class="hljs-keyword">this</span>.second.value)));
            }));
    binary(<span class="hljs-string">'['</span>, <span class="hljs-number">80</span>, with_prec_paren(<span class="hljs-number">80</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;li class='binop'&gt;&lt;/li&gt;"</span>).
                    append($(<span class="hljs-string">"&lt;ul class='expr'&gt;&lt;/ul&gt;"</span>).
                           append(render(<span class="hljs-keyword">this</span>.first))).
                    append($(<span class="hljs-string">"&lt;span class='op'&gt;[&lt;/span&gt;"</span>)).
                    append($(<span class="hljs-string">"&lt;ul class='expr'&gt;&lt;/ul&gt;"</span>).
                           append(with_prec(<span class="hljs-number">0</span>, render)(<span class="hljs-keyword">this</span>.second))).
                    append($(<span class="hljs-string">"&lt;span class='op'&gt;]&lt;/span&gt;"</span>));
            }));
    binary(<span class="hljs-string">'('</span>, <span class="hljs-number">80</span>, with_prec_paren(<span class="hljs-number">80</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>simple method invocation (doesn&#39;t set &#39;this&#39;)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;li class='binop'&gt;&lt;/li&gt;"</span>).
                    append($(<span class="hljs-string">"&lt;ul class='expr'&gt;&lt;/ul&gt;"</span>).
                           append(render(<span class="hljs-keyword">this</span>.first))).
                    append($(<span class="hljs-string">"&lt;span class='op'&gt;(&lt;/span&gt;"</span>)).
                    append(gather($(<span class="hljs-string">"&lt;ul class='arguments'&gt;&lt;/ul&gt;"</span>),
                                  <span class="hljs-keyword">this</span>.second, with_prec(<span class="hljs-number">0</span>, render))).
                    append($(<span class="hljs-string">"&lt;span class='op'&gt;)&lt;/span&gt;"</span>));
            }));</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Ternary ASTs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch.ternary = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        assert (dispatch.ternary[<span class="hljs-keyword">this</span>.value], <span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> dispatch.ternary[<span class="hljs-keyword">this</span>.value].apply(<span class="hljs-keyword">this</span>);
    };
    <span class="hljs-keyword">var</span> ternary = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">op, prec, f</span>) </span>{
        dispatch.ternary[op] = with_prec_paren(prec, f);
    };
    ternary(<span class="hljs-string">"?"</span>, <span class="hljs-number">20</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;li class='ternary'&gt;&lt;/li&gt;"</span>).
                append($(<span class="hljs-string">"&lt;ul class='expr'&gt;&lt;/ul&gt;"</span>).
                       append(render(<span class="hljs-keyword">this</span>.first))).
                append($(<span class="hljs-string">"&lt;span class='op'&gt;?&lt;/span&gt;"</span>)).
                append($(<span class="hljs-string">"&lt;ul class='expr'&gt;&lt;/ul&gt;"</span>).
                       append(render(<span class="hljs-keyword">this</span>.second))).
                append($(<span class="hljs-string">"&lt;span class='op'&gt;:&lt;/span&gt;"</span>)).
                append($(<span class="hljs-string">"&lt;ul class='expr'&gt;&lt;/ul&gt;"</span>).
                       append(render(<span class="hljs-keyword">this</span>.third)));
        });
    ternary(<span class="hljs-string">"("</span>, <span class="hljs-number">80</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>precedence is 80, same as . and &#39;(&#39;)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            assert (<span class="hljs-keyword">this</span>.second.arity===<span class="hljs-string">'literal'</span>, <span class="hljs-keyword">this</span>.second);
            <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;li class='ternary'&gt;&lt;/li&gt;"</span>).
                append($(<span class="hljs-string">"&lt;ul class='expr'&gt;&lt;/ul&gt;"</span>).
                       append(render(<span class="hljs-keyword">this</span>.first))).
                append($(<span class="hljs-string">"&lt;span class='op'&gt;.&lt;/span&gt;"</span>)).</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>XXX doesn&#39;t allow field name to be edited</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                append($(<span class="hljs-string">"&lt;span class='field'&gt;&lt;/span&gt;"</span>).
                       append(html_escape(<span class="hljs-keyword">this</span>.second.value))).
                append($(<span class="hljs-string">"&lt;span class='op'&gt;(&lt;/span&gt;"</span>)).
                append(gather($(<span class="hljs-string">"&lt;ul class='arguments'&gt;&lt;/ul&gt;"</span>),
                              <span class="hljs-keyword">this</span>.third, with_prec(<span class="hljs-number">0</span>, render))).
                append($(<span class="hljs-string">"&lt;span class='op'&gt;)&lt;/span&gt;"</span>));
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Statements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch.statement = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        assert(dispatch.statement[<span class="hljs-keyword">this</span>.value], <span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> dispatch.statement[<span class="hljs-keyword">this</span>.value].apply(<span class="hljs-keyword">this</span>);
    };
    <span class="hljs-keyword">var</span> stmt = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value, f</span>) </span>{
        dispatch.statement[value] = f;
    };
    <span class="hljs-keyword">var</span> collect_variables = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">block</span>) </span>{
        <span class="hljs-keyword">var</span> v = [], s = [], i = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> ( i &lt; block.first.length ) {
            <span class="hljs-keyword">if</span> (block.first[i].value === <span class="hljs-string">'var'</span>) {
                v.push(block.first[i].first);
            } <span class="hljs-keyword">else</span> {
                s.push(block.first[i]);
            }
            i += <span class="hljs-number">1</span>;
        }
        <span class="hljs-keyword">var</span> classes=<span class="hljs-string">'variables'</span>;
        <span class="hljs-keyword">var</span> vlist = $(<span class="hljs-string">"&lt;ul class='variables'&gt;&lt;/ul&gt;"</span>);
        <span class="hljs-keyword">if</span> (v.length === <span class="hljs-number">0</span>) {
            vlist.append($(<span class="hljs-string">"&lt;li class='placeholder'&gt;&lt;/li&gt;"</span>));
            classes += <span class="hljs-string">' empty'</span>;
        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>sort list of variables</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            v.sort(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) </span>{
                    <span class="hljs-keyword">return</span> (a.value &lt; b.value) ? <span class="hljs-number">-1</span> :
                           (a.value &gt; b.value) ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;
                });
            gather(vlist, v, render);
        }
        <span class="hljs-keyword">return</span> [ $(<span class="hljs-string">"&lt;div class='"</span>+classes+<span class="hljs-string">"'&gt;var&amp;nbsp;&lt;/div&gt;"</span>).
                 append(vlist).append(semi()), s ];
    };
    <span class="hljs-keyword">var</span> block = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">block</span>) </span>{
        <span class="hljs-keyword">var</span> pieces = collect_variables(block);
        <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;div class='block'&gt;&lt;/div&gt;"</span>).
                append(pieces[<span class="hljs-number">0</span>]).
                append(render_stmts(pieces[<span class="hljs-number">1</span>]));
    };
    stmt(<span class="hljs-string">"block"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>inline block (statement)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;li class='stmt'&gt;&lt;/li&gt;"</span>).
                append(<span class="hljs-string">"{"</span>).
                append(block(<span class="hljs-keyword">this</span>)).
                append(<span class="hljs-string">"}"</span>);
        });
    stmt(<span class="hljs-string">"var"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;li class='stmt'&gt;var &lt;/li&gt;"</span>).
                append($(<span class="hljs-string">"&lt;ul class='variables'&gt;&lt;/ul&gt;"</span>).
                       append(render(<span class="hljs-keyword">this</span>.first))).
                append(semi());
        });
    stmt(<span class="hljs-string">"if"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> result = $(<span class="hljs-string">"&lt;li class='stmt'&gt;&lt;/li&gt;"</span>).
                append($(<span class="hljs-string">"&lt;div class='header'&gt;if (&lt;/div&gt;"</span>).
                       append($(<span class="hljs-string">"&lt;ul class='expr'&gt;&lt;/ul&gt;"</span>).
                              append(render(<span class="hljs-keyword">this</span>.first))).
                       append(<span class="hljs-string">") {"</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>this.second.value === block</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            result.append(block(<span class="hljs-keyword">this</span>.second));
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.third) {
                result.append($(<span class="hljs-string">"&lt;div&gt;} else {&lt;/div&gt;"</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>XXX this doesn&#39;t allow us to add an else clause if missing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                result.append(block(<span class="hljs-keyword">this</span>.third));
            }
            result.append($(<span class="hljs-string">"&lt;div class='footer'&gt;}&lt;/div&gt;"</span>));
            <span class="hljs-keyword">return</span> result;
        });
    stmt(<span class="hljs-string">"return"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> result = $(<span class="hljs-string">"&lt;li class='stmt'&gt;return &lt;/li&gt;"</span>);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.first) {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>XXX doesn&#39;t let us append a return value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                result.append($(<span class="hljs-string">"&lt;ul class='expr'&gt;&lt;/ul&gt;"</span>).
                              append(render(<span class="hljs-keyword">this</span>.first)));
            } <span class="hljs-keyword">else</span> {
                result.append($(<span class="hljs-string">"&lt;ul class='expr'&gt;&lt;/ul&gt;"</span>));
            }
            result.append(semi());
            <span class="hljs-keyword">return</span> result;
        });
    stmt(<span class="hljs-string">"break"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;li class='stmt'&gt;break&lt;/li&gt;"</span>).append(semi());
        });
    stmt(<span class="hljs-string">"while"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> result = $(<span class="hljs-string">"&lt;li class='stmt'&gt;&lt;/li&gt;"</span>).
                append($(<span class="hljs-string">"&lt;div class='header'&gt;while (&lt;/div&gt;"</span>).
                       append($(<span class="hljs-string">"&lt;ul class='expr'&gt;&lt;/ul&gt;"</span>).
                              append(render(<span class="hljs-keyword">this</span>.first))).
                       append(<span class="hljs-string">") {"</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>this.second.value === block</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            result.append(block(<span class="hljs-keyword">this</span>.second));
            result.append($(<span class="hljs-string">"&lt;div class='footer'&gt;}&lt;/div&gt;"</span>));
            <span class="hljs-keyword">return</span> result;
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Odd cases</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch[<span class="hljs-string">'this'</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-comment">// literal</span>
        <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;li class='literal'&gt;this&lt;/li&gt;"</span>);
    };
    dispatch[<span class="hljs-string">'function'</span>] = with_prec(<span class="hljs-number">0</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> name = $(<span class="hljs-string">"&lt;span class='name'&gt;&lt;/span&gt;"</span>);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.name) { name.append(html_escape(<span class="hljs-keyword">this</span>.name)); }
            <span class="hljs-keyword">var</span> result = $(<span class="hljs-string">"&lt;li class='function'&gt;&lt;/li&gt;"</span>).
                append($(<span class="hljs-string">"&lt;div class='header'&gt;function &lt;/div&gt;"</span>).
                       append(name).append(<span class="hljs-string">"("</span>).
                       append(gather($(<span class="hljs-string">"&lt;ul class='arguments'&gt;&lt;/ul&gt;"</span>),
                                     <span class="hljs-keyword">this</span>.first, render)).
                       append(<span class="hljs-string">") {"</span>)).
                append(block({ <span class="hljs-attr">value</span>: <span class="hljs-string">'block'</span>,
                               <span class="hljs-attr">arity</span>: <span class="hljs-string">'statement'</span>,
                               <span class="hljs-attr">first</span>: <span class="hljs-keyword">this</span>.second })).
                append($(<span class="hljs-string">"&lt;div class='footer'&gt;}&lt;/div&gt;"</span>));
            <span class="hljs-keyword">return</span> result;
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Helpers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    render = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tree</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>make &#39;this&#39; the parse tree in the dispatched function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        assert(dispatch[tree.arity], tree);
        <span class="hljs-keyword">return</span> dispatch[tree.arity].apply(tree);
    };
    render_stmt = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tree</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>handle &#39;expression statements&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (tree.arity===<span class="hljs-string">'statement'</span>) { <span class="hljs-keyword">return</span> render(tree); }</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>handle &#39;expression statements&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> $(<span class="hljs-string">"&lt;li class='stmt'&gt;&lt;/li&gt;"</span>).
            append($(<span class="hljs-string">"&lt;ul class='expr fixed'&gt;&lt;/ul&gt;"</span>).append(render(tree))).
            append(semi());
    };
    render_stmts = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tree_list</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>returns a <ul></ul> element containing all the statements.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> gather($(<span class="hljs-string">"&lt;ul&gt;&lt;/ul&gt;"</span>), tree_list, render_stmt);
    };

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">parse_tree</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>parse_tree should be an array of statements.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        indentation = <span class="hljs-number">0</span>;
        prec_stack = [ <span class="hljs-number">0</span> ];
        <span class="hljs-keyword">return</span> render_stmts(parse_tree);
    };
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
