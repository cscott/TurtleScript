<!DOCTYPE html>

<html>
<head>
  <title>write-lua-bytecode.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="asm-llvm.html">
                asm-llvm.js
              </a>
            
              
              <a class="source" href="bcompile.html">
                bcompile.js
              </a>
            
              
              <a class="source" href="binterp.html">
                binterp.js
              </a>
            
              
              <a class="source" href="browsercanvas.html">
                browsercanvas.js
              </a>
            
              
              <a class="source" href="bytecode-table.html">
                bytecode-table.js
              </a>
            
              
              <a class="source" href="canvastest.html">
                canvastest.js
              </a>
            
              
              <a class="source" href="ccanvas.html">
                ccanvas.js
              </a>
            
              
              <a class="source" href="crender-styles.html">
                crender-styles.js
              </a>
            
              
              <a class="source" href="crender.html">
                crender.js
              </a>
            
              
              <a class="source" href="ctiles.html">
                ctiles.js
              </a>
            
              
              <a class="source" href="events.html">
                events.js
              </a>
            
              
              <a class="source" href="eventtests.html">
                eventtests.js
              </a>
            
              
              <a class="source" href="extensions.html">
                extensions.js
              </a>
            
              
              <a class="source" href="global-es5.html">
                global-es5.js
              </a>
            
              
              <a class="source" href="global.html">
                global.js
              </a>
            
              
              <a class="source" href="html-escape.html">
                html-escape.js
              </a>
            
              
              <a class="source" href="jcompile.html">
                jcompile.js
              </a>
            
              
              <a class="source" href="json2.html">
                json2.js
              </a>
            
              
              <a class="source" href="nodemain.html">
                nodemain.js
              </a>
            
              
              <a class="source" href="parse.html">
                parse.js
              </a>
            
              
              <a class="source" href="render.html">
                render.js
              </a>
            
              
              <a class="source" href="render2.html">
                render2.js
              </a>
            
              
              <a class="source" href="require.html">
                require.js
              </a>
            
              
              <a class="source" href="stdlib.html">
                stdlib.js
              </a>
            
              
              <a class="source" href="str-escape.html">
                str-escape.js
              </a>
            
              
              <a class="source" href="tdop.html">
                tdop.js
              </a>
            
              
              <a class="source" href="tests.html">
                tests.js
              </a>
            
              
              <a class="source" href="text.html">
                text.js
              </a>
            
              
              <a class="source" href="tiles.html">
                tiles.js
              </a>
            
              
              <a class="source" href="tokenize.html">
                tokenize.js
              </a>
            
              
              <a class="source" href="top-level.html">
                top-level.js
              </a>
            
              
              <a class="source" href="ts.html">
                ts.js
              </a>
            
              
              <a class="source" href="write-lua-bytecode.html">
                write-lua-bytecode.js
              </a>
            
              
              <a class="source" href="write-lua-ops.html">
                write-lua-ops.js
              </a>
            
              
              <a class="source" href="write-php-bytecode.html">
                write-php-bytecode.js
              </a>
            
              
              <a class="source" href="write-php-ops.html">
                write-php-ops.js
              </a>
            
              
              <a class="source" href="write-rust-bytecode.html">
                write-rust-bytecode.js
              </a>
            
              
              <a class="source" href="write-rust-ops.html">
                write-rust-ops.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>write-lua-bytecode.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Utility to write bytecode for TurtleScript parser, bytecode compiler,
startup code and standard library, as a Lua file.</p>
<p>Run it under <code>node</code> with the CLI in <code>bin/write-lua-bytecode.js</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>define([<span class="hljs-string">'./parse'</span>, <span class="hljs-string">'./bcompile'</span>, <span class="hljs-string">'./bytecode-table'</span>, <span class="hljs-string">'./top-level'</span>, <span class="hljs-string">'./str-escape'</span>, <span class="hljs-string">'./tests'</span>, <span class="hljs-string">'./stdlib'</span>, <span class="hljs-string">'./extensions'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">parse, bcompile, bytecode_table, top_level, str_escape, tests, stdlib</span>) </span>{
    <span class="hljs-keyword">var</span> fake_require =
        <span class="hljs-string">"var __modules__ = {};\n"</span>+
        <span class="hljs-string">"define = function _define(name, deps, init_func) {\n"</span>+
        <span class="hljs-string">"  var d = deps.map(function(m) { return __modules__[m]; });\n"</span>+
        <span class="hljs-string">"  __modules__[name] = init_func.apply(this, d);\n"</span>+
        <span class="hljs-string">"};\n"</span>;
    <span class="hljs-keyword">var</span> make_compile_from_source = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">parse, bcompile, TOP_LEVEL</span>) </span>{
       <span class="hljs-keyword">var</span> compile_from_source = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">source, as_object</span>) </span>{
           source = source || <span class="hljs-string">'{ return 1+2; }'</span>;
           <span class="hljs-keyword">var</span> tree = parse(source, TOP_LEVEL);
           <span class="hljs-keyword">var</span> bc = bcompile(tree, <span class="hljs-literal">true</span><span class="hljs-comment">/*don't desugar frame get*/</span>);
           <span class="hljs-keyword">var</span> result = as_object ? bc : bc.encode();
           <span class="hljs-keyword">return</span> result;
       };
       compile_from_source.make_repl = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
           <span class="hljs-keyword">var</span> state = <span class="hljs-literal">null</span>;
           <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">source</span>) </span>{
               <span class="hljs-keyword">var</span> rv = parse.repl(state, source, TOP_LEVEL);
               state = rv.state;
               <span class="hljs-keyword">return</span> bcompile(rv.tree).encode();
           };
       };
       <span class="hljs-keyword">return</span> compile_from_source;
    };
    <span class="hljs-keyword">var</span> cfs_source = make_compile_from_source.toSource ?
        make_compile_from_source.toSource() :
        make_compile_from_source.toString();
    cfs_source = <span class="hljs-string">'define("compile_from_source", ["parse","bcompile","top-level"], '</span>+
        cfs_source + <span class="hljs-string">');'</span>;
    <span class="hljs-keyword">var</span> top_level_source = <span class="hljs-string">'define("top-level", [], function() { return '</span> +
        str_escape(top_level) + <span class="hljs-string">'; });'</span>;
    <span class="hljs-keyword">var</span> source = <span class="hljs-string">'{\n'</span>+
        stdlib.source()+<span class="hljs-string">'\n'</span>+
        fake_require +
        tests.lookup(<span class="hljs-string">"tokenize"</span>)+<span class="hljs-string">"\n"</span>+
        tests.lookup(<span class="hljs-string">"parse"</span>)+<span class="hljs-string">"\n"</span>+
        tests.lookup(<span class="hljs-string">"bytecode-table"</span>)+<span class="hljs-string">"\n"</span>+
        tests.lookup(<span class="hljs-string">"bcompile"</span>)+<span class="hljs-string">"\n"</span>+
        top_level_source+<span class="hljs-string">"\n"</span>+
        cfs_source + <span class="hljs-string">'\n'</span> +
        <span class="hljs-comment">/*
        "var test_nan = function() { return NaN; };\n" +
        "var test_inf = function() { return Infinity; };\n" +
        "var test_neg_inf = function() { return -Infinity; };\n" +
        */</span>
        <span class="hljs-string">"return __modules__['compile_from_source']; }\n"</span>;

    <span class="hljs-comment">/* XXX Hacks for initial tests:
    source = "{ console.log('Hello,', 'world!'); }";
    source = "{ var fib=function(n){return (n&lt;2)?1:fib(n-1)+fib(n-2);}; return fib(10); }";
    source = '{ return 1+2; }';
    source = "{ return 0+'x'; }";
    */</span>

    <span class="hljs-keyword">var</span> compile_from_source = make_compile_from_source(parse, bcompile, top_level);
    <span class="hljs-keyword">var</span> bc = compile_from_source(source, <span class="hljs-literal">true</span><span class="hljs-comment">/*as object*/</span>);

    <span class="hljs-keyword">var</span> lua_esc = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">str</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Escape string for PHP -- note UTF-16 to UTF-8 conversion.
XXX this isn&#39;t turtlescript...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> re = <span class="hljs-regexp">/[\uD800-\uDBFF][\uDC00-\uDFFF]|[^A-Za-z0-9_ !#-\/:-@\[\]^`{|}~]/g</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-string">'"'</span> + str.replace(re, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>{
            <span class="hljs-keyword">var</span> code = c.charCodeAt(<span class="hljs-number">0</span>);
            <span class="hljs-keyword">if</span> (c.length===<span class="hljs-number">2</span>) {
                <span class="hljs-keyword">var</span> next = c.charCodeAt(<span class="hljs-number">1</span>);
                code = ((code - <span class="hljs-number">0xD800</span>) * <span class="hljs-number">0x400</span>) +
                    (next - <span class="hljs-number">0xDC00</span>) + <span class="hljs-number">0x10000</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Convert code to UTF-8</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> esc = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">d</span>) </span>{
                <span class="hljs-keyword">var</span> s = d.toString(<span class="hljs-number">10</span>);
                <span class="hljs-keyword">while</span> (s.length &lt; <span class="hljs-number">3</span>) { s = <span class="hljs-string">'0'</span> + s; }
                <span class="hljs-keyword">return</span> <span class="hljs-string">"\\"</span> + s;
            };
            <span class="hljs-keyword">if</span> (code &lt; <span class="hljs-number">0x80</span>) {
                <span class="hljs-keyword">return</span> esc(code);
            }
            <span class="hljs-keyword">var</span> prefix, s=<span class="hljs-string">''</span>, repeat;
            <span class="hljs-keyword">if</span> (code &lt; <span class="hljs-number">0x800</span>) {
                prefix = esc(<span class="hljs-number">0xC0</span> | (code &gt;&gt;&gt; <span class="hljs-number">6</span>));
                repeat = <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (code &lt; <span class="hljs-number">0x10000</span>) {
                prefix = esc(<span class="hljs-number">0xE0</span> | (code &gt;&gt;&gt; <span class="hljs-number">12</span>));
                repeat = <span class="hljs-number">2</span>;
            } <span class="hljs-keyword">else</span> {
                prefix = esc(<span class="hljs-number">0xF0</span> | (code &gt;&gt;&gt; <span class="hljs-number">18</span>));
                repeat = <span class="hljs-number">3</span>;
            }
            <span class="hljs-keyword">while</span> (repeat &gt; <span class="hljs-number">0</span>) {
                s = esc(<span class="hljs-number">0x80</span> | (code &amp; <span class="hljs-number">0x3F</span>)) + s;
                code = code &gt;&gt;&gt; <span class="hljs-number">6</span>;
                repeat--;
            }
            <span class="hljs-keyword">return</span> prefix + s;
        }) + <span class="hljs-string">'"'</span>;
    };

    <span class="hljs-keyword">var</span> pad = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">s, width</span>) </span>{
        <span class="hljs-keyword">if</span> (width===<span class="hljs-literal">undefined</span>) { width = <span class="hljs-number">10</span>; }
        <span class="hljs-keyword">while</span> (s.length &lt; width) { s += <span class="hljs-string">' '</span>; }
        <span class="hljs-keyword">return</span> s;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="output-module-functions">Output module functions.</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'-- generated by TurtleScript write-lua-bytecode.js'</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'local jsval = require("luaturtle.jsval")'</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'local ifunc = require("luaturtle.ifunc")'</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">''</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'local startup = {}'</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">''</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'-- Populate the function and literal arrays with the precompiled'</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'-- startup code, including the compiler and standard library.'</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">''</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'startup.functions = {'</span>);
    <span class="hljs-keyword">var</span> mkComma = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">len</span>) </span>{
        len--;
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">i</span>) </span>{ <span class="hljs-keyword">return</span> (i &lt; len) ? <span class="hljs-string">','</span> : <span class="hljs-string">''</span>; };
    };
    <span class="hljs-keyword">var</span> comma = mkComma(bc.functions.length);
    bc.functions.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">f, i</span>) </span>{
        <span class="hljs-keyword">var</span> name = f.name ? (<span class="hljs-string">' -- '</span>+<span class="hljs-built_in">JSON</span>.stringify(f.name)) : <span class="hljs-string">''</span>;
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'  ifunc.Function:new{'</span> + name);
        name = f.name ? (<span class="hljs-string">'jsval.newString('</span> + lua_esc(f.name) + <span class="hljs-string">')'</span>) : <span class="hljs-string">'jsval.Undefined'</span>;
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'    name = '</span> + name + <span class="hljs-string">','</span>);
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'    id = '</span> + f.id + <span class="hljs-string">','</span>);
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'    nargs = '</span> + f.nargs + <span class="hljs-string">','</span>);
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'    max_stack = '</span> + f.max_stack + <span class="hljs-string">','</span>);
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'    bytecode = {'</span>);
        <span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> (j &lt; f.bytecode.length) {
            <span class="hljs-keyword">var</span> pc = j;
            <span class="hljs-keyword">var</span> bc = bytecode_table.for_num(f.bytecode[j]);
            <span class="hljs-keyword">var</span> a = f.bytecode.slice(j, j+=bc.args+<span class="hljs-number">1</span>);
            a = a.map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">b</span>) </span>{
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(b) !== <span class="hljs-string">'number'</span>) { b = b.label; }
                <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>+b;
            });
            <span class="hljs-keyword">var</span> b = a.slice(<span class="hljs-number">1</span>);
            a = a.join(<span class="hljs-string">', '</span>) + ((j &lt; f.bytecode.length) ? <span class="hljs-string">','</span> : <span class="hljs-string">''</span>);
            b = bc.name + ( b.length ? ( <span class="hljs-string">'('</span> + b.join(<span class="hljs-string">','</span>) + <span class="hljs-string">')'</span> ) : <span class="hljs-string">''</span> );
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'      '</span> + pad(a) + <span class="hljs-string">'-- '</span> + pc + <span class="hljs-string">': '</span> + b);
        }
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'    }'</span>);
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'  }'</span> + comma(i));
    });
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'}'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="output-module-literals">Output module literals.</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'-- literals'</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'startup.literals = {'</span>);
    comma = mkComma(bc.literals.length);
    bc.literals.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">lv, i</span>) </span>{
        <span class="hljs-keyword">var</span> str;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(lv) === <span class="hljs-string">"number"</span> ) {
            str = lv.toString();
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(lv)) { str = <span class="hljs-string">'0/0'</span>; }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isFinite</span>(lv)) { str = lv &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">'1/0'</span> : <span class="hljs-string">'-1/0'</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>special case for -0, from
<a href="https://luaunit.readthedocs.io/en/latest/#scientific-computing-and-luaunit">https://luaunit.readthedocs.io/en/latest/#scientific-computing-and-luaunit</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (lv === <span class="hljs-number">0</span> &amp;&amp; (<span class="hljs-number">1</span>/lv)===-<span class="hljs-literal">Infinity</span>) { str = <span class="hljs-string">'-1/(1/0)'</span>; }
            str = <span class="hljs-string">'jsval.newNumber('</span> + str + <span class="hljs-string">')'</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(lv) === <span class="hljs-string">"string"</span>) {
            str = lua_esc(lv); <span class="hljs-comment">// Note: UTF8!</span>
            str = <span class="hljs-string">'jsval.newString('</span> + str + <span class="hljs-string">')'</span>; <span class="hljs-comment">// convert to UTF16</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(lv) === <span class="hljs-string">"boolean"</span>) {
            str = <span class="hljs-string">'jsval.'</span> + (lv ? <span class="hljs-string">"True"</span> : <span class="hljs-string">"False"</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (lv === <span class="hljs-literal">null</span>) {
            str = <span class="hljs-string">"jsval.Null"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (lv === <span class="hljs-literal">undefined</span>) {
            str = <span class="hljs-string">"jsval.Undefined"</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">console</span>.assert(<span class="hljs-literal">false</span>);
        }
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'  '</span> + pad(str + comma(i)) + <span class="hljs-string">' -- '</span> + i);
    });
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'}'</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">''</span>);

    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'return startup'</span>);
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
