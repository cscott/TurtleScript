<!DOCTYPE html>

<html>
<head>
  <title>bcompile.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="asm-llvm.html">
                asm-llvm.js
              </a>
            
              
              <a class="source" href="bcompile.html">
                bcompile.js
              </a>
            
              
              <a class="source" href="binterp.html">
                binterp.js
              </a>
            
              
              <a class="source" href="browsercanvas.html">
                browsercanvas.js
              </a>
            
              
              <a class="source" href="bytecode-table.html">
                bytecode-table.js
              </a>
            
              
              <a class="source" href="canvastest.html">
                canvastest.js
              </a>
            
              
              <a class="source" href="ccanvas.html">
                ccanvas.js
              </a>
            
              
              <a class="source" href="crender-styles.html">
                crender-styles.js
              </a>
            
              
              <a class="source" href="crender.html">
                crender.js
              </a>
            
              
              <a class="source" href="ctiles.html">
                ctiles.js
              </a>
            
              
              <a class="source" href="events.html">
                events.js
              </a>
            
              
              <a class="source" href="eventtests.html">
                eventtests.js
              </a>
            
              
              <a class="source" href="extensions.html">
                extensions.js
              </a>
            
              
              <a class="source" href="global-es5.html">
                global-es5.js
              </a>
            
              
              <a class="source" href="global.html">
                global.js
              </a>
            
              
              <a class="source" href="html-escape.html">
                html-escape.js
              </a>
            
              
              <a class="source" href="jcompile.html">
                jcompile.js
              </a>
            
              
              <a class="source" href="json2.html">
                json2.js
              </a>
            
              
              <a class="source" href="nodemain.html">
                nodemain.js
              </a>
            
              
              <a class="source" href="parse.html">
                parse.js
              </a>
            
              
              <a class="source" href="render.html">
                render.js
              </a>
            
              
              <a class="source" href="render2.html">
                render2.js
              </a>
            
              
              <a class="source" href="require.html">
                require.js
              </a>
            
              
              <a class="source" href="stdlib.html">
                stdlib.js
              </a>
            
              
              <a class="source" href="str-escape.html">
                str-escape.js
              </a>
            
              
              <a class="source" href="tdop.html">
                tdop.js
              </a>
            
              
              <a class="source" href="tests.html">
                tests.js
              </a>
            
              
              <a class="source" href="tiles.html">
                tiles.js
              </a>
            
              
              <a class="source" href="tokenize.html">
                tokenize.js
              </a>
            
              
              <a class="source" href="top-level.html">
                top-level.js
              </a>
            
              
              <a class="source" href="ts.html">
                ts.js
              </a>
            
              
              <a class="source" href="write-rust-bytecode.html">
                write-rust-bytecode.js
              </a>
            
              
              <a class="source" href="write-rust-ops.html">
                write-rust-ops.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1>bcompile.js</h1>
<p>Bytecode compiler for parsed Simplified JavaScript written in
Simplified JavaScript.</p>
<p>Implements lexical scope using object operations.  Eg.</p>
<pre><code>function foo() {
  var x = 5;
  function bar() {
    return x;
  }
}</code></pre>
<p>is desugared to something like:</p>
<pre><code> function addscope(f, scope) {
    return function() {
        var $frame = { function: f, scope: {} };
        $frame.scope.__proto__ = scope;
        return f($frame);
    };
 }
 $scope = {}
 $scope.foo = addscope(function($frame) {
     $frame.scope.x = 5;
     $frame.scope.bar = addscope(function($frame) {
        return $frame.scope.x;
     }, $frame.scope);
 }, $scope);</code></pre>
<p> where <code>$frame</code> is the activation record for the function.</p>
<p>C. Scott Ananian
2011-05-10</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>define([<span class="string">"bytecode-table"</span>], <span class="function"><span class="keyword">function</span> <span class="title">make_bcompile</span><span class="params">(bytecode_table)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>helper function for debugging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> assert = <span class="keyword">function</span>(b, obj) {
        <span class="keyword">if</span> (!b) {
            console.log(<span class="string">"ASSERTION FAILURE"</span>, obj);
            console.assert(<span class="literal">false</span>);
        }
    };

    <span class="keyword">var</span> dispatch = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>compilation state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> mkstate = <span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>The result of a compilation: a function list and a literal list.
We also need to count lexical scope nesting depth during compilation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> state = {
            functions: [],
            literals: [],</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>internal</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            scope: <span class="number">0</span>
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>literal symbol table.  Does string intern&#39;ing too.  Very simple.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state.literal = <span class="keyword">function</span>(val) {
            <span class="keyword">var</span> i = <span class="number">0</span>;
            <span class="keyword">var</span> nn = !(val === val); <span class="comment">// true iff val is NaN</span>
            <span class="keyword">while</span> (i &lt; <span class="keyword">this</span>.literals.length) {
                <span class="keyword">var</span> l = <span class="keyword">this</span>.literals[i];
                <span class="keyword">if</span> (nn ? !(l === l) : (l === val)) {
                    <span class="keyword">return</span> i;
                }
                i += <span class="number">1</span>;
            }
            <span class="keyword">this</span>.literals[i] = val;
            <span class="keyword">return</span> i;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>create a function representation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state.new_function = <span class="keyword">function</span>(nargs) {
            <span class="keyword">var</span> newf = {
                id: <span class="keyword">this</span>.functions.length,
                nargs: nargs,
                max_stack: <span class="number">0</span>,
                bytecode: [],</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>internal</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                stack_depth: <span class="number">0</span>,
                loop_label_stack: []
            };
            <span class="keyword">this</span>.functions[newf.id] = newf;
            <span class="keyword">return</span> newf;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>add bytecode to current function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state.emit = <span class="keyword">function</span>(bytecode_op) {
            <span class="keyword">var</span> op = bytecode_table.for_name(bytecode_op);
            <span class="keyword">var</span> cf = <span class="keyword">this</span>.current_func;
            <span class="keyword">var</span> i=<span class="number">1</span>;
            assert(op, bytecode_op);
            assert(cf.stack_depth &gt;= op.stackpop.apply(op, arguments));
            cf.bytecode.push(op.id);
            <span class="keyword">while</span> (i &lt; arguments.length) {
                cf.bytecode.push(arguments[i]);
                i += <span class="number">1</span>;
            }
            cf.stack_depth -= op.stackpop.apply(op, arguments);
            cf.stack_depth += op.stackpush.apply(op, arguments);
            <span class="keyword">if</span> (cf.stack_depth &gt; cf.max_stack) {
                cf.max_stack = cf.stack_depth;
            }
            cf.can_fall_off = <span class="literal">true</span>;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>decompile bytecode</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state.decompile = <span class="keyword">function</span>(func_id) {
            <span class="keyword">var</span> result = <span class="string">""</span>;
            <span class="keyword">var</span> f = <span class="keyword">this</span>.functions[func_id];
            <span class="keyword">var</span> pc = <span class="number">0</span>;
            <span class="keyword">while</span> ( pc &lt; f.bytecode.length ) {
                <span class="keyword">var</span> op = bytecode_table.for_num(f.bytecode[pc]);
                <span class="keyword">var</span> i = <span class="number">0</span>;
                result += (pc +<span class="string">": "</span>);
                result += op.name;
                result += op.printargs(<span class="keyword">this</span>, f.bytecode, pc);
                result += <span class="string">"\n"</span>;
                pc += <span class="number">1</span> + op.args;
            }
            <span class="keyword">return</span> result;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>compact encoding</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> encode_uint = <span class="keyword">function</span>(out, val) {
            assert(val &gt;= <span class="number">0</span>, val);
            <span class="keyword">if</span> (val &lt; <span class="number">128</span>) {
                out.push(val);
                <span class="keyword">return</span>;
            }
            <span class="keyword">var</span> msb = Math.floor(val / <span class="number">128</span>);
            <span class="keyword">var</span> lsb = (val - <span class="number">128</span>*msb);
            assert(lsb &gt;= <span class="number">0</span> &amp;&amp; lsb &lt; <span class="number">128</span>, val);
            assert(msb &gt; <span class="number">0</span>, val);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>little-endian</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            out.push(lsb + <span class="number">128</span>);
            encode_uint(out, msb);
        };
        <span class="keyword">var</span> encode_str = <span class="keyword">function</span>(out, str) {
            <span class="keyword">var</span> i = <span class="number">0</span>;
            encode_uint(out, str.length);
            <span class="keyword">while</span> (i &lt; str.length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>note that we are outputting characters in UTF16</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                encode_uint(out, str.charCodeAt(i));
                i += <span class="number">1</span>;
            }
        };
        state.encode = <span class="keyword">function</span>() {
            <span class="keyword">var</span> out = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>the number of functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            encode_uint(out, <span class="keyword">this</span>.functions.length);</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>each function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> i = <span class="number">0</span>;
            <span class="keyword">while</span> (i &lt; <span class="keyword">this</span>.functions.length) {
                <span class="keyword">var</span> f = <span class="keyword">this</span>.functions[i];
                encode_uint(out, f.nargs);
                encode_uint(out, f.max_stack);
                encode_str(out, f.name || <span class="string">''</span>);
                encode_uint(out, f.bytecode.length);
                <span class="keyword">var</span> j = <span class="number">0</span>;
                <span class="keyword">while</span> (j &lt; f.bytecode.length) {
                    <span class="keyword">var</span> v = f.bytecode[j];
                    v = (<span class="keyword">typeof</span>(v) === <span class="string">"number"</span>) ? v : v.label;
                    encode_uint(out, v);
                    j += <span class="number">1</span>;
                }
                i += <span class="number">1</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>the literal table.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            encode_uint(out, <span class="keyword">this</span>.literals.length);
            i = <span class="number">0</span>;
            <span class="keyword">while</span> (i &lt; <span class="keyword">this</span>.literals.length) {
                <span class="keyword">var</span> lv = <span class="keyword">this</span>.literals[i];
                <span class="keyword">if</span> (<span class="keyword">typeof</span>(lv) === <span class="string">"number"</span>) {
                    encode_uint(out, <span class="number">0</span> <span class="comment">/* number tag */</span>);
                    encode_str(out, lv.toString()); <span class="comment">/* not ideal! */</span>
                } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span>(lv) === <span class="string">"string"</span>) {
                    encode_uint(out, <span class="number">1</span> <span class="comment">/* string tag */</span>);
                    encode_str(out, lv);
                } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span>(lv) === <span class="string">"boolean"</span>) {
                    encode_uint(out, lv ? <span class="number">2</span> : <span class="number">3</span>); <span class="comment">/* boolean tags */</span>
                } <span class="keyword">else</span> <span class="keyword">if</span> (lv === <span class="literal">null</span>) {
                    encode_uint(out, <span class="number">4</span> <span class="comment">/* null tag */</span>);
                } <span class="keyword">else</span> <span class="keyword">if</span> (lv === <span class="literal">undefined</span>) {
                    encode_uint(out, <span class="number">5</span> <span class="comment">/* undefined tag */</span>);
                } <span class="keyword">else</span> {
                    console.log(<span class="string">"UNKNOWN LITERAL TYPE"</span>, lv);
                    encode_uint(out, <span class="number">6</span> <span class="comment">/* unknown */</span>);
                }
                i += <span class="number">1</span>;
            }
            <span class="keyword">return</span> out;
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>simple label mechanism</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state.new_label = <span class="keyword">function</span>() {
            <span class="keyword">return</span> { label: <span class="string">"&lt;undefined&gt;"</span> };
        };
        state.set_label = <span class="keyword">function</span>(label) {
            label.label = <span class="keyword">this</span>.current_func.bytecode.length;
        };
        state.peek_loop_label = <span class="keyword">function</span>() {
            <span class="keyword">var</span> lls = <span class="keyword">this</span>.current_func.loop_label_stack;
            <span class="keyword">return</span> lls[lls.length-<span class="number">1</span>];
        };
        state.pop_loop_label = <span class="keyword">function</span>() {
            <span class="keyword">return</span> <span class="keyword">this</span>.current_func.loop_label_stack.pop();
        };
        state.push_loop_label = <span class="keyword">function</span>(label) {
            <span class="keyword">return</span> <span class="keyword">this</span>.current_func.loop_label_stack.push(label);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>compilation hooks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state.bcompile_stmts = <span class="keyword">function</span>(tree_lst) {
            <span class="keyword">this</span>.bcompile_stmt({ value: <span class="string">"block"</span>,
                                 arity: <span class="string">"statement"</span>,
                                 first: tree_lst
                               });
        };
        state.bcompile_stmt = <span class="keyword">function</span>(tree) {
            assert(state.current_func.stack_depth === <span class="number">0</span>, tree);
            <span class="keyword">if</span> (tree.arity === <span class="string">"binary"</span> &amp;&amp;
                (tree.value === <span class="string">"="</span> || tree.value === <span class="string">"+="</span> ||
                 tree.value === <span class="string">"-="</span> || tree.value === <span class="string">"*="</span> ||
                 tree.value === <span class="string">"/="</span> )) {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>special case: optimize by not keeping final value on stack</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                dispatch[tree.arity].call(tree, <span class="keyword">this</span>, <span class="number">1</span><span class="comment">/*is stmt*/</span>);
                assert(state.current_func.stack_depth === <span class="number">0</span>, tree);
                <span class="keyword">return</span>;
            }
            <span class="keyword">this</span>.bcompile_expr(tree);
            <span class="keyword">if</span> (tree.arity !== <span class="string">"statement"</span>) {
                assert(state.current_func.stack_depth === <span class="number">1</span>, tree);
                <span class="keyword">this</span>.emit(<span class="string">"pop"</span>); <span class="comment">// discard value from expr evaluation</span>
            }
            assert(state.current_func.stack_depth === <span class="number">0</span>, tree);
        };
        state.bcompile_expr = <span class="keyword">function</span>(tree) {</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>make &#39;this&#39; the parse tree in the dispatched function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            assert(dispatch[tree.arity], tree);
            <span class="keyword">return</span> dispatch[tree.arity].call(tree, <span class="keyword">this</span>);
        };
        <span class="keyword">return</span> state;
    };

    dispatch.name = <span class="keyword">function</span>(state) {
        <span class="keyword">var</span> i = <span class="number">0</span>, depth = state.scope - <span class="keyword">this</span>.scope.level;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>lookup the name in the frame table</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state.emit(<span class="string">"push_frame"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>This loop is actually optional; the parent chain will do
the lookup correctly even if you don&#39;t take care to look
in the exact right frame (like we do here)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">while</span> ( i &lt; depth ) {
            state.emit(<span class="string">"get_slot_direct"</span>, state.literal(<span class="string">"__proto__"</span>));
            i += <span class="number">1</span>;
        }
        state.emit(<span class="string">"get_slot_direct"</span>, state.literal(<span class="keyword">this</span>.value));
    };
    dispatch.literal = <span class="keyword">function</span>(state) {
        <span class="keyword">if</span> (<span class="keyword">this</span>.value === <span class="literal">undefined</span>) {
            state.emit(<span class="string">"push_literal"</span>, state.literal(<span class="literal">undefined</span>));
            <span class="keyword">return</span>;
        }
        <span class="keyword">if</span> (<span class="keyword">this</span>.value === <span class="literal">null</span>) {
            state.emit(<span class="string">"push_literal"</span>, state.literal(<span class="literal">null</span>));
            <span class="keyword">return</span>;
        }
        <span class="keyword">if</span> (<span class="keyword">typeof</span>(<span class="keyword">this</span>.value)===<span class="string">'object'</span>) {
            <span class="keyword">var</span> which = <span class="string">"Object"</span>;
            <span class="keyword">if</span> (<span class="keyword">this</span>.value.length === <span class="number">0</span>) { which = <span class="string">"Array"</span>; }
            state.emit(<span class="string">"push_frame"</span>);
            state.emit(<span class="string">"get_slot_direct"</span>, state.literal(which));
            <span class="keyword">return</span>;
        }
        <span class="keyword">if</span> (<span class="keyword">typeof</span>(<span class="keyword">this</span>.value)===<span class="string">'string'</span>) {
            state.emit(<span class="string">"push_literal"</span>, state.literal(<span class="keyword">this</span>.value));
            <span class="keyword">return</span>;
        }
        <span class="keyword">if</span> (<span class="keyword">typeof</span>(<span class="keyword">this</span>.value)===<span class="string">'boolean'</span>) {
            state.emit(<span class="string">"push_literal"</span>, state.literal(<span class="keyword">this</span>.value));
            <span class="keyword">return</span>;
        }
        assert(<span class="keyword">typeof</span>(<span class="keyword">this</span>.value) === <span class="string">'number'</span>);
        state.emit(<span class="string">"push_literal"</span>, state.literal(<span class="keyword">this</span>.value));
        <span class="keyword">return</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>UNARY ASTs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch.unary = <span class="keyword">function</span>(state) {
        assert(dispatch.unary[<span class="keyword">this</span>.value], <span class="keyword">this</span>);
        dispatch.unary[<span class="keyword">this</span>.value].call(<span class="keyword">this</span>, state);
    };
    <span class="keyword">var</span> unary = <span class="keyword">function</span>(op, f) {
        <span class="keyword">if</span> (<span class="keyword">typeof</span>(f) === <span class="string">"string"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>f is a bytecode operator string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            dispatch.unary[op] = <span class="keyword">function</span>(state) {
                state.bcompile_expr(<span class="keyword">this</span>.first);
                state.emit(f);
            };
        } <span class="keyword">else</span> {
            dispatch.unary[op] = f;
        }
    };
    unary(<span class="string">'!'</span>, <span class="string">"un_not"</span>);
    unary(<span class="string">'-'</span>, <span class="string">"un_minus"</span>);
    unary(<span class="string">'typeof'</span>, <span class="string">"un_typeof"</span>);
    unary(<span class="string">'['</span>, <span class="keyword">function</span>(state) {</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>new array creation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> i=<span class="number">0</span>;
        state.emit(<span class="string">"new_array"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>now initialize the array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.first.forEach(<span class="keyword">function</span>(e, i) {
            state.emit(<span class="string">"dup"</span>);
            state.bcompile_expr(e);
            state.emit(<span class="string">"set_slot_direct"</span>, state.literal(i));
        });
    });
    unary(<span class="string">'{'</span>, <span class="keyword">function</span>(state) {</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>new object creation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> i=<span class="number">0</span>;
        state.emit(<span class="string">"new_object"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>now initialize the object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.first.forEach(<span class="keyword">function</span>(e, i) {
            state.emit(<span class="string">"dup"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>preserve function names</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (e.arity === <span class="string">"function"</span>) {
                e.extra_name = e.key+<span class="string">':'</span>;
            }
            state.bcompile_expr(e);
            state.emit(<span class="string">"set_slot_direct"</span>, state.literal(e.key));
        });
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Binary ASTs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch.binary = <span class="keyword">function</span>(state, is_stmt) {
        assert(dispatch.binary[<span class="keyword">this</span>.value], <span class="keyword">this</span>);
        dispatch.binary[<span class="keyword">this</span>.value].call(<span class="keyword">this</span>, state, is_stmt);
    };
    <span class="keyword">var</span> binary = <span class="keyword">function</span>(op, f, swap) {
        <span class="keyword">if</span> (<span class="keyword">typeof</span>(f) === <span class="string">"string"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>f is a bytecode operator string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            dispatch.binary[op] = <span class="keyword">function</span>(state) {
                state.bcompile_expr(<span class="keyword">this</span>.first);
                state.bcompile_expr(<span class="keyword">this</span>.second);
                <span class="keyword">if</span> (swap) {
                    state.emit(<span class="string">"swap"</span>);
                }
                state.emit(f);
            };
        } <span class="keyword">else</span> {
            dispatch.binary[op] = f;
        }
    };
    <span class="keyword">var</span> assignment = <span class="keyword">function</span>(mode) {
        <span class="keyword">return</span> <span class="keyword">function</span>(state, is_stmt) {</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>lhs should either be a name or a dot expression</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (<span class="keyword">this</span>.first.arity === <span class="string">"name"</span>) {
                <span class="keyword">var</span> i = <span class="number">0</span>, depth = state.scope - <span class="keyword">this</span>.first.scope.level;
                state.emit(<span class="string">"push_frame"</span>);
                <span class="keyword">while</span> ( i &lt; depth ) {
                    state.emit(<span class="string">"get_slot_direct"</span>, state.literal(<span class="string">"__proto__"</span>));
                    i += <span class="number">1</span>;
                }
                <span class="keyword">if</span> (mode) {
                    state.emit(<span class="string">"dup"</span>);
                    state.emit(<span class="string">"get_slot_direct"</span>,
                               state.literal(<span class="keyword">this</span>.first.value));
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>hack to preserve function names</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (<span class="keyword">this</span>.second.arity === <span class="string">"function"</span>) {
                    <span class="keyword">this</span>.second.extra_name = <span class="keyword">this</span>.first.value;
                }
                state.bcompile_expr(<span class="keyword">this</span>.second);
                <span class="keyword">if</span> (mode) {
                    state.emit(mode);
                }
                <span class="keyword">if</span> (!is_stmt) {</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>keep value we&#39;re setting as the value of the expression</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    state.emit(<span class="string">"over"</span>);
                }
                state.emit(<span class="string">"set_slot_direct"</span>, state.literal(<span class="keyword">this</span>.first.value));
                <span class="keyword">return</span>;
            }
            assert(<span class="keyword">this</span>.first.arity === <span class="string">"binary"</span>, <span class="keyword">this</span>.first);
            <span class="keyword">if</span> (<span class="keyword">this</span>.first.value === <span class="string">"."</span>) {
                assert(<span class="keyword">this</span>.first.second.arity === <span class="string">"literal"</span>, <span class="keyword">this</span>.first);
                state.bcompile_expr(<span class="keyword">this</span>.first.first);
                <span class="keyword">if</span> (mode) {
                    state.emit(<span class="string">"dup"</span>);
                    state.emit(<span class="string">"get_slot_direct"</span>,
                               state.literal(<span class="keyword">this</span>.first.second.value));
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>hack to preserve function names</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (<span class="keyword">this</span>.second.arity === <span class="string">"function"</span>) {
                    <span class="keyword">this</span>.second.extra_name = <span class="string">'.'</span>+<span class="keyword">this</span>.first.second.value;
                }
                state.bcompile_expr(<span class="keyword">this</span>.second);
                <span class="keyword">if</span> (mode) {
                    state.emit(mode);
                }
                <span class="keyword">if</span> (!is_stmt) {</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>keep value we&#39;re setting as the value of the expression</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    state.emit(<span class="string">"over"</span>);
                }
                state.emit(<span class="string">"set_slot_direct"</span>,
                           state.literal(<span class="keyword">this</span>.first.second.value));
                <span class="keyword">return</span>;
            }
            <span class="keyword">if</span> (<span class="keyword">this</span>.first.value === <span class="string">"["</span>) {
                state.bcompile_expr(<span class="keyword">this</span>.first.first);
                state.bcompile_expr(<span class="keyword">this</span>.first.second);
                <span class="keyword">if</span> (mode) {
                    state.emit(<span class="string">"2dup"</span>);
                    state.emit(<span class="string">"get_slot_indirect"</span>);
                }
                state.bcompile_expr(<span class="keyword">this</span>.second);
                <span class="keyword">if</span> (mode) {
                    state.emit(mode);
                }
                <span class="keyword">if</span> (!is_stmt) {</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>keep value we&#39;re setting as the value of the expression</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    state.emit(<span class="string">"over2"</span>);
                }
                state.emit(<span class="string">"set_slot_indirect"</span>);
                <span class="keyword">return</span>;
            }
            assert(<span class="literal">false</span>, <span class="keyword">this</span>.first);
        };
    };
    binary(<span class="string">'='</span>, assignment(<span class="literal">null</span>));
    binary(<span class="string">'+='</span>, assignment(<span class="string">"bi_add"</span>));
    binary(<span class="string">'-='</span>, assignment(<span class="string">"bi_sub"</span>));
    binary(<span class="string">'*='</span>, assignment(<span class="string">"bi_mul"</span>));
    binary(<span class="string">'/='</span>, assignment(<span class="string">"bi_div"</span>));
    binary(<span class="string">'||'</span>, <span class="keyword">function</span>(state) {</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>expr1 || expr2 returns expr1 if it can be converted to true;
               else returns expr2</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> sd_before, sd_after;
        <span class="keyword">var</span> mergeLabel = state.new_label();</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>short circuit operator</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state.bcompile_expr(<span class="keyword">this</span>.first);
        state.emit(<span class="string">"dup"</span>);
        state.emit(<span class="string">"un_not"</span>);
        state.emit(<span class="string">"jmp_unless"</span>, mergeLabel);
        sd_before = state.current_func.stack_depth;
        state.emit(<span class="string">"pop"</span>);
        state.bcompile_expr(<span class="keyword">this</span>.second);
        state.set_label(mergeLabel);
        sd_after = state.current_func.stack_depth;
        assert(sd_before === sd_after, <span class="keyword">this</span>);
    });
    binary(<span class="string">'&amp;&amp;'</span>, <span class="keyword">function</span>(state) {</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>expr1 &amp;&amp; expr2 returns expr1 if it can be converted to false;
               else returns expr2</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> sd_before, sd_after;
        <span class="keyword">var</span> mergeLabel = state.new_label();</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>short circuit operator</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state.bcompile_expr(<span class="keyword">this</span>.first);
        state.emit(<span class="string">"dup"</span>);
        state.emit(<span class="string">"jmp_unless"</span>, mergeLabel);
        sd_before = state.current_func.stack_depth;
        state.emit(<span class="string">"pop"</span>);
        state.bcompile_expr(<span class="keyword">this</span>.second);
        state.set_label(mergeLabel);
        sd_after = state.current_func.stack_depth;
        assert(sd_before === sd_after, <span class="keyword">this</span>);
    });
    binary(<span class="string">'==='</span>, <span class="string">"bi_eq"</span>);
    binary(<span class="string">'!=='</span>, <span class="keyword">function</span>(state) {
        state.bcompile_expr({
            value: <span class="string">'!'</span>,
            arity: <span class="string">'unary'</span>,
            first: {
                value: <span class="string">'==='</span>,
                arity: <span class="string">'binary'</span>,
                first: <span class="keyword">this</span>.first,
                second: <span class="keyword">this</span>.second
            }
        });
    });
    binary(<span class="string">'&lt;'</span>, <span class="string">'bi_gt'</span>, <span class="number">1</span><span class="comment">/*swap*/</span>);
    binary(<span class="string">'&lt;='</span>, <span class="string">'bi_gte'</span>, <span class="number">1</span><span class="comment">/*swap*/</span>);
    binary(<span class="string">'&gt;'</span>, <span class="string">'bi_gt'</span>);
    binary(<span class="string">'&gt;='</span>,<span class="string">'bi_gte'</span>);
    binary(<span class="string">'+'</span>, <span class="string">'bi_add'</span>);
    binary(<span class="string">'-'</span>, <span class="string">'bi_sub'</span>);
    binary(<span class="string">'*'</span>, <span class="string">'bi_mul'</span>);
    binary(<span class="string">'/'</span>, <span class="string">'bi_div'</span>);
    binary(<span class="string">"."</span>, <span class="keyword">function</span>(state) {
        state.bcompile_expr(<span class="keyword">this</span>.first);
        assert(<span class="keyword">this</span>.second.arity === <span class="string">"literal"</span>, <span class="keyword">this</span>.second);
        state.emit(<span class="string">"get_slot_direct"</span>, state.literal(<span class="keyword">this</span>.second.value));
    });
    binary(<span class="string">'['</span>, <span class="keyword">function</span>(state) {
        state.bcompile_expr(<span class="keyword">this</span>.first);
        state.bcompile_expr(<span class="keyword">this</span>.second);
        state.emit(<span class="string">"get_slot_indirect"</span>);
    });
    binary(<span class="string">'('</span>, <span class="keyword">function</span>(state) {</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>this doesn&#39;t change &#39;this&#39; (which is passed as first arg)
function object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state.bcompile_expr(<span class="keyword">this</span>.first);</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>first arg is &#39;this&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state.bcompile_expr({ value: <span class="string">"this"</span>, arity: <span class="string">"this"</span> });</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>arguments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.second.forEach(<span class="keyword">function</span>(e, i) {
            state.bcompile_expr(e);
        });
        state.emit(<span class="string">"invoke"</span>, <span class="keyword">this</span>.second.length);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Ternary ASTs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch.ternary = <span class="keyword">function</span>(state) {
        assert(dispatch.ternary[<span class="keyword">this</span>.value], <span class="keyword">this</span>);
        dispatch.ternary[<span class="keyword">this</span>.value].call(<span class="keyword">this</span>, state);
    };
    <span class="keyword">var</span> ternary = <span class="keyword">function</span>(op, f) {
        dispatch.ternary[op] = f;
    };
    ternary(<span class="string">"?"</span>, <span class="keyword">function</span>(state) {
        <span class="keyword">var</span> sd_before, sd_after;
        <span class="keyword">var</span> falseLabel = state.new_label();
        <span class="keyword">var</span> mergeLabel = state.new_label();
        state.bcompile_expr(<span class="keyword">this</span>.first);
        state.emit(<span class="string">"jmp_unless"</span>, falseLabel);</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>&quot;true&quot; case</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        sd_before = state.current_func.stack_depth;
        state.bcompile_expr(<span class="keyword">this</span>.second);
        state.emit(<span class="string">"jmp"</span>, mergeLabel);
        sd_after = state.current_func.stack_depth;</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>&quot;false&quot; case</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state.current_func.stack_depth = sd_before;
        state.set_label(falseLabel);
        state.bcompile_expr(<span class="keyword">this</span>.third);
        state.set_label(mergeLabel);
        assert(state.current_func.stack_depth === sd_after, <span class="keyword">this</span>);
    });
    ternary(<span class="string">"("</span>, <span class="keyword">function</span>(state) {</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>version of method call which sets &#39;this&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state.bcompile_expr(<span class="keyword">this</span>.first); <span class="comment">// this will be 'this'</span>
        state.emit(<span class="string">"dup"</span>);
        <span class="keyword">if</span> (<span class="keyword">this</span>.second.arity===<span class="string">'literal'</span> &amp;&amp;
            <span class="keyword">typeof</span>(<span class="keyword">this</span>.second.value)===<span class="string">'string'</span>) {
            state.emit(<span class="string">"get_slot_direct_check"</span>,
                       state.literal(<span class="keyword">this</span>.second.value));
        } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>invocation via []</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            state.bcompile_expr(<span class="keyword">this</span>.second);
            state.emit(<span class="string">"get_slot_indirect"</span>);
        }
        state.emit(<span class="string">"swap"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>now order is &quot;<top> this function&quot;.  Push arguments.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.third.forEach(<span class="keyword">function</span>(e, i) {
            state.bcompile_expr(e);
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>invoke!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state.emit(<span class="string">"invoke"</span>, <span class="keyword">this</span>.third.length);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Statements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch.statement = <span class="keyword">function</span>(state) {
        assert(dispatch.statement[<span class="keyword">this</span>.value], <span class="keyword">this</span>);
        dispatch.statement[<span class="keyword">this</span>.value].call(<span class="keyword">this</span>, state);
    };
    <span class="keyword">var</span> stmt = <span class="keyword">function</span>(value, f) {
        dispatch.statement[value] = f;
    };
    stmt(<span class="string">"block"</span>, <span class="keyword">function</span>(state) {
        <span class="keyword">this</span>.first.forEach(<span class="keyword">function</span>(e, i) {
            state.bcompile_stmt(e);
        });
    });
    stmt(<span class="string">"var"</span>, <span class="keyword">function</span>(state) {</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Set variables to &#39;undefined&#39; in our
local frame, in order to properly hide definitions in
surrounding contexts.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state.bcompile_stmt({
            arity: <span class="string">'binary'</span>,
            value: <span class="string">'='</span>,
            first: <span class="keyword">this</span>.first,
            second: {
                arity: <span class="string">'literal'</span>,
                value: <span class="literal">undefined</span>
            }
        });
    });
    stmt(<span class="string">"if"</span>, <span class="keyword">function</span>(state) {
        <span class="keyword">var</span> falseLabel = state.new_label();
        state.bcompile_expr(<span class="keyword">this</span>.first);
        state.emit(<span class="string">"jmp_unless"</span>, falseLabel);
        state.bcompile_stmt(<span class="keyword">this</span>.second);
        <span class="keyword">if</span> (<span class="keyword">this</span>.third) {
            <span class="keyword">var</span> mergeLabel = state.new_label();
            state.emit(<span class="string">"jmp"</span>, mergeLabel);
            state.set_label(falseLabel);
            state.bcompile_stmt(<span class="keyword">this</span>.third);
            state.set_label(mergeLabel);
        } <span class="keyword">else</span> {
            state.set_label(falseLabel);
        }
    });
    stmt(<span class="string">"return"</span>, <span class="keyword">function</span>(state) {
        <span class="keyword">if</span> (<span class="keyword">this</span>.first) {
            state.bcompile_expr(<span class="keyword">this</span>.first);
        } <span class="keyword">else</span> {
            state.emit(<span class="string">"push_literal"</span>, state.literal(<span class="literal">undefined</span>));
        }
        state.emit(<span class="string">"return"</span>);
        state.current_func.can_fall_off = <span class="literal">false</span>;
    });
    stmt(<span class="string">"break"</span>, <span class="keyword">function</span>(state) {
        state.emit(<span class="string">"jmp"</span>, state.peek_loop_label());
    });
    stmt(<span class="string">"while"</span>, <span class="keyword">function</span>(state) {
        <span class="keyword">var</span> startLabel = state.new_label();
        <span class="keyword">var</span> testLabel = state.new_label();
        <span class="keyword">var</span> endLabel = state.new_label();
        state.push_loop_label(endLabel);

        state.emit(<span class="string">"jmp"</span>, testLabel);
        state.set_label(startLabel);
        state.bcompile_stmt(<span class="keyword">this</span>.second);
        state.set_label(testLabel);
        state.bcompile_expr(<span class="keyword">this</span>.first);
        state.emit(<span class="string">"un_not"</span>);
        state.emit(<span class="string">"jmp_unless"</span>, startLabel);
        state.set_label(endLabel);

        state.pop_loop_label();
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Odd cases</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dispatch[<span class="string">'this'</span>] = <span class="keyword">function</span>(state) {
        state.emit(<span class="string">"push_frame"</span>);
        state.emit(<span class="string">"get_slot_direct"</span>, state.literal(<span class="string">"this"</span>));
    };
    dispatch[<span class="string">'function'</span>] = <span class="keyword">function</span>(state) {
        <span class="keyword">if</span> (<span class="keyword">this</span>.name) {
            state.bcompile_expr({ value: <span class="string">"="</span>,
                                  arity: <span class="string">"binary"</span>,
                                  first: {
                                      value: <span class="keyword">this</span>.name,
                                      arity: <span class="string">"name"</span>,
                                      scope: <span class="keyword">this</span>.scope
                                  },
                                  second: {</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>clone of this, except w/o &#39;name&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                      value: <span class="string">"function"</span>,
                                      arity: <span class="string">"function"</span>,
                                      first: <span class="keyword">this</span>.first,
                                      second: <span class="keyword">this</span>.second,</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>keep name around to associate later.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                      extra_name: <span class="keyword">this</span>.name
                                  }
                                });
            <span class="keyword">return</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>create and compile a new function object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> this_func = state.current_func;
        <span class="keyword">var</span> new_func = state.new_function(<span class="keyword">this</span>.first.length);
        <span class="keyword">if</span> (<span class="keyword">this</span>.extra_name) {
            new_func.name = <span class="keyword">this</span>.extra_name;
        }
        state.current_func = new_func;
        state.scope += <span class="number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>compile the new function.
at start, we have an empty stack and a (properly-linked) frame w/ 2
field, &quot;arguments&quot; and &quot;this&quot;.  Name the arguments in the local
context.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state.emit(<span class="string">"push_frame"</span>);
        state.emit(<span class="string">"get_slot_direct"</span>, state.literal(<span class="string">"arguments"</span>));
        <span class="keyword">this</span>.first.forEach(<span class="keyword">function</span>(e, i) {
            state.emit(<span class="string">"dup"</span>);
            state.emit(<span class="string">"get_slot_direct"</span>, state.literal(i));
            state.emit(<span class="string">"push_frame"</span>);
            state.emit(<span class="string">"swap"</span>);
            state.emit(<span class="string">"set_slot_direct"</span>, state.literal(e.value));
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>done using the arguments array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state.emit(<span class="string">"pop"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>handle the body</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state.bcompile_stmts(<span class="keyword">this</span>.second);</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>finish w/ no-arg return</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (state.current_func.can_fall_off) {
            state.bcompile_stmt({ value: <span class="string">"return"</span>, arity: <span class="string">"statement"</span> });
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>restore original function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state.current_func = this_func;
        state.scope -= <span class="number">1</span>;
        state.emit(<span class="string">"new_function"</span>, new_func.id);
        <span class="keyword">return</span>;
    };

    <span class="keyword">var</span> bcompile = <span class="function"><span class="keyword">function</span> <span class="params">(parse_tree)</span> {</span>
        <span class="keyword">var</span> state = mkstate();
        state.current_func = state.new_function(<span class="number">0</span>);
        state.bcompile_stmts(parse_tree);
        <span class="keyword">if</span> (state.current_func.can_fall_off) {
            state.bcompile_stmt({ value: <span class="string">"return"</span>, arity: <span class="string">"statement"</span> });
        }
        <span class="keyword">return</span> state;
    };
    bcompile.__module_name__ = <span class="string">"bcompile"</span>;
    bcompile.__module_init__ = make_bcompile;
    bcompile.__module_deps__ = [<span class="string">"bytecode-table"</span>];
    <span class="keyword">return</span> bcompile;
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
