<!DOCTYPE html>

<html>
<head>
  <title>events.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="asm-llvm.html">
                asm-llvm.js
              </a>
            
              
              <a class="source" href="bcompile.html">
                bcompile.js
              </a>
            
              
              <a class="source" href="binterp.html">
                binterp.js
              </a>
            
              
              <a class="source" href="browsercanvas.html">
                browsercanvas.js
              </a>
            
              
              <a class="source" href="bytecode-table.html">
                bytecode-table.js
              </a>
            
              
              <a class="source" href="canvastest.html">
                canvastest.js
              </a>
            
              
              <a class="source" href="ccanvas.html">
                ccanvas.js
              </a>
            
              
              <a class="source" href="crender-styles.html">
                crender-styles.js
              </a>
            
              
              <a class="source" href="crender.html">
                crender.js
              </a>
            
              
              <a class="source" href="ctiles.html">
                ctiles.js
              </a>
            
              
              <a class="source" href="events.html">
                events.js
              </a>
            
              
              <a class="source" href="eventtests.html">
                eventtests.js
              </a>
            
              
              <a class="source" href="extensions.html">
                extensions.js
              </a>
            
              
              <a class="source" href="global-es5.html">
                global-es5.js
              </a>
            
              
              <a class="source" href="global.html">
                global.js
              </a>
            
              
              <a class="source" href="html-escape.html">
                html-escape.js
              </a>
            
              
              <a class="source" href="jcompile.html">
                jcompile.js
              </a>
            
              
              <a class="source" href="json2.html">
                json2.js
              </a>
            
              
              <a class="source" href="nodemain.html">
                nodemain.js
              </a>
            
              
              <a class="source" href="parse.html">
                parse.js
              </a>
            
              
              <a class="source" href="render.html">
                render.js
              </a>
            
              
              <a class="source" href="render2.html">
                render2.js
              </a>
            
              
              <a class="source" href="require.html">
                require.js
              </a>
            
              
              <a class="source" href="stdlib.html">
                stdlib.js
              </a>
            
              
              <a class="source" href="str-escape.html">
                str-escape.js
              </a>
            
              
              <a class="source" href="tdop.html">
                tdop.js
              </a>
            
              
              <a class="source" href="tests.html">
                tests.js
              </a>
            
              
              <a class="source" href="text.html">
                text.js
              </a>
            
              
              <a class="source" href="tiles.html">
                tiles.js
              </a>
            
              
              <a class="source" href="tokenize.html">
                tokenize.js
              </a>
            
              
              <a class="source" href="top-level.html">
                top-level.js
              </a>
            
              
              <a class="source" href="ts.html">
                ts.js
              </a>
            
              
              <a class="source" href="write-lua-bytecode.html">
                write-lua-bytecode.js
              </a>
            
              
              <a class="source" href="write-lua-ops.html">
                write-lua-ops.js
              </a>
            
              
              <a class="source" href="write-php-bytecode.html">
                write-php-bytecode.js
              </a>
            
              
              <a class="source" href="write-php-ops.html">
                write-php-ops.js
              </a>
            
              
              <a class="source" href="write-rust-bytecode.html">
                write-rust-bytecode.js
              </a>
            
              
              <a class="source" href="write-rust-ops.html">
                write-rust-ops.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>events.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>TurtleScript FRS-style event system.  Heavily based on Flapjax, and
as such it is:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*
 * Copyright (c) 2006-2009, The Flapjax Team.  All Rights Reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 * * Redistributions of source code must retain the above copyright notice,
 *   this list of conditions and the following disclaimer.
 * * Redistributions in binary form must reproduce the above copyright notice,
 *   this list of conditions and the following disclaimer in the documentation
 *   and/or other materials provided with the distribution.
 * * Neither the name of the Brown University, the Flapjax Team, nor the names
 *   of its contributors may be used to endorse or promote products derived
 *   from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 */</span>
define([<span class="hljs-string">"text!events.js"</span>, <span class="hljs-string">"!timeouts"</span>], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">make_flapjax</span>(<span class="hljs-params">events_source, timeouts</span>) </span>{
    <span class="hljs-keyword">var</span> setTimeout = timeouts.setTimeout;
    <span class="hljs-keyword">var</span> clearTimeout = timeouts.clearTimeout;

    <span class="hljs-keyword">var</span> slice = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">arr, start, stop</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Array</span>.prototype.slice.call(arr, start, stop);
    };

    <span class="hljs-keyword">var</span> zip = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">arrays</span>) </span>{
        <span class="hljs-keyword">var</span> ret = [], i = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (arrays.length &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">while</span> (i &lt; arrays[<span class="hljs-number">0</span>].length) {
                ret.push([]);
                arrays.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">arr</span>) </span>{
                    ret[i].push(arr[i]);
                });
                i += <span class="hljs-number">1</span>;
            }
        }
        <span class="hljs-keyword">return</span> ret;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>map: (a * ... -&gt; z) * [a] * ... -&gt; [z]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> map = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">fn</span>) </span>{
        <span class="hljs-keyword">var</span> arrays = slice(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
        <span class="hljs-keyword">var</span> ret = [];
        <span class="hljs-keyword">if</span> (arrays.length === <span class="hljs-number">1</span>) {
            arrays[<span class="hljs-number">0</span>].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
                ret.push(fn(e));
            });
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (arrays.length &gt; <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">var</span> o = {};
            zip(arrays).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>) </span>{
                ret.push(fn.apply(o, args));
            });
        }
        <span class="hljs-keyword">return</span> ret;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>filter: (a -&gt; Boolean) * Array a -&gt; Array a</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> filter = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">predFn, arr</span>) </span>{
        <span class="hljs-keyword">var</span> res = [];
        arr.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">elem</span>) </span>{
            <span class="hljs-keyword">if</span> (predFn(elem)) { res.push(elem); }
        });
        <span class="hljs-keyword">return</span> res;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>////////////////////////////////////////////////////////////////////////////
Flapjax core</p>
<p>Sentinel value returned by updaters to stop propagation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> doNotPropagate = { };</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Pulse: Stamp * Path * Obj</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Pulse = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">stamp, value</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Timestamps are used by liftB (and ifE).  Since liftB may receive multiple
update signals in the same run of the evaluator, it only propagates the
signal if it has a new stamp.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.stamp = stamp;
  <span class="hljs-keyword">this</span>.value = value;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Probably can optimize as we expect increasing insert runs etc
XXX csa: replace Math.floor with &gt;&gt;1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> PQ = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> ctx = <span class="hljs-keyword">this</span>;
  ctx.val = [];
  <span class="hljs-keyword">this</span>.insert = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">kv</span>) </span>{
    ctx.val.push(kv);
    <span class="hljs-keyword">var</span> kvpos = ctx.val.length<span class="hljs-number">-1</span>;
    <span class="hljs-keyword">while</span>(kvpos &gt; <span class="hljs-number">0</span> &amp;&amp; kv.k &lt; ctx.val[<span class="hljs-built_in">Math</span>.floor((kvpos<span class="hljs-number">-1</span>)/<span class="hljs-number">2</span>)].k) {
      <span class="hljs-keyword">var</span> oldpos = kvpos;
      kvpos = <span class="hljs-built_in">Math</span>.floor((kvpos<span class="hljs-number">-1</span>)/<span class="hljs-number">2</span>);
      ctx.val[oldpos] = ctx.val[kvpos];
      ctx.val[kvpos] = kv;
    }
  };
  <span class="hljs-keyword">this</span>.isEmpty = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> ctx.val.length === <span class="hljs-number">0</span>;
  };
  <span class="hljs-keyword">this</span>.pop = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span>(ctx.val.length === <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">return</span> ctx.val.pop();
    }
    <span class="hljs-keyword">var</span> ret = ctx.val.shift();
    ctx.val.unshift(ctx.val.pop());
    <span class="hljs-keyword">var</span> kvpos = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> kv = ctx.val[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) {
      <span class="hljs-keyword">var</span> leftChild = (kvpos*<span class="hljs-number">2</span>+<span class="hljs-number">1</span> &lt; ctx.val.length ? ctx.val[kvpos*<span class="hljs-number">2</span>+<span class="hljs-number">1</span>].k : kv.k+<span class="hljs-number">1</span>);
      <span class="hljs-keyword">var</span> rightChild = (kvpos*<span class="hljs-number">2</span>+<span class="hljs-number">2</span> &lt; ctx.val.length ? ctx.val[kvpos*<span class="hljs-number">2</span>+<span class="hljs-number">2</span>].k : kv.k+<span class="hljs-number">1</span>);
      <span class="hljs-keyword">if</span>(leftChild &gt; kv.k &amp;&amp; rightChild &gt; kv.k) {
          <span class="hljs-keyword">break</span>;
      }

      <span class="hljs-keyword">if</span>(leftChild &lt; rightChild) {
        ctx.val[kvpos] = ctx.val[kvpos*<span class="hljs-number">2</span>+<span class="hljs-number">1</span>];
        ctx.val[kvpos*<span class="hljs-number">2</span>+<span class="hljs-number">1</span>] = kv;
        kvpos = kvpos*<span class="hljs-number">2</span>+<span class="hljs-number">1</span>;
      }
      <span class="hljs-keyword">else</span> {
        ctx.val[kvpos] = ctx.val[kvpos*<span class="hljs-number">2</span>+<span class="hljs-number">2</span>];
        ctx.val[kvpos*<span class="hljs-number">2</span>+<span class="hljs-number">2</span>] = kv;
        kvpos = kvpos*<span class="hljs-number">2</span>+<span class="hljs-number">2</span>;
      }
    }
    <span class="hljs-keyword">return</span> ret;
  };
};

<span class="hljs-keyword">var</span> lastRank = <span class="hljs-number">0</span>;
<span class="hljs-keyword">var</span> stamp = <span class="hljs-number">1</span>;
<span class="hljs-keyword">var</span> nextStamp = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    stamp += <span class="hljs-number">1</span>;
    <span class="hljs-keyword">return</span> stamp;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>propagatePulse: Pulse * Array Node -&gt;
Send the pulse to each node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> propagatePulse = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">pulse, node</span>) </span>{
  <span class="hljs-keyword">var</span> queue = PQ.New(); <span class="hljs-comment">//topological queue for current timestep</span>

  queue.insert({<span class="hljs-attr">k</span>:node.rank,<span class="hljs-attr">n</span>:node,<span class="hljs-attr">v</span>:pulse});
  <span class="hljs-keyword">var</span> len = <span class="hljs-number">1</span>;

  <span class="hljs-keyword">while</span> (len) {
    <span class="hljs-keyword">var</span> qv = queue.pop();
    len-=<span class="hljs-number">1</span>;
    <span class="hljs-keyword">var</span> nextPulse = qv.n.updater(Pulse.New(qv.v.stamp, qv.v.value));
    <span class="hljs-keyword">var</span> weaklyHeld = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">if</span> (nextPulse !== doNotPropagate) {
      qv.n.sendsTo.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">n</span>) </span>{
        weaklyHeld = weaklyHeld &amp;&amp; n.weaklyHeld;
        len+=<span class="hljs-number">1</span>;
        queue.insert({<span class="hljs-attr">k</span>:n.rank,<span class="hljs-attr">n</span>:n,<span class="hljs-attr">v</span>:nextPulse});
      });
      <span class="hljs-keyword">if</span> (qv.n.sendsTo.length &gt; <span class="hljs-number">0</span> &amp;&amp; weaklyHeld) {
          qv.n.weaklyHeld = <span class="hljs-literal">true</span>;
      }
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Event: Array Node b * ( (Pulse a -&gt; Void) * Pulse b -&gt; Void)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> EventStream = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">nodes,updater</span>) </span>{
  <span class="hljs-keyword">this</span>.updater = updater;

  <span class="hljs-keyword">this</span>.sendsTo = []; <span class="hljs-comment">//forward link</span>
  <span class="hljs-keyword">this</span>.weaklyHeld = <span class="hljs-literal">false</span>;

  nodes.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">n</span>) </span>{
        n.attachListener(<span class="hljs-keyword">this</span>);
  }, <span class="hljs-keyword">this</span>);

  lastRank += <span class="hljs-number">1</span>;
  <span class="hljs-keyword">this</span>.rank = lastRank;
};
EventStream.prototype = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>createNode: Array Node a * ( (Pulse b -&gt;) * (Pulse a) -&gt; Void) -&gt; Node b</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> createNode = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">nodes, updater</span>) </span>{
  <span class="hljs-keyword">return</span> EventStream.New(nodes,updater);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>note that this creates a new timestamp and new event queue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> sendEvent = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">node, value</span>) </span>{
  <span class="hljs-keyword">if</span> (!EventStream.hasInstance(node)) {
      <span class="hljs-built_in">Object</span>.Throw(<span class="hljs-string">'sendEvent: expected Event as first arg'</span>);
  } <span class="hljs-comment">//SAFETY</span>

  propagatePulse(Pulse.New(nextStamp(), value),node);
};

<span class="hljs-keyword">var</span> genericAttachListener = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">node, dependent</span>) </span>{
  node.sendsTo.push(dependent);

  <span class="hljs-keyword">if</span>(node.rank &gt; dependent.rank) {
    <span class="hljs-keyword">var</span> lowest = lastRank+<span class="hljs-number">1</span>;
    <span class="hljs-keyword">var</span> q = [dependent];
    <span class="hljs-keyword">while</span>(q.length) {
      <span class="hljs-keyword">var</span> cur = q.splice(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>];
      lastRank += <span class="hljs-number">1</span>;
      cur.rank = lastRank;
      q = q.concat(cur.sendsTo);
    }
  }
};

<span class="hljs-keyword">var</span> genericRemoveListener = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">node, dependent, isWeakReference</span>) </span>{
  <span class="hljs-keyword">var</span> foundSending = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">while</span>( i &lt; node.sendsTo.length &amp;&amp; !foundSending ) {
    <span class="hljs-keyword">if</span> (node.sendsTo[i] === dependent) {
      node.sendsTo.splice(i, <span class="hljs-number">1</span>);
      foundSending = <span class="hljs-literal">true</span>;
    }
    i += <span class="hljs-number">1</span>;
  }

  <span class="hljs-keyword">if</span> (isWeakReference === <span class="hljs-literal">true</span> &amp;&amp; node.sendsTo.length === <span class="hljs-number">0</span>) {
    node.weaklyHeld = <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">return</span> foundSending;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>attachListener: Node * Node -&gt; Void
flow from node to dependent
note: does not add flow as counting for rank nor updates parent ranks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>EventStream.prototype.attachListener = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">dependent</span>) </span>{
  <span class="hljs-keyword">if</span> (!EventStream.hasInstance(dependent)) {
      <span class="hljs-built_in">Object</span>.Throw(<span class="hljs-string">'attachListener: expected an EventStream'</span>);
  }
  genericAttachListener(<span class="hljs-keyword">this</span>, dependent);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>note: does not remove flow as counting for rank nor updates parent ranks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>EventStream.prototype.removeListener = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">dependent, isWeak</span>) </span>{
  <span class="hljs-keyword">if</span> (!EventStream.hasInstance(dependent)) {
    <span class="hljs-built_in">Object</span>.Throw(<span class="hljs-string">'removeListener: expected an EventStream'</span>);
  }

  genericRemoveListener(<span class="hljs-keyword">this</span>, dependent, isWeak);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>An internalE is a node that simply propagates all pulses it receives.  It&#39;s used internally by various
combinators.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> internalE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">dependsOn</span>) </span>{
  <span class="hljs-keyword">return</span> createNode(dependsOn || [ ],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pulse</span>) </span>{ <span class="hljs-keyword">return</span> pulse; });
};

<span class="hljs-keyword">var</span> zeroE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> createNode([],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pulse</span>) </span>{
      <span class="hljs-built_in">Object</span>.Throw (<span class="hljs-string">'zeroE : received a value; zeroE should not receive a value; the value was '</span> + pulse.value);
  });
};


<span class="hljs-keyword">var</span> oneE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">val</span>) </span>{
  <span class="hljs-keyword">var</span> sent = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> evt = createNode([],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pulse</span>) </span>{
    <span class="hljs-keyword">if</span> (sent) {
      <span class="hljs-built_in">Object</span>.Throw (<span class="hljs-string">'oneE : received an extra value'</span>);
    }
    sent = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> pulse;
  });
  setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ sendEvent(evt,val); },<span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> evt;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>a.k.a. mplus; mergeE(e1,e2) == mergeE(e2,e1)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> mergeE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> zeroE();
  }
  <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">var</span> deps = slice(<span class="hljs-built_in">arguments</span>,<span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> internalE(deps);
  }
};


EventStream.prototype.mergeE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> deps = slice(<span class="hljs-built_in">arguments</span>,<span class="hljs-number">0</span>);
  deps.push(<span class="hljs-keyword">this</span>);
  <span class="hljs-keyword">return</span> internalE(deps);
};


EventStream.prototype.constantE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">constantValue</span>) </span>{
  <span class="hljs-keyword">return</span> createNode([<span class="hljs-keyword">this</span>],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pulse</span>) </span>{
    pulse.value = constantValue;
    <span class="hljs-keyword">return</span> pulse;
  });
};


<span class="hljs-keyword">var</span> constantE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e,v</span>) </span>{ <span class="hljs-keyword">return</span> e.constantE(v); };</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>This is up here so we can add things to its prototype that are in flapjax.combinators</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Behavior = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event, init, updater</span>) </span>{
  <span class="hljs-keyword">if</span> (!EventStream.hasInstance(event)) {
    <span class="hljs-built_in">Object</span>.Throw (<span class="hljs-string">'Behavior: expected event as second arg'</span>);
  }

  <span class="hljs-keyword">var</span> behave = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">this</span>.last = init;</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>sendEvent to this might impact other nodes that depend on this event
sendBehavior defaults to this one</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.underlyingRaw = event;</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>unexposed, sendEvent to this will only impact dependents of this behaviour</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.underlying = createNode([event], updater
    ? <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">p</span>) </span>{
        behave.last = updater(p.value);
        p.value = behave.last; <span class="hljs-keyword">return</span> p;
      }
    : <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">p</span>) </span>{
        behave.last = p.value;
        <span class="hljs-keyword">return</span> p;
      });
};
Behavior.prototype = {};

Behavior.prototype.valueNow = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.last;
};
<span class="hljs-keyword">var</span> valueNow = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">behavior</span>) </span>{ <span class="hljs-keyword">return</span> behavior.valueNow(); };
<span class="hljs-keyword">var</span> constantB;

Behavior.prototype.changes = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.underlying;
};
<span class="hljs-keyword">var</span> changes = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">behave</span>) </span>{ <span class="hljs-keyword">return</span> behave.changes(); };


<span class="hljs-keyword">var</span> receiverE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> evt = internalE();
  evt.sendEvent = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
    propagatePulse(Pulse.New(nextStamp(), value),evt);
  };
  <span class="hljs-keyword">return</span> evt;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>bindE :: EventStream a * (a -&gt; EventStream b) -&gt; EventStream b</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>EventStream.prototype.bindE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">k</span>) </span>{
  <span class="hljs-comment">/* m.sendsTo resultE
   * resultE.sendsTo prevE
   * prevE.sendsTo returnE
   */</span>
  <span class="hljs-keyword">var</span> m = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> prevE = <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">var</span> outE = createNode([],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pulse</span>) </span>{ <span class="hljs-keyword">return</span> pulse; });
  outE.name = <span class="hljs-string">"bind outE"</span>;

  <span class="hljs-keyword">var</span> inE = createNode([m], <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">pulse</span>) </span>{
    <span class="hljs-keyword">if</span> (prevE) {
      prevE.removeListener(outE, <span class="hljs-literal">true</span>);

    }
    prevE = k(pulse.value);
    <span class="hljs-keyword">if</span> (EventStream.hasInstance(prevE)) {
      prevE.attachListener(outE);
    }
    <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">Object</span>.Throw(<span class="hljs-string">"bindE : expected EventStream"</span>);
    }

    <span class="hljs-keyword">return</span> doNotPropagate;
  });
  inE.name = <span class="hljs-string">"bind inE"</span>;

  <span class="hljs-keyword">return</span> outE;
};

EventStream.prototype.mapE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">f</span>) </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Function</span>.hasInstance(f)) {
    <span class="hljs-built_in">Object</span>.Throw (<span class="hljs-string">'mapE : expected a function as the first argument; received '</span> + f);
  }

  <span class="hljs-keyword">return</span> createNode([<span class="hljs-keyword">this</span>],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pulse</span>) </span>{
    pulse.value = f(pulse.value);
    <span class="hljs-keyword">return</span> pulse;
  });
};


EventStream.prototype.notE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.mapE(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>) </span>{ <span class="hljs-keyword">return</span> !v; }); };


<span class="hljs-keyword">var</span> notE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{ <span class="hljs-keyword">return</span> e.notE(); };


EventStream.prototype.filterE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pred</span>) </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Function</span>.hasInstance(pred)) {
    <span class="hljs-built_in">Object</span>.Throw (<span class="hljs-string">'filterE : expected predicate; received '</span> + pred);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Can be a bindE</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> createNode([<span class="hljs-keyword">this</span>], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pulse</span>) </span>{
    <span class="hljs-keyword">return</span> pred(pulse.value) ? pulse : doNotPropagate;
  });
};


<span class="hljs-keyword">var</span> filterE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e,p</span>) </span>{ <span class="hljs-keyword">return</span> e.filterE(p); };</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Fires just once.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>EventStream.prototype.onceE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> done = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Alternately: this.collectE(0,\n v -&gt; (n+1,v)).filterE((n,v) -&gt; n == 1).mapE(fst)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> createNode([<span class="hljs-keyword">this</span>],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pulse</span>) </span>{
    <span class="hljs-keyword">if</span> (!done) { done = <span class="hljs-literal">true</span>; <span class="hljs-keyword">return</span> pulse; }
    <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> doNotPropagate; }
  });
};


<span class="hljs-keyword">var</span> onceE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{ <span class="hljs-keyword">return</span> e.onceE(); };


EventStream.prototype.skipFirstE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> skipped = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">return</span> createNode([<span class="hljs-keyword">this</span>],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pulse</span>) </span>{
    <span class="hljs-keyword">if</span> (skipped)
      { <span class="hljs-keyword">return</span> pulse; }
    <span class="hljs-keyword">else</span>
      { <span class="hljs-keyword">return</span> doNotPropagate; }
  });
};


<span class="hljs-keyword">var</span> skipFirstE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{ <span class="hljs-keyword">return</span> e.skipFirstE(); };


EventStream.prototype.collectE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">init,fold</span>) </span>{
  <span class="hljs-keyword">var</span> acc = init;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.mapE(
    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">n</span>) </span>{
      <span class="hljs-keyword">var</span> next = fold(n, acc);
      acc = next;
      <span class="hljs-keyword">return</span> next;
    });
};


<span class="hljs-keyword">var</span> collectE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e,i,f</span>) </span>{ <span class="hljs-keyword">return</span> e.collectE(i,f); };</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>a.k.a. join</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>EventStream.prototype.switchE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.bindE(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>) </span>{ <span class="hljs-keyword">return</span> v; });
};


<span class="hljs-keyword">var</span> recE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fn</span>) </span>{
  <span class="hljs-keyword">var</span> inE = receiverE();
  <span class="hljs-keyword">var</span> outE = fn(inE);
  outE.mapE(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x</span>) </span>{
    inE.sendEvent(x); });
  <span class="hljs-keyword">return</span> outE;
};


<span class="hljs-keyword">var</span> switchE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{ <span class="hljs-keyword">return</span> e.switchE(); };


EventStream.prototype.ifE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">thenE,elseE</span>) </span>{
  <span class="hljs-keyword">var</span> testStamp = <span class="hljs-number">-1</span>;
  <span class="hljs-keyword">var</span> testValue = <span class="hljs-literal">false</span>;

  createNode([<span class="hljs-keyword">this</span>],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pulse</span>) </span>{ testStamp = pulse.stamp; testValue = pulse.value; <span class="hljs-keyword">return</span> doNotPropagate; });</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>XXX broken? CSA tried to fix..</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> mergeE(createNode([thenE],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pulse</span>) </span>{ <span class="hljs-keyword">return</span> (testValue &amp;&amp; (testStamp === pulse.stamp)) ? pulse : doNotPropagate; }),
                createNode([elseE],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pulse</span>) </span>{ <span class="hljs-keyword">return</span> (!testValue &amp;&amp; (testStamp === pulse.stamp)) ? pulse : doNotPropagate; }));
};


<span class="hljs-keyword">var</span> ifE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">test,thenE,elseE</span>) </span>{
  <span class="hljs-keyword">if</span> (EventStream.hasInstance(test))
    { <span class="hljs-keyword">return</span> test.ifE(thenE,elseE); }
  <span class="hljs-keyword">else</span>
    { <span class="hljs-keyword">return</span> test ? thenE : elseE; }
};


<span class="hljs-keyword">var</span> andE = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-regexp">/* . nodes */</span></span>) </span>{
  <span class="hljs-keyword">var</span> nodes = slice(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">0</span>);

  <span class="hljs-keyword">var</span> acc = (nodes.length &gt; <span class="hljs-number">0</span>)?
  nodes[nodes.length - <span class="hljs-number">1</span>] : oneE(<span class="hljs-literal">true</span>);

  <span class="hljs-keyword">var</span> i = nodes.length - <span class="hljs-number">2</span>;
  <span class="hljs-keyword">while</span> (i &gt;= <span class="hljs-number">0</span>) {
    acc = ifE(
      nodes[i],
      acc,
      nodes[i].constantE(<span class="hljs-literal">false</span>));
    i -= <span class="hljs-number">1</span>;
  }
  <span class="hljs-keyword">return</span> acc;
};


EventStream.prototype.andE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> <span class="hljs-regexp">/* others */</span> </span>) </span>{
  <span class="hljs-keyword">var</span> deps = [<span class="hljs-keyword">this</span>].concat(slice(<span class="hljs-built_in">arguments</span>,<span class="hljs-number">0</span>));
  <span class="hljs-keyword">return</span> andE.apply(<span class="hljs-keyword">this</span>,deps);
};


<span class="hljs-keyword">var</span> orE = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> nodes = slice(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">var</span> acc = (nodes.length &gt; <span class="hljs-number">2</span>)?
  nodes[nodes.length - <span class="hljs-number">1</span>] : oneE(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">var</span> i = nodes.length - <span class="hljs-number">2</span>;
  <span class="hljs-keyword">while</span> (i &gt;= <span class="hljs-number">0</span>) {
    acc = ifE(
      nodes[i],
      nodes[i],
      acc);
    i -= <span class="hljs-number">1</span>;
  }
  <span class="hljs-keyword">return</span> acc;
};


EventStream.prototype.orE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-regexp">/*others*/</span></span>) </span>{
  <span class="hljs-keyword">var</span> deps = [<span class="hljs-keyword">this</span>].concat(slice(<span class="hljs-built_in">arguments</span>,<span class="hljs-number">0</span>));
  <span class="hljs-keyword">return</span> orE.apply(<span class="hljs-keyword">this</span>,deps);
};


<span class="hljs-keyword">var</span> delayStaticE = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event, time</span>) </span>{

  <span class="hljs-keyword">var</span> resE = internalE();

  createNode([event], <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">p</span>) </span>{
    setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ sendEvent(resE, p.value);},  time );
    <span class="hljs-keyword">return</span> doNotPropagate;
  });

  <span class="hljs-keyword">return</span> resE;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>delayE: Event a * [Behavior] Number -&gt;  Event a</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>EventStream.prototype.delayE = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">time</span>) </span>{
  <span class="hljs-keyword">var</span> event = <span class="hljs-keyword">this</span>;

  <span class="hljs-keyword">if</span> (Behavior.hasInstance(time)) {

    <span class="hljs-keyword">var</span> receiverEE = internalE();
    <span class="hljs-keyword">var</span> link =
    {
      <span class="hljs-attr">from</span>: event,
      <span class="hljs-attr">towards</span>: delayStaticE(event, valueNow(time))
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>TODO: Change semantics such that we are always guaranteed to get an event going out?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> switcherE =
    createNode(
      [changes(time)],
      <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">p</span>) </span>{
        link.from.removeListener(link.towards);
        link =
        {
          <span class="hljs-attr">from</span>: event,
          <span class="hljs-attr">towards</span>: delayStaticE(event, p.value)
        };
        sendEvent(receiverEE, link.towards);
        <span class="hljs-keyword">return</span> doNotPropagate;
      });

    <span class="hljs-keyword">var</span> resE = receiverEE.switchE();

    sendEvent(switcherE, valueNow(time));
    <span class="hljs-keyword">return</span> resE;

      } <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> delayStaticE(event, time); }
};


<span class="hljs-keyword">var</span> delayE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">sourceE,interval</span>) </span>{
  <span class="hljs-keyword">return</span> sourceE.delayE(interval);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>mapE: ([Event] (. Array a -&gt; b)) . Array [Event] a -&gt; [Event] b</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> mapE = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">fn <span class="hljs-regexp">/*, [node0 | val0], ...*/</span></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <pre><code> if (!Function.hasInstance(fn)) { Object.Throw (&#39;mapE: expected fn as second arg&#39;); } //SAFETY</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> valsOrNodes = slice(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">0</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>selectors<a href="">i</a> returns either the node or real val, optimize real vals</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> selectors = [];
  <span class="hljs-keyword">var</span> selectI = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> nodes = [];
  valsOrNodes.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">vn</span>) </span>{
    <span class="hljs-keyword">if</span> (EventStream.hasInstance(vn)) {
      nodes.push(vn);
      selectors.push(
        (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ii</span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">realArgs</span>) </span>{
              <span class="hljs-keyword">return</span> realArgs[ii];
            };
        })(selectI));
      selectI+=<span class="hljs-number">1</span>;
    } <span class="hljs-keyword">else</span> {
      selectors.push(
        (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">aa</span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">return</span> aa;
            };
        })(vn));
    }
  });

  <span class="hljs-keyword">var</span> context = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> nofnodes = slice(selectors,<span class="hljs-number">1</span>);

  <span class="hljs-keyword">if</span> (nodes.length === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> oneE(fn.apply(context, valsOrNodes));
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((nodes.length === <span class="hljs-number">1</span>) &amp;&amp; <span class="hljs-built_in">Function</span>.hasInstance(fn)) {
    <span class="hljs-keyword">return</span> nodes[<span class="hljs-number">0</span>].mapE(
      <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">arguments</span>;
        <span class="hljs-keyword">return</span> fn.apply(
          context,
          map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">s</span>) </span>{<span class="hljs-keyword">return</span> s(args);}, nofnodes));
      });
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nodes.length === <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> fn.mapE(
      <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">v</span>) </span>{
        <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">arguments</span>;
        <span class="hljs-keyword">return</span> v.apply(
          context,
          map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">s</span>) </span>{<span class="hljs-keyword">return</span> s(args);}, nofnodes));
      });
  <span class="hljs-comment">/* XXX CSA BROKEN: createTimeSyncNode no longer defined...
  } else if (Function.hasInstance(fn)) {
    return createTimeSyncNode(nodes).mapE(
      function (arr) {
        return fn.apply(
          this,
          map(function (s) { return s(arr); }, nofnodes));
      });
  } else if (EventStream.hasInstance(fn)) {
    return createTimeSyncNode(nodes).mapE(
      function (arr) {
        return arr[0].apply(
          this,
          map(function (s) {return s(arr); }, nofnodes));
      });
  XXX end broken bit */</span>
  } <span class="hljs-keyword">else</span> { <span class="hljs-built_in">Object</span>.Throw(<span class="hljs-string">'unknown mapE case'</span>); }
};


EventStream.prototype.snapshotE = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">valueB</span>) </span>{
  <span class="hljs-keyword">return</span> createNode([<span class="hljs-keyword">this</span>], <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">pulse</span>) </span>{
    pulse.value = valueNow(valueB);
    <span class="hljs-keyword">return</span> pulse;
  });
};


<span class="hljs-keyword">var</span> snapshotE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">triggerE,valueB</span>) </span>{
  <span class="hljs-keyword">return</span> triggerE.snapshotE(valueB);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>XXX CSA this is more specific notion of equality than original</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> _default_eq_ = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x,y</span>) </span>{ <span class="hljs-keyword">return</span> x===y; };
<span class="hljs-keyword">var</span> _default_cp_ = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x</span>) </span>{ <span class="hljs-keyword">return</span> x; };
EventStream.prototype.filterRepeatsE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">optStart, optEq, optClone</span>) </span>{
  <span class="hljs-keyword">var</span> hadFirst = (optStart === <span class="hljs-literal">undefined</span>) ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">var</span> prev = optStart;
  <span class="hljs-keyword">var</span> eq = optEq ? optEq : _default_eq_;
  <span class="hljs-keyword">var</span> cp = optClone ? optClone : _default_cp_;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.filterE(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">v</span>) </span>{
    <span class="hljs-keyword">if</span> (!hadFirst || !eq(prev, v)) {
      hadFirst = <span class="hljs-literal">true</span>;
      prev = cp(v);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  });
};


<span class="hljs-keyword">var</span> filterRepeatsE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">sourceE,optStart</span>) </span>{
  <span class="hljs-keyword">return</span> sourceE.filterRepeatsE(optStart);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>credit Pete Hopkins
extensively hacked by CSA</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> calmE = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">triggerE, timeB</span>) </span>{
  <span class="hljs-keyword">if</span> (!Behavior.hasInstance(timeB)) {
      timeB = constantB(timeB);
  }
  <span class="hljs-keyword">var</span> out = internalE();</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> lastTime = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> towards = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> lastVal, sawMoreRecent;
  <span class="hljs-keyword">var</span> towardsFunc = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    towards = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (sawMoreRecent) {
      sendEvent(out, lastVal);
    }
  };
  <span class="hljs-keyword">var</span> timeChangedE = timeB.changes().mapE(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> sawMoreRecent ? lastVal : doNotPropagate;
  });

  <span class="hljs-keyword">return</span> createNode(
    [triggerE, out, timeChangedE],
    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">p</span>) </span>{
        <span class="hljs-keyword">var</span> curTime = now();
        <span class="hljs-keyword">var</span> left = (curTime - lastTime) - timeB.valueNow();
        <span class="hljs-keyword">if</span> (towards) { clearTimeout(towards); }
        <span class="hljs-keyword">if</span> (left &gt;= <span class="hljs-number">0</span>) {
          lastTime = curTime;
          sawMoreRecent = <span class="hljs-literal">false</span>;
          lastVal = <span class="hljs-literal">null</span>; <span class="hljs-comment">// free memory</span>
          towards = setTimeout( towardsFunc, timeB.valueNow() );</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>propagate directly.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">return</span> p;
        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>hmm, don&#39;t propagate this yet, but maybe do it later.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          sawMoreRecent = <span class="hljs-literal">true</span>;
          lastVal = p;
          towards = setTimeout( towardsFunc, left );
          <span class="hljs-keyword">return</span> doNotPropagate;
        }
    });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>calmE: Event a * [Behavior] Number -&gt; Event a</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>EventStream.prototype.calmE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">timeB</span>) </span>{
    <span class="hljs-keyword">return</span> calmE(<span class="hljs-keyword">this</span>, timeB);
};


EventStream.prototype.blindE = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">time</span>) </span>{
  <span class="hljs-keyword">return</span> createNode(
    [<span class="hljs-keyword">this</span>],
    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> intervalFn =
      Behavior.hasInstance(time)?
      <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> valueNow(time); }
      : <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> time; };
      <span class="hljs-keyword">var</span> lastSent = now() - intervalFn() - <span class="hljs-number">1</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">p</span>) </span>{
        <span class="hljs-keyword">var</span> curTime = now();
        <span class="hljs-keyword">if</span> (curTime - lastSent &gt; intervalFn()) {
          lastSent = curTime;
          <span class="hljs-keyword">return</span> p;
        }
        <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> doNotPropagate; }
      };
    }());
};


<span class="hljs-keyword">var</span> blindE = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">sourceE,interval</span>) </span>{
  <span class="hljs-keyword">return</span> sourceE.blindE(interval);
};


EventStream.prototype.startsWith = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">init</span>) </span>{
  <span class="hljs-keyword">return</span> Behavior.New(<span class="hljs-keyword">this</span>,init);
};


<span class="hljs-keyword">var</span> startsWith = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e,init</span>) </span>{
  <span class="hljs-keyword">if</span> (!EventStream.hasInstance(e)) {
    <span class="hljs-built_in">Object</span>.Throw(<span class="hljs-string">'startsWith: expected EventStream; received '</span> + e);
  }
  <span class="hljs-keyword">return</span> e.startsWith(init);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>TODO optionally append to objects
createConstantB: a -&gt; Behavior a</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>constantB = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">val</span>) </span>{
  <span class="hljs-keyword">return</span> Behavior.New(internalE(), val);
};


<span class="hljs-keyword">var</span> liftB = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">fn <span class="hljs-regexp">/* . behaves */</span></span>) </span>{

  <span class="hljs-keyword">var</span> args = slice(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>dependencies</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> constituentsE =
    map(changes,
    filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">v</span>) </span>{ <span class="hljs-keyword">return</span> Behavior.hasInstance(v); },
           slice(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">0</span>)));</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>calculate new vals</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> getCur = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">v</span>) </span>{
    <span class="hljs-keyword">return</span> Behavior.hasInstance(v) ? v.last : v;
  };

  <span class="hljs-keyword">var</span> ctx = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> getRes = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> getCur(fn).apply(ctx, map(getCur, args));
  };

  <span class="hljs-keyword">if</span>(constituentsE.length === <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> Behavior.New(constituentsE[<span class="hljs-number">0</span>],getRes(),getRes);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>gen/send vals @ appropriate time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> prevStamp = <span class="hljs-number">-1</span>;
  <span class="hljs-keyword">var</span> mid = createNode(constituentsE, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">p</span>) </span>{
    <span class="hljs-keyword">if</span> (p.stamp !== prevStamp) {
      prevStamp = p.stamp;
      <span class="hljs-keyword">return</span> p;
    }
    <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> doNotPropagate;
    }
  });

  <span class="hljs-keyword">return</span> Behavior.New(mid,getRes(),getRes);
};


Behavior.prototype.liftB = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-regexp">/* args */</span></span>) </span>{
  <span class="hljs-keyword">var</span> args= slice(<span class="hljs-built_in">arguments</span>,<span class="hljs-number">0</span>).concat([<span class="hljs-keyword">this</span>]);
  <span class="hljs-keyword">return</span> liftB.apply(<span class="hljs-keyword">this</span>,args);
};


Behavior.prototype.switchB = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> behaviourCreatorsB = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> init = valueNow(behaviourCreatorsB);

  <span class="hljs-keyword">var</span> prevSourceE = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">var</span> receiverE = internalE.New();</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>XXX could result in out-of-order propagation! Fix!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> makerE =
  createNode(
    [changes(behaviourCreatorsB)],
    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">p</span>) </span>{
        <span class="hljs-keyword">if</span> (!Behavior.hasInstance(p.value)) { <span class="hljs-built_in">Object</span>.Throw (<span class="hljs-string">'switchB: expected Behavior as value of Behavior of first argument'</span>); } <span class="hljs-comment">//SAFETY</span>
      <span class="hljs-keyword">if</span> (prevSourceE !== <span class="hljs-literal">null</span>) {
        prevSourceE.removeListener(receiverE);
      }

      prevSourceE = changes(p.value);
      prevSourceE.attachListener(receiverE);

      sendEvent(receiverE, valueNow(p.value));
      <span class="hljs-keyword">return</span> doNotPropagate;
    });

  <span class="hljs-keyword">if</span> (Behavior.hasInstance(init)) {
    sendEvent(makerE, init);
  }

  <span class="hljs-keyword">return</span> startsWith(
    receiverE,
    Behavior.hasInstance(init)? valueNow(init) : init);
};


<span class="hljs-keyword">var</span> switchB = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">b</span>) </span>{ <span class="hljs-keyword">return</span> b.switchB(); };


<span class="hljs-comment">/* XXX CSA omitted
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>TODO test, signature</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>var timerB = function(interval) {
  return startsWith(timerE(interval), now());
};
*/</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>TODO test, signature</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> delayStaticB = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">triggerB, time, init</span>) </span>{
  <span class="hljs-keyword">return</span> startsWith(delayStaticE(changes(triggerB), time), init);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>TODO test, signature</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Behavior.prototype.delayB = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">time, init</span>) </span>{
  <span class="hljs-keyword">var</span> triggerB = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">if</span> (Behavior.hasInstance(time)) {
    <span class="hljs-keyword">return</span> startsWith(
      delayE(
        changes(triggerB),
        time),
      <span class="hljs-built_in">arguments</span>.length &gt; <span class="hljs-number">3</span> ? init : valueNow(triggerB));
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> delayStaticB(
      triggerB,
      time,
      <span class="hljs-built_in">arguments</span>.length &gt; <span class="hljs-number">3</span> ? init : valueNow(triggerB));
  }
};


<span class="hljs-keyword">var</span> delayB = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">srcB, timeB, init</span>) </span>{
  <span class="hljs-keyword">return</span> srcB.delayB(timeB,init);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>artificially send a pulse to underlying event node of a behaviour
note: in use, might want to use a receiver node as a proxy or an identity map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Behavior.prototype.sendBehavior = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">val</span>) </span>{
  sendEvent(<span class="hljs-keyword">this</span>.underlyingRaw,val);
};

<span class="hljs-keyword">var</span> sendBehavior = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">b,v</span>) </span>{ b.sendBehavior(v); };



Behavior.prototype.ifB = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">trueB,falseB</span>) </span>{
  <span class="hljs-keyword">var</span> testB = <span class="hljs-keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>TODO auto conversion for behaviour funcs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!Behavior.hasInstance(trueB)) { trueB = constantB(trueB); }
  <span class="hljs-keyword">if</span> (!Behavior.hasInstance(falseB)) { falseB = constantB(falseB); }
  <span class="hljs-keyword">return</span> liftB(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">te,t,f</span>) </span>{ <span class="hljs-keyword">return</span> te ? t : f; },testB,trueB,falseB);
};


<span class="hljs-keyword">var</span> ifB = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">test,cons,altr</span>) </span>{
  <span class="hljs-keyword">if</span> (!Behavior.hasInstance(test)) { test = constantB(test); }

  <span class="hljs-keyword">return</span> test.ifB(cons,altr);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>condB: . [Behavior boolean, Behavior a] -&gt; Behavior a</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> condB = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-regexp">/* . pairs */</span> </span>) </span>{
  <span class="hljs-keyword">var</span> pairs = slice(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">0</span>);
<span class="hljs-keyword">return</span> liftB.apply({},[<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">while</span> (i&lt;pairs.length) {
      <span class="hljs-keyword">if</span>(<span class="hljs-built_in">arguments</span>[i]) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">arguments</span>[pairs.length+i];
      }
      i+=<span class="hljs-number">1</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
  }].concat(map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pair</span>) </span>{<span class="hljs-keyword">return</span> pair[<span class="hljs-number">0</span>];},pairs).concat(map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pair</span>) </span>{<span class="hljs-keyword">return</span> pair[<span class="hljs-number">1</span>];},pairs))));
};


<span class="hljs-keyword">var</span> andB = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-regexp">/* . behaves */</span></span>) </span>{
<span class="hljs-keyword">return</span> liftB.apply({},[<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">while</span> (i&lt;<span class="hljs-built_in">arguments</span>.length) {
        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">arguments</span>[i]) { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }
        i+=<span class="hljs-number">1</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}].concat(slice(<span class="hljs-built_in">arguments</span>,<span class="hljs-number">0</span>)));
};


Behavior.prototype.andB = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> andB([<span class="hljs-keyword">this</span>].concat(<span class="hljs-built_in">arguments</span>));
};


<span class="hljs-keyword">var</span> orB = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-regexp">/* . behaves */</span> </span>) </span>{
<span class="hljs-keyword">return</span> liftB.apply({},[<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">while</span> (i&lt;<span class="hljs-built_in">arguments</span>.length) {
        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">arguments</span>[i]) { <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; }
        i+=<span class="hljs-number">1</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}].concat(slice(<span class="hljs-built_in">arguments</span>,<span class="hljs-number">0</span>)));
};


Behavior.prototype.orB = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> orB([<span class="hljs-keyword">this</span>].concat(<span class="hljs-built_in">arguments</span>));
};


Behavior.prototype.notB = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.liftB(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>) </span>{ <span class="hljs-keyword">return</span> !v; });
};


<span class="hljs-keyword">var</span> notB = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">b</span>) </span>{ <span class="hljs-keyword">return</span> b.notB(); };


Behavior.prototype.blindB = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">intervalB</span>) </span>{
  <span class="hljs-keyword">return</span> changes(<span class="hljs-keyword">this</span>).blindE(intervalB).startsWith(<span class="hljs-keyword">this</span>.valueNow());
};


<span class="hljs-keyword">var</span> blindB = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">srcB,intervalB</span>) </span>{
  <span class="hljs-keyword">return</span> srcB.blindB(intervalB);
};


Behavior.prototype.calmB = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">intervalB</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.changes().calmE(intervalB).startsWith(<span class="hljs-keyword">this</span>.valueNow());
};


<span class="hljs-keyword">var</span> calmB = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">srcB,intervalB</span>) </span>{
  <span class="hljs-keyword">return</span> srcB.calmB(intervalB);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>/// Module export stuff.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">__module_name__</span>: <span class="hljs-string">"events"</span>,
        <span class="hljs-attr">__module_init__</span>: make_flapjax,
        <span class="hljs-attr">__module_deps__</span>: [<span class="hljs-string">"timeouts"</span>],
        <span class="hljs-attr">__module_source__</span>: events_source,

        <span class="hljs-attr">constantB</span>: constantB,
        <span class="hljs-attr">delayB</span>: delayB,
        <span class="hljs-attr">calmB</span>: calmB,
        <span class="hljs-attr">blindB</span>: blindB,
        <span class="hljs-attr">valueNow</span>: valueNow,
        <span class="hljs-attr">switchB</span>: switchB,
        <span class="hljs-attr">andB</span>: andB,
        <span class="hljs-attr">orB</span>: orB,
        <span class="hljs-attr">notB</span>: notB,
        <span class="hljs-attr">liftB</span>: liftB,
        <span class="hljs-attr">condB</span>: condB,
        <span class="hljs-attr">ifB</span>: ifB,
        <span class="hljs-comment">/*
        timerB: timerB,
        disableTimer: disableTimer,
        insertDomB: insertDomB,
        insertDom: insertDom,
        mouseTopB: mouseTopB,
        mouseLeftB: mouseLeftB,
        mouseB: mouseB,
        extractValueB: extractValueB,
        this.$B = impl.$B;
        extractValueE: extractValueE,
        extractEventE: extractEventE,
        this.$E = impl.$E;
        clicksE: clicksE,
        timerE: timerE,
        extractValueOnEventE: extractValueOnEventE,
        extractIdB: extractIdB,
        insertDomE: insertDomE,
        insertValueE: insertValueE,
        insertValueB: insertValueB,
        tagRec: tagRec,
        getWebServiceObjectE: getWebServiceObjectE,
        getForeignWebServiceObjectE: getForeignWebServiceObjectE,
        evalForeignScriptValE: evalForeignScriptValE,
        */</span>
        <span class="hljs-attr">oneE</span>: oneE,
        <span class="hljs-attr">zeroE</span>: zeroE,
        <span class="hljs-attr">mapE</span>: mapE,
        <span class="hljs-attr">mergeE</span>: mergeE,
        <span class="hljs-attr">switchE</span>: switchE,
        <span class="hljs-attr">filterE</span>: filterE,
        <span class="hljs-attr">ifE</span>: ifE,
        <span class="hljs-attr">recE</span>: recE,
        <span class="hljs-attr">constantE</span>: constantE,
        <span class="hljs-attr">collectE</span>: collectE,
        <span class="hljs-attr">andE</span>: andE,
        <span class="hljs-attr">orE</span>: orE,
        <span class="hljs-attr">notE</span>: notE,
        <span class="hljs-attr">filterRepeatsE</span>: filterRepeatsE,
        <span class="hljs-attr">receiverE</span>: receiverE,
        <span class="hljs-attr">sendEvent</span>: sendEvent,
        <span class="hljs-attr">snapshotE</span>: snapshotE,
        <span class="hljs-attr">onceE</span>: onceE,
        <span class="hljs-attr">skipFirstE</span>: skipFirstE,
        <span class="hljs-attr">delayE</span>: delayE,
        <span class="hljs-attr">blindE</span>: blindE,
        <span class="hljs-attr">calmE</span>: calmE,
        <span class="hljs-attr">startsWith</span>: startsWith,
        <span class="hljs-comment">/*
        changes: changes,
        getElementsByClass: getElementsByClass,
        getObj: getObj,
        this.$ = impl.$;
        readCookie: readCookie,
        swapDom: swapDom,
        getURLParam: getURLParam,
        cumulativeOffset: cumulativeOffset,
        fold: fold,
        foldR: foldR,
        */</span>
        <span class="hljs-attr">map</span>: map,
        <span class="hljs-comment">/*
        filter: filter,
        member: member,
        slice: slice,
        forEach: forEach,
        toJSONString: toJSONString,
        compilerInsertDomB: compilerInsertDomB,
        compilerInsertValueB: compilerInsertValueB,
        compilerLift: compilerLift,
        compilerCall: compilerCall,
        compilerIf: compilerIf,
        compilerUnbehavior: compilerUnbehavior,
        compilerEventStreamArg: compilerEventStreamArg,
        */</span>
        <span class="hljs-attr">Behavior</span>: Behavior,
        <span class="hljs-attr">EventStream</span>: EventStream,
        <span class="hljs-comment">/* For use by test suite only... */</span>
        <span class="hljs-attr">base</span>: {
            <span class="hljs-attr">Pulse</span>: Pulse,
            <span class="hljs-attr">propagatePulse</span>: propagatePulse
        },
        <span class="hljs-attr">engine</span>: {
            <span class="hljs-attr">createNode</span>: createNode,
            <span class="hljs-attr">doNotPropagate</span>: doNotPropagate
        }
    };
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
