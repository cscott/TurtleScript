<!DOCTYPE html>
<html>
<head>
<title>Canvas events test</title>
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<link rel="shortcut icon" href="images/turtle_icon-16x16.ico" />
<link rel="apple-touch-icon" href="images/turtle_icon-128x128.png" />
<link rel="apple-touch-startup-image" href="images/turtle_splash-320x460.png" />
<!-- XXX apparently alternate size startup images don't work yet on  iOS XXX
     XXX only solution is to use document.write() to add an appropriate
     XXX link element on the fly, boo.  And even that doesn't work for the
     XXX retina display resolution. -->
<!--
<link rel="apple-touch-startup-image"
      sizes="640x920" href="images/turtle_splash-640x920.png" />
<link rel="apple-touch-startup-image"
      sizes="1024x748" href="images/turtle_splash-1024x748.png" />
<link rel="apple-touch-startup-image"
      sizes="768x1004" href="images/turtle_splash-768x1004.png" />
-->
<style type="text/css">
html, body, canvas { padding: 0; margin: 0; }
#canvas {
  position: absolute;
  width: 100%; height: 100%;
  -webkit-user-select: none;
}
</style>
<script type="text/javascript" src="bravojs/bravo.js"></script>
<script type="text/javascript" src="global.js"></script>
<script type="text/javascript" src="extensions.js"></script>
<!--
<script type="text/javascript" src="ccanvas.js"></script>
<script type="text/javascript" src="events.js"></script>
-->
<script type="text/javascript">
// define setTimeout/clearTimeout for events.js
bravojs.provideModule([], function(require, exports, module) {
exports.setTimeout = window.setTimeout;
exports.clearTimeout = window.clearTimeout;
}, require.id('timeouts'));

module.declare(['browsercanvas'],
function(require, exports, module) {

var browsercanvas = require('browsercanvas');

/*
if (window.navigator.userAgent.indexOf('iPhone') != -1) {
  if (!window.navigator.standalone == true) {
    // XXX display message prompting to add this app to the home screen
  }
}
*/

var drawFrame = function(canvas, touchB, tickB) {
  var lastTouches = touchB.valueNow();
  var sz = canvas.size();

  canvas.resize(window.innerWidth, window.innerHeight,
                window.devicePixelRatio || 1);
  canvas.clearRect(0,0,sz.width, sz.height);

  canvas.setFontHeight(20);
  // XXX window.orientation is not reliable; the resize callback seems to occur
  //     before window.orientation changes.  Just looking at the width/height
  //     is probably better.
  var orientation = (canvas.size().width > canvas.size().height) ?
      "landscape" : "portrait";
  var str = "Width: "+canvas.size().width+", "+
            "Height: "+canvas.size().height+", "+
            "O: "+orientation;
  // work around iOS bug which clips text unless something *else*
  // ensures that the invalidation rectangle is big enough.
  var m = canvas.measureText(str);
  canvas.setFill(canvas.makeColor(255,255,255));
  canvas.beginPath();
  canvas.rect(0.5, 0.5, 0.5+m.width, 0.5+m.height);
  canvas.fill();

  canvas.setFill(canvas.makeColor(0,0,0));
  canvas.drawText(str, 0.5, 0.5+2*m.height);
  canvas.drawText("Touches: "+lastTouches.length, 0.5, 0.5+3*m.height);

  var amt = (tickB.valueNow() % sz.width) / sz.width; // 0-1
  canvas.setFill(canvas.makeColor(Math.floor(amt*255),0,0));
  canvas.beginPath();
  canvas.rect(amt*sz.width, 0, 10, 50);
  canvas.fill();

  // draw a mark at every point
  canvas.beginPath();
  var size=50;
  var i = 0;
  while (i < lastTouches.length) {
    /*
    canvas.setFill(canvas.makeColor(Math.floor(amt*255),
                                    Math.floor(lastTouches[i].force*255),
                                    0));
    */
    canvas.rect(lastTouches[i].clientX-size,
                lastTouches[i].clientY-size,
                size*2, size*2);
    i+=1;
  }
  canvas.fill();
};

browsercanvas.initEventLoop('canvas', drawFrame);

});
</script>
</head>
<body><canvas id="canvas"></canvas></body>
</html>
